<!DOCTYPE html>
<html><html><head><style type="text/css">body{margin:12px 0 0 560px;padding:60px 48px}button{background-color:transparent;border:none;cursor:pointer;padding:0;user-select:none}button:hover{opacity:.5}div{box-sizing:border-box}pre{display:block;margin:0;letter-spacing:.8px}.scroll-x{overflow-x:auto}.scroll-y{flex-grow:1;overflow-y:auto}a,a:active,a:hover,a:visited{display:block;text-decoration:none}a.inline-link{display:inline-block}a.inline-link:hover{text-decoration:underline}.button{padding:3px 12px;white-space:inherit;letter-spacing:.5px}.button:hover{background-color:#f0f0f0}.button--active{background-color:#f3f3f3}.button--active:hover{background-color:#f0f0f0}.text--xs{font-size:10px;line-height:18px}.text--s{font-size:12px;line-height:18px}.text--m{font-size:13px;line-height:18px}.text--l{font-size:14px;line-height:18px}.text--xl{font-size:18px;line-height:24px}.text--semi-bold{font-weight:500}.text--bold{font-weight:600}.text--uppercase{text-transform:uppercase}.text--boxed{background-color:#fafafa;padding:12px 8px}.text--hidden{display:none}.text--wrap{-white-space:normal;white-space:pre-wrap}.image--boxed{background-color:#fafafa;padding:12px 8px}.color--black{color:#000000}.color--hard-grey{color:#404040}.color--soft-grey{color:#808080}.color--hard-blue{color:#0088cc}.color--soft-blue{color:#55aabb}.color--hard-purple{color:#8800cc}.color--soft-purple{color:#aa55bb}.color--hard-red{color:#cc00aa}[data-collapsed="true"] .snippet--text{display:none}[data-collapsible="true"] .snippet--header::after{align-items:center;content:'▼';display:flex;font-size:8px;justify-content:center;height:18px;width:18px}[data-collapsible="true"][data-collapsed="false"] .snippet--header::after{content:'▲'}#top-bar{background-color:#ffffff;border-bottom:1px solid #e0e0e0;display:flex;gap:6px;height:60px;left:0;padding-left:18px;position:fixed;top:0;width:100%}#top-bar--library-uri{padding:21px 18px;position:absolute;right:0;top:0}#top-bar--library-uri:hover{background-color:#f0f0f0}#top-bar--library-name{padding:18px 0;text-transform:uppercase}#top-bar--library-version{margin-top:12px}#bottom-bar{background-color:white;border-top:1px solid #e0e0e0;bottom:0;display:flex;justify-content:right;left:0;position:fixed;width:100%}#bottom-bar--credits-link{padding:12px 18px}#bottom-bar--credits-link:hover{background-color:#f0f0f0}#primary-list{background-color:#fff;border-right:1px solid #e0e0e0;display:flex;flex-direction:column;height:calc(100vh - 60px);left:0;padding:12px 0 54px 0;position:fixed;top:60px;width:280px}#secondary-list{background-color:#fff;border-right:1px solid #e0e0e0;display:flex;flex-direction:column;height:calc(100vh - 60px);left:280px;padding:12px 0 54px 0;position:fixed;top:60px;width:280px}#primary-list,#secondary-list{z-index:9999}#primary-list .text--xs,#secondary-list .text--xs{padding-left:12px}.primary-list--container,.secondary-list--container{margin-bottom:12px}.section{padding:72px 0}.section--header{border-bottom:1px solid #e0e0e0;padding-bottom:8px;margin-bottom:12px}.snippets{display:flex;flex-direction:column;gap:24px}.snippet--header{display:flex;gap:4px}.snippet--preview-image{border:1px solid #dedede;display:block;max-height:480px;max-width:640px;min-height:48px;min-width:64px}</style><script type="text/javascript">function toggleCollapsible(collapsibleId){collapsible=document.getElementById(collapsibleId);if(collapsible.dataset.collapsed==='true'){collapsible.dataset.collapsed='false';}else{collapsible.dataset.collapsed='true';}}</script></head><body><div id="primary-list"><div class="scroll-y"><div class="primary-list--container"><pre class="color--soft-grey text--xs text--uppercase">Clojure namespaces</pre><a href="https://mt-app-kit.github.io/clj-security-protocols/clj/database-security-protocols/api.html"><pre class="button color--hard-blue text--m ">database-security-protocols.api</pre></a><a href="https://mt-app-kit.github.io/clj-security-protocols/clj/media-security-protocols/api.html"><pre class="button color--hard-blue text--m ">media-security-protocols.api</pre></a><a href="https://mt-app-kit.github.io/clj-security-protocols/clj/user-security-protocols/api.html"><pre class="button color--hard-blue text--m button--active">user-security-protocols.api</pre></a></div></div></div><div id="secondary-list"><div class="scroll-y"><div class="secondary-list--container"><pre class="color--soft-grey text--xs text--uppercase">Declarations</pre><a href="#check-user-identifier"><pre class="button color--hard-blue text--m">check-user-identifier</pre></a><a href="#create-user-account"><pre class="button color--hard-blue text--m">create-user-account</pre></a><a href="#drop-user-session"><pre class="button color--hard-blue text--m">drop-user-session</pre></a><a href="#recover-user-password"><pre class="button color--hard-blue text--m">recover-user-password</pre></a><a href="#remove-user-account"><pre class="button color--hard-blue text--m">remove-user-account</pre></a><a href="#send-security-code-authenticated"><pre class="button color--hard-blue text--m">send-security-code-authenticated</pre></a><a href="#send-security-code-unauthenticated"><pre class="button color--hard-blue text--m">send-security-code-unauthenticated</pre></a><a href="#update-user-contact"><pre class="button color--hard-blue text--m">update-user-contact</pre></a><a href="#update-user-data"><pre class="button color--hard-blue text--m">update-user-data</pre></a><a href="#update-username"><pre class="button color--hard-blue text--m">update-username</pre></a><a href="#verify-security-code-authenticated"><pre class="button color--hard-blue text--m">verify-security-code-authenticated</pre></a><a href="#verify-security-code-unauthenticated"><pre class="button color--hard-blue text--m">verify-security-code-unauthenticated</pre></a><a href="#verify-user-password"><pre class="button color--hard-blue text--m">verify-user-password</pre></a><a href="#verify-user-pin-code"><pre class="button color--hard-blue text--m">verify-user-pin-code</pre></a></div></div></div><div class="section--header"><pre class="color--soft-grey text--xs text--uppercase">Clojure namespace</pre><pre class="color--black text--xl text--wrap text--bold">user-security-protocols.api</pre></div><div class="sections"></div><div class="sections"><div class="section" id="check-user-identifier"><div class="section--header"><pre class="color--soft-grey text--xs text--uppercase">defn</pre><pre class="color--hard-blue text--xl text--bold">check-user-identifier</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q778d33bc-6c0d-4ecd-80f2-3d6ff7632f43"><button class="snippet--header" onClick="toggleCollapsible(&apos;q778d33bc-6c0d-4ecd-80f2-3d6ff7632f43&apos;)"><pre class="text--xs text--uppercase color--hard-grey ">source-code</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">(defn check-user-identifier
  [request {:keys [additional-action-f
                   additional-security-f
                   client-rate-limit-exceeded-f
                   permission-granted-f
                   user-identifier-registered-f
                   user-identifier-valid-f
                   user-identifier-verified-f
                   user-rate-limit-exceeded-f]}]
  (let [ip-address (http/request-&gt;ip-address request)
        user-agent (http/request-&gt;user-agent request)]
       (cond (not (audit/ip-address-valid? ip-address))                                  {:body :invalid-request/invalid-ip-address                 :status 400}
             (not (audit/user-agent-valid? user-agent))                                  {:body :invalid-request/invalid-user-agent                 :status 400}
             (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded       :status 429}
             (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded         :status 429}
             (and permission-granted-f         (not (permission-granted-f)))             {:body :forbidden-request/permission-denied                :status 403}
             (and user-identifier-valid-f      (not (user-identifier-valid-f)))          {:body :forbidden-request/invalid-user-identifier-received :status 403}
             (and additional-security-f        (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed     :status 520}
             (and additional-action-f          (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed       :status 520}
             (not (user-identifier-registered-f)) {:body :performed-request/unregistered-user-identifier-received :status 200}
             (not user-identifier-verified-f)     {:body :performed-request/registered-user-identifier-received   :status 200}
             (not (user-identifier-verified-f))   {:body :performed-request/unverified-user-identifier-received   :status 200}
             :verified-user-identifier-received   {:body :performed-request/verified-user-identifier-received     :status 200})))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q12fe1bae-1283-4d2f-92be-54b543c6254f"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">description</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- Security protocol function for checking a user identifier (email address / phone number / username) (for authenticated / unauthenticated users)<br>  whether it is registered and/or verified.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q99292d28-efc6-4f11-bdc9-d9a43b1dac4d"><div class="snippet--header"><pre class="text--xs text--uppercase color--hard-blue ">note</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qf70ae430-807d-47d0-a956-ba8eb4ee4c6e"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(check-user-identifier {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qa3846619-3106-4505-a19a-9e230d59f5a8"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(check-user-identifier {...} {...})<br>=&gt;<br>{:body :performed-request/verified-user-identifier-received :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q89fa33ea-86ee-4861-b955-00c546909965"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        email-address (-&gt; request :params :email-address)]<br>       (check-user-identifier request {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address?    ip-address)<br>                                       :user-identifier-registered-f #(my-database/email-address-registered?              email-address)<br>                                       :user-identifier-valid-f      #(my-validator/email-address-valid?                  email-address)<br>                                       :user-identifier-verified-f   #(my-database/email-address-verified?                email-address)<br>                                       :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-email-address? email-address)})))<br>=&gt;<br>{:body :performed-request/verified-user-identifier-received :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="q155e4c97-b10c-42c3-b7c3-ad1218ae778e"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q56f2cfcf-b40a-4d06-aec7-1b9f6fed05e2"><button class="snippet--header" onClick="toggleCollapsible(&apos;q56f2cfcf-b40a-4d06-aec7-1b9f6fed05e2&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">functions</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :user-identifier-registered-f (function)      Must return TRUE if the received user identifier (email address / phone number / username) is registered.<br> :user-identifier-valid-f (function)(opt)      Must return TRUE if the received user identifier (email address / phone number / username) is valid.<br> :user-identifier-verified-f (function)(opt)   Must return TRUE if the received user identifier (if contact: email address / phone number) is verified.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q3b4aad30-dbfa-4256-b63f-447b63eb8099"><button class="snippet--header" onClick="toggleCollapsible(&apos;q3b4aad30-dbfa-4256-b63f-447b63eb8099&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">return</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:body (namespaced keyword)<br>  :forbidden-request/invalid-user-identifier-received      (Invalid user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/permission-denied                     (The user has no permission to do the action)<br>  :invalid-request/invalid-ip-address                      (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                      (No valid user agent has been found in the request)<br>  :performed-request/registered-user-identifier-received   (Registered user identifier (email address / phone number / username) has been received)<br>  :performed-request/unregistered-user-identifier-received (Unregistered user identifier (email address / phone number / username) has been received)<br>  :performed-request/unverified-user-identifier-received   (Registered but unverified user identifier (if contact: email address / phone number) has been received)<br>  :performed-request/verified-user-identifier-received     (Registered and verified user identifier (email address / phone number / username) has been received)<br>  :too-many-requests/client-rate-limit-exceeded            (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded              (Too many actions have been attempted by the user in a specific timeframe)<br>  :unknown-error/additional-action-stage-failed            (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed          (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 403, 429, 520}</pre></div></div></div></div><div class="section" id="create-user-account"><div class="section--header"><pre class="color--soft-grey text--xs text--uppercase">defn</pre><pre class="color--hard-blue text--xl text--bold">create-user-account</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q616c1f09-702b-4dc0-9928-b6e1b0697859"><button class="snippet--header" onClick="toggleCollapsible(&apos;q616c1f09-702b-4dc0-9928-b6e1b0697859&apos;)"><pre class="text--xs text--uppercase color--hard-grey ">source-code</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">(defn create-user-account
  [request {:keys [additional-action-f
                   additional-security-f
                   client-rate-limit-exceeded-f
                   create-user-account-f
                   permission-granted-f
                   provide-user-session-f
                   send-security-code-f
                   send-welcome-message-f
                   user-authenticated-f
                   user-data-valid-f
                   user-identifier-registered-f
                   user-identifier-valid-f
                   user-password-valid-f
                   user-rate-limit-exceeded-f]}]
  (let [ip-address (http/request-&gt;ip-address request)
        user-agent (http/request-&gt;user-agent request)]
       (cond (not (audit/ip-address-valid? ip-address))                                  {:body :invalid-request/invalid-ip-address                    :status 400}
             (not (audit/user-agent-valid? user-agent))                                  {:body :invalid-request/invalid-user-agent                    :status 400}
             (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded          :status 429}
             (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded            :status 429}
             (and permission-granted-f         (not (permission-granted-f)))             {:body :forbidden-request/permission-denied                   :status 403}
             (and user-authenticated-f         (boolean (user-authenticated-f)))         {:body :forbidden-request/user-authenticated                  :status 403}
             (and user-identifier-valid-f      (not (user-identifier-valid-f)))          {:body :forbidden-request/invalid-user-identifier-received    :status 403}
             (and user-password-valid-f        (not (user-password-valid-f)))            {:body :forbidden-request/invalid-user-password-received      :status 403}
             (and user-data-valid-f            (not (user-data-valid-f)))                {:body :forbidden-request/invalid-user-data-received          :status 403}
             (and user-identifier-registered-f (boolean (user-identifier-registered-f))) {:body :forbidden-request/registered-user-identifier-received :status 403}
             (and additional-security-f        (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed        :status 520}
             (and additional-action-f          (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed          :status 520}
             (and send-welcome-message-f       (not (send-welcome-message-f)))           {:body :server-error/unable-to-send-welcome-message           :status 500}
             (not (create-user-account-f))                           {:body :server-error/unable-to-create-user-account :status 500}
             (and send-security-code-f (not (send-security-code-f))) {:body :server-error/unable-to-send-security-code  :status 500}
             (and send-security-code-f)                              {:body :performed-request/security-code-sent       :status 201}
             (not provide-user-session-f)                            {:body :performed-request/user-account-created     :status 201}
             :providing-user-session                                 (if-let [response (provide-user-session-f {:body :performed-request/ready-to-provide-user-session :status 201})]
                                                                             (-&gt;&gt; {:body :performed-request/user-session-provided     :status 201} (merge response))
                                                                             (-&gt;  {:body :server-error/unable-to-provide-user-session :status 500})))))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qd4e72edc-14b2-4731-946d-da26875f93d5"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">description</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- Security protocol function for creating a user account that is identified by a user identifier (email address / phone number / username) and protected by a password.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qe6e6ce88-d866-41b4-9f77-401ec985b4ba"><div class="snippet--header"><pre class="text--xs text--uppercase color--hard-blue ">note</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).<br>- In case the 'send-security-code-f' function is passed, no security check has been failed, and the user account is successfully created,<br>  it applies the 'send-security-code-f' (it's a common scenario when user account creating followed by login code verification).<br>- In case the 'provide-user-session-f' function is passed, the 'send-security-code-f' function is NOT passed, no security check has<br>  been failed, and the user account is successfully created, it applies the 'provide-user-session-f' function on the HTTP response.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q54ee41ef-b681-4949-b829-56063243b8f6"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(create-user-account {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q589d9fe5-f4f9-428f-97d7-ae39f3c9af46"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(create-user-account {...} {...})<br>=&gt;<br>{:body :performed-request/user-account-created :status 201}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qb5bb84aa-263b-46fb-9f56-e42bf0212f1a"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        email-address (-&gt; request :params :email-address)<br>        user-password (-&gt; request :params :password)<br>        user-data     (-&gt; request :params)]<br>       (create-user-account request {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address?    ip-address)<br>                                     :create-user-account-f        #(my-database/create-user-account!                   user-data)<br>                                     :provide-user-session-f       #(my-session-handler/add-session-to-response         %)<br>                                     :send-security-code-f         #(my-email-service/send-security-code-email!         email-address)<br>                                     :send-welcome-message-f       #(my-email-service/send-welcome-email!               email-address)<br>                                     :user-authenticated-f         #(my-validator/request-has-valid-session-valid?      request)<br>                                     :user-data-valid-f            #(my-validator/user-data-valid?                      user-data)<br>                                     :user-identifier-registered-f #(my-database/email-address-registered?              email-address)<br>                                     :user-identifier-valid-f      #(my-validator/email-address-valid?                  email-address)<br>                                     :user-password-valid-f        #(my-validator/user-password-valid?                  user-password)<br>                                     :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-email-address? email-address)})))<br>=&gt;<br>{:body :performed-request/user-account-created :status 201}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="q389e2bc3-28ff-414c-a5f6-62da9e1e1ccc"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qfd8653da-0789-4a1e-bd0b-6a0d427c9e15"><button class="snippet--header" onClick="toggleCollapsible(&apos;qfd8653da-0789-4a1e-bd0b-6a0d427c9e15&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">functions</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :create-user-f (function)                     Side-effect function for creating the user account. Applied when every security check has been passed. Must return TRUE if the user account has been successfully created.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :provide-user-session-f (function)(opt)       Must take the response as parameter, and associate a user session to it (return NIL in case of error).<br> :send-security-code-f (function)(opt)         Must return TRUE if the security code email / SMS has been successfully sent.<br> :send-welcome-message-f (function)(opt)       Optional side-effect function for sending a welcome message to the user. Applied when every security check has been passed. Must return TRUE if the welcome email / SMS has been successfully sent.<br> :user-authenticated-f (function)(opt)         Must return TRUE the user is authenticated / logged in.<br> :user-data-valid-f (function)(opt)            Must return TRUE if the received user data is valid.<br> :user-identifier-registered-f (function)(opt) Must return TRUE if the received user identifier (email address / phone number / username) is registered.<br> :user-identifier-valid-f (function)(opt)      Must return TRUE if the received user identifier (email address / phone number / username) is valid.<br> :user-password-valid-f (function)(opt)        Must return TRUE if the received user password is valid.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q25c4e8d5-7ad4-4f4f-ad30-488dc14c2e89"><button class="snippet--header" onClick="toggleCollapsible(&apos;q25c4e8d5-7ad4-4f4f-ad30-488dc14c2e89&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">return</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:body (namespaced keyword)<br>  :forbidden-request/invalid-user-identifier-received    (Invalid user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/invalid-user-data-received          (Invalid user data has been received)<br>  :forbidden-request/invalid-user-password-received      (Invalid user password has been received)<br>  :forbidden-request/permission-denied                   (The user has no permission to do the action)<br>  :forbidden-request/registered-user-identifier-received (Registered user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/user-authenticated                  (The user is authenticated / logged in)<br>  :invalid-request/invalid-ip-address                    (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                    (No valid user agent has been found in the request)<br>  :performed-request/user-account-created                (The server has been successfully created the user account)<br>  :performed-request/user-session-provided               (The server has been successfully provided a user session to the HTTP response)<br>  :server-error/unable-to-create-user-account            (The server cannot create the user account)<br>  :server-error/unable-to-provide-user-session           (The server cannot provide the user session to the HTTP response)<br>  :server-error/unable-to-send-security-code             (The server cannot send the security code email / SMS to the user)<br>  :server-error/unable-to-send-welcome-message           (The server cannot send the welcome email / SMS to the user)<br>  :too-many-requests/client-rate-limit-exceeded          (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded            (Too many actions have been attempted by the user in a specific timeframe)<br>  :unknown-error/additional-action-stage-failed          (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed        (The additional security function returned a false value)<br> :status (integer)<br>  201, 400, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="drop-user-session"><div class="section--header"><pre class="color--soft-grey text--xs text--uppercase">defn</pre><pre class="color--hard-blue text--xl text--bold">drop-user-session</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="qe3c42a03-7dfb-4e32-9d4a-eb8627748133"><button class="snippet--header" onClick="toggleCollapsible(&apos;qe3c42a03-7dfb-4e32-9d4a-eb8627748133&apos;)"><pre class="text--xs text--uppercase color--hard-grey ">source-code</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">(defn drop-user-session
  [request {:keys [additional-action-f
                   additional-security-f
                   client-rate-limit-exceeded-f
                   drop-user-session-f
                   permission-granted-f
                   user-authenticated-f
                   user-exists-f
                   user-rate-limit-exceeded-f]}]
  (let [ip-address (http/request-&gt;ip-address request)
        user-agent (http/request-&gt;user-agent request)]
       (cond (not (audit/ip-address-valid? ip-address))                                  {:body :invalid-request/invalid-ip-address             :status 400}
             (not (audit/user-agent-valid? user-agent))                                  {:body :invalid-request/invalid-user-agent             :status 400}
             (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded   :status 429}
             (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded     :status 429}
             (and permission-granted-f         (not (permission-granted-f)))             {:body :forbidden-request/permission-denied            :status 403}
             (and user-authenticated-f         (not (user-authenticated-f)))             {:body :forbidden-request/user-unauthenticated         :status 403}
             (and user-exists-f                (not (user-exists-f)))                    {:body :forbidden-request/user-not-exists              :status 403}
             (and additional-security-f        (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed :status 520}
             (and additional-action-f          (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed   :status 520}
             :dropping-user-session (if-let [response (drop-user-session-f {:body :performed-request/ready-to-drop-user-session :status 200})]
                                            (-&gt;&gt; {:body :performed-request/user-session-dropped   :status 200} (merge response))
                                            (-&gt;  {:body :server-error/unable-to-drop-user-session :status 500})))))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q7056f533-d1bc-4a11-93c0-e69f34dcc054"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">description</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- Security protocol function for dropping a user session.<br>- Performs various security checks before returns a HTTP response indicating the result of the checks.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q6e445e69-09b3-43c3-8416-59d22dbd5191"><div class="snippet--header"><pre class="text--xs text--uppercase color--hard-blue ">note</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q0ccc5a0f-2b27-43b7-84ab-05cab0fa6662"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(drop-user-session {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qb2ef18fd-4e14-4963-897c-789101846de5"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(drop-user-session {...} {...})<br>=&gt;<br>{:body :performed-request/user-session-dropped :status 200 :session {}}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q2d8a5406-0ca9-4191-b3a7-d4b23eba0d9a"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(defn my-route<br>  [request]<br>  (let [ip-address (-&gt; request :remote-addr)<br>        user-id    (-&gt; request :session :user-id)]<br>       (drop-user-session request {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address? ip-address)<br>                                   :drop-user-session-f          #(assoc % :session {})<br>                                   :user-authenticated-f         #(my-validator/request-has-valid-session?         request)<br>                                   :user-exists-f                #(my-database/user-id-exists?                     user-id)<br>                                   :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-user-id?    user-id)})))<br>=&gt;<br>{:body :performed-request/user-session-dropped :status 200 :session {}}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="q5c08549e-505b-4c12-a034-5754d575a0fe"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q1e1d9c0f-b47d-4e73-8c2b-74cd76db8b60"><button class="snippet--header" onClick="toggleCollapsible(&apos;q1e1d9c0f-b47d-4e73-8c2b-74cd76db8b60&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">functions</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :drop-user-session-f (function)               Must take the response as parameter, and remove the user session from it (return NIL in case of error).<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :user-authenticated-f (function)(opt)         Must return TRUE the user is authenticated / logged in.<br> :user-exists-f (function)(opt)                Must return TRUE the user exists.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q7573af8c-313c-442b-9a64-aaf1d3c29119"><button class="snippet--header" onClick="toggleCollapsible(&apos;q7573af8c-313c-442b-9a64-aaf1d3c29119&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">return</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:body (namespaced keyword)<br>  :forbidden-request/permission-denied            (The user has no permission to do the action)<br>  :forbidden-request/user-not-exists              (The user ID does not exist)<br>  :forbidden-request/user-unauthenticated         (The user is unauthenticated / not logged in)<br>  :invalid-request/invalid-ip-address             (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent             (No valid user agent has been found in the request)<br>  :performed-request/user-session-dropped         (The user session has been removed successfully)<br>  :server-error/unable-to-drop-user-session       (The server cannot remove the user session from the HTTP response)<br>  :unknown-error/additional-action-stage-failed   (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 429, 500, 520}</pre></div></div></div></div><div class="section" id="recover-user-password"><div class="section--header"><pre class="color--soft-grey text--xs text--uppercase">defn</pre><pre class="color--hard-blue text--xl text--bold">recover-user-password</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q20265390-648f-4a55-aef2-134c56f7d87b"><button class="snippet--header" onClick="toggleCollapsible(&apos;q20265390-648f-4a55-aef2-134c56f7d87b&apos;)"><pre class="text--xs text--uppercase color--hard-grey ">source-code</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">(defn recover-user-password
  [request {:keys [additional-action-f
                   additional-security-f
                   client-rate-limit-exceeded-f
                   fresh-password-valid-f
                   permission-granted-f
                   provide-user-session-f
                   recover-user-password-f
                   security-code-correct-f
                   security-code-device-matches-f
                   security-code-expired-f
                   security-code-sent-f
                   security-code-valid-f
                   user-authenticated-f
                   user-identifier-registered-f
                   user-identifier-valid-f
                   user-identifier-verified-f
                   user-rate-limit-exceeded-f]}]
  (let [ip-address (http/request-&gt;ip-address request)
        user-agent (http/request-&gt;user-agent request)]
       (cond (not (audit/ip-address-valid? ip-address))                                    {:body :invalid-request/invalid-ip-address                      :status 400}
             (not (audit/user-agent-valid? user-agent))                                    {:body :invalid-request/invalid-user-agent                      :status 400}
             (and client-rate-limit-exceeded-f   (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded            :status 429}
             (and user-rate-limit-exceeded-f     (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded              :status 429}
             (and permission-granted-f           (not (permission-granted-f)))             {:body :forbidden-request/permission-denied                     :status 403}
             (and user-authenticated-f           (boolean (user-authenticated-f)))         {:body :forbidden-request/user-authenticated                    :status 403}
             (and fresh-password-valid-f         (not (fresh-password-valid-f)))           {:body :forbidden-request/invalid-fresh-password-received       :status 403}
             (and user-identifier-valid-f        (not (user-identifier-valid-f)))          {:body :forbidden-request/invalid-user-identifier-received      :status 403}
             (and security-code-valid-f          (not (security-code-valid-f)))            {:body :forbidden-request/invalid-security-code-received        :status 403}
             (and security-code-sent-f           (not (security-code-sent-f)))             {:body :forbidden-request/no-security-code-sent-in-timeframe    :status 403}
             (and user-identifier-registered-f   (not (user-identifier-registered-f)))     {:body :forbidden-request/unregistered-user-identifier-received :status 403}
             (and security-code-device-matches-f (not (security-code-device-matches-f)))   {:body :forbidden-request/security-code-device-not-matches      :status 403}
             (and user-identifier-verified-f     (not (user-identifier-verified-f)))       {:body :forbidden-request/unverified-user-identifier-received   :status 403}
             (and security-code-correct-f        (not (security-code-correct-f)))          {:body :unauthorized-request/incorrect-security-code-received   :status 401}
             (and security-code-expired-f        (boolean (security-code-expired-f)))      {:body :unauthorized-request/expired-security-code-received     :status 401}
             (and additional-security-f          (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed          :status 520}
             (and additional-action-f            (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed            :status 520}
             (not (recover-user-password-f)) {:body :server-error/unable-to-recover-user-password :status 500}
             (not provide-user-session-f)    {:body :performed-request/user-password-recovered    :status 200}
             :providing-user-session         (if-let [response (provide-user-session-f {:body :performed-request/ready-to-provide-user-session :status 200})]
                                                     (-&gt;&gt; {:body :performed-request/user-session-provided     :status 200} (merge response))
                                                     (-&gt;  {:body :server-error/unable-to-provide-user-session :status 500})))))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qd0cf14f8-53e2-4825-8dec-2f5ebc2a5549"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">description</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- Security protocol function for user password recovering (for authenticated users) with optional security code verification.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q68d4c002-3cf5-410b-a7ff-4b43498a7494"><div class="snippet--header"><pre class="text--xs text--uppercase color--hard-blue ">note</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).<br>- In case the 'provide-user-session-f' function is passed, no security check has been failed, and the received security code is correct,<br>  it applies the 'provide-user-session-f' function on the HTTP response.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q160b96a7-2871-4d7c-986d-74397b93f03f"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(recover-user-password {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q2726d398-f50f-43d1-976f-0296c82317b3"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(recover-user-password {...} {...})<br>=&gt;<br>{:body :performed-request/user-password-recovered :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q574ffb71-d4a2-4fbc-ae53-143a7191dd13"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(defn my-route<br>  [request]<br>  (let [ip-address     (-&gt; request :remote-addr)<br>        email-address  (-&gt; request :params :email-address)<br>        fresh-password (-&gt; request :params :fresh-password)<br>        security-code  (-&gt; request :params :security-code)<br>        user-id        (my-database/get-user-id-by-email-address email-address)]<br>       (recover-user-password request {:client-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-ip-address?                 ip-address)<br>                                       :fresh-password-valid-f         #(my-validator/user-password-valid?                               fresh-password)<br>                                       :provide-user-session-f         #(my-session-handler/add-session-to-response                      %)<br>                                       :recover-user-password-f        #(my-database/recover-user-password!                              user-id fresh-password)<br>                                       :security-code-correct-f        #(my-database/security-code-matches?                              user-id security-code)<br>                                       :security-code-device-matches-f #(my-log-service/security-code-required-from-the-same-ip-address? user-id ip-address)<br>                                       :security-code-expired-f        #(my-database/security-code-expired?                              user-id)<br>                                       :security-code-sent-f           #(my-database/security-code-sent?                                 user-id)<br>                                       :security-code-valid-f          #(my-validator/security-code-valid?                               security-code)<br>                                       :user-authenticated-f           #(my-validator/request-has-valid-session?                         request)<br>                                       :user-identifier-registered-f   #(my-database/email-address-registered?                           email-address)<br>                                       :user-identifier-valid-f        #(my-validator/email-address-valid?                               email-address)<br>                                       :user-identifier-verified-f     #(my-database/email-address-verified?                             email-address)<br>                                       :user-rate-limit-exceeded-f     #(my-log-service/too-many-attempts-by-user-id?                    user-id)})))<br>=&gt;<br>{:body :performed-request/user-password-recovered :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="qdfefae8c-ba6e-405c-87da-b5e76d486849"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q4c9d60a8-3d40-454c-abe7-4c9c75d6c5e5"><button class="snippet--header" onClick="toggleCollapsible(&apos;q4c9d60a8-3d40-454c-abe7-4c9c75d6c5e5&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">functions</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:additional-action-f (function)(opt)            Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)          Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :fresh-password-valid-f (function)              Must return TRUE if the received fresh password is valid.<br> :permission-granted-f (function)(opt)           Must return TRUE if the user has permission to do the action.<br> :provide-user-session-f (function)(opt)         Must take the response as parameter, and associate a user session to it (return NIL in case of error).<br> :recover-user-password-f (function)             Side-effect function for recovering the user's password. Applied when every security check has been passed. Must return TRUE if the user's password has been successfully recovered.<br> :security-code-correct-f (function)(opt)        Must return TRUE if the received security code is correct.<br> :security-code-device-matches-f (function)(opt) Must return TRUE if the received security code has been required from the same device.<br> :security-code-expired-f (function)(opt)        Must return TRUE if the received security code has been expired.<br> :security-code-sent-f (function)(opt)           Must return TRUE if a security code has been sent.<br> :security-code-valid-f (function)(opt)          Must return TRUE if the received security code is valid.<br> :user-authenticated-f (function)(opt)           Must return TRUE the user is authenticated / logged in.<br> :user-identifier-registered-f (function)(opt)   Must return TRUE if the received user identifier (email address / phone number / username) is registered.<br> :user-identifier-valid-f (function)(opt)        Must return TRUE if the received user identifier (email address / phone number / username) is valid.<br> :user-identifier-verified-f (function)(opt)     Must return TRUE if the received user identifier (if contact: email address / phone number) is verified.<br> :user-rate-limit-exceeded-f (function)(opt)     Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q03ca4bfd-0e9a-4ff5-859e-7a534434d27a"><button class="snippet--header" onClick="toggleCollapsible(&apos;q03ca4bfd-0e9a-4ff5-859e-7a534434d27a&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">return</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:body (namespaced keyword)<br>  :invalid-request/invalid-ip-address                      (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                      (No valid user agent has been found in the request)<br>  :forbidden-request/invalid-fresh-password-received       (Invalid fresh password has been received)<br>  :forbidden-request/invalid-security-code-received        (Invalid security code has been received)<br>  :forbidden-request/invalid-user-identifier-received      (Invalid user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/no-security-code-sent-in-timeframe    (No security code has been sent in a specific timeframe)<br>  :forbidden-request/permission-denied                     (The user has no permission to do the action)<br>  :forbidden-request/security-code-device-not-matches      (The received security code has been required from another device)<br>  :forbidden-request/unregistered-user-identifier-received (Unregistered user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/unverified-user-identifier-received   (Unverified user identifier (if contact: email address / phone number) has been received)<br>  :forbidden-request/user-authenticated                    (The user is authenticated / logged in)<br>  :performed-request/user-password-recovered               (The server has been successfully recovered the user's password)<br>  :performed-request/user-session-provided                 (The server has been successfully provided a user session to the HTTP response)<br>  :server-error/unable-to-provide-user-session             (The server cannot provide the user session to the HTTP response)<br>  :server-error/unable-to-recover-user-password            (The server cannot recover the user's password)<br>  :too-many-requests/client-rate-limit-exceeded            (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded              (Too many actions have been attempted by the user in a specific timeframe)<br>  :unauthorized-request/expired-security-code-received     (Expired security code has been received)<br>  :unauthorized-request/incorrect-security-code-received   (Incorrect security code has been received)<br>  :unknown-error/additional-action-stage-failed            (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed          (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 401, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="remove-user-account"><div class="section--header"><pre class="color--soft-grey text--xs text--uppercase">defn</pre><pre class="color--hard-blue text--xl text--bold">remove-user-account</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q6e3570dd-87c6-471d-9910-97beef39a3ff"><button class="snippet--header" onClick="toggleCollapsible(&apos;q6e3570dd-87c6-471d-9910-97beef39a3ff&apos;)"><pre class="text--xs text--uppercase color--hard-grey ">source-code</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">(defn remove-user-account
  [request {:keys [additional-action-f
                   additional-security-f
                   client-rate-limit-exceeded-f
                   drop-user-session-f
                   permission-granted-f
                   remove-user-account-f
                   security-code-correct-f
                   security-code-device-matches-f
                   security-code-expired-f
                   security-code-sent-f
                   security-code-valid-f
                   send-goodbye-message-f
                   user-authenticated-f
                   user-exists-f
                   user-password-correct-f
                   user-password-valid-f
                   user-rate-limit-exceeded-f]}]
  (let [ip-address (http/request-&gt;ip-address request)
        user-agent (http/request-&gt;user-agent request)]
       (cond (not (audit/ip-address-valid? ip-address))                                    {:body :invalid-request/invalid-ip-address                    :status 400}
             (not (audit/user-agent-valid? user-agent))                                    {:body :invalid-request/invalid-user-agent                    :status 400}
             (and client-rate-limit-exceeded-f   (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded          :status 429}
             (and user-rate-limit-exceeded-f     (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded            :status 429}
             (and permission-granted-f           (not (permission-granted-f)))             {:body :forbidden-request/permission-denied                   :status 403}
             (and user-authenticated-f           (not (user-authenticated-f)))             {:body :forbidden-request/user-unauthenticated                :status 403}
             (and user-exists-f                  (not (user-exists-f)))                    {:body :forbidden-request/user-not-exists                     :status 403}
             (and user-password-valid-f          (not (user-password-valid-f)))            {:body :forbidden-request/invalid-user-password-received      :status 403}
             (and security-code-valid-f          (not (security-code-valid-f)))            {:body :forbidden-request/invalid-security-code-received      :status 403}
             (and security-code-sent-f           (not (security-code-sent-f)))             {:body :forbidden-request/no-security-code-sent-in-timeframe  :status 403}
             (and security-code-device-matches-f (not (security-code-device-matches-f)))   {:body :forbidden-request/security-code-device-not-matches    :status 403}
             (and user-password-correct-f        (not (user-password-correct-f)))          {:body :unauthorized-request/incorrect-user-password-received :status 401}
             (and security-code-correct-f        (not (security-code-correct-f)))          {:body :unauthorized-request/incorrect-security-code-received :status 401}
             (and security-code-expired-f        (boolean (security-code-expired-f)))      {:body :unauthorized-request/expired-security-code-received   :status 401}
             (and additional-security-f          (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed        :status 520}
             (and additional-action-f            (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed          :status 520}
             (and send-goodbye-message-f         (not (send-goodbye-message-f)))           {:body :server-error/unable-to-send-goodbye-message           :status 500}
             (not (remove-user-account-f)) {:body :server-error/unable-to-remove-user-account :status 500}
             (not drop-user-session-f)     {:body :performed-request/user-account-removed     :status 200}
             :dropping-user-session        (if-let [response (drop-user-session-f {:body :performed-request/ready-to-drop-user-session :status 200})]
                                                   (-&gt;&gt; {:body :performed-request/user-session-dropped   :status 200} (merge response))
                                                   (-&gt;  {:body :server-error/unable-to-drop-user-session :status 500})))))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q4475785d-fc6c-4524-be3f-58a318c825f6"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">description</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- Security protocol function for user account removal (for authenticated users) with optional user password and/or security code verification.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q481bdca3-bd71-46d6-a6e7-a4072f9b9aa4"><div class="snippet--header"><pre class="text--xs text--uppercase color--hard-blue ">note</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q28ad4d1b-cf57-41da-b440-e8d6f51328f7"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(remove-user-account {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q73b12c07-af8b-42cf-9df5-c7958f8d6f68"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(remove-user-account {...} {...})<br>=&gt;<br>{:body :performed-request/user-account-removed :status 200 :session {}}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q1ec95e89-eac7-4686-a235-fa0b1d02a697"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        user-password (-&gt; request :params :password)<br>        security-code (-&gt; request :params :security-code)<br>        user-id       (-&gt; request :session :user-id)]<br>       (remove-user-account request {:client-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-ip-address?                 ip-address)<br>                                     :drop-user-session-f            #(assoc % :session {})<br>                                     :remove-user-account-f          #(my-database/remove-user-account!                                user-id)<br>                                     :security-code-correct-f        #(my-database/security-code-matches?                              user-id security-code)<br>                                     :security-code-device-matches-f #(my-log-service/security-code-required-from-the-same-ip-address? user-id ip-address)<br>                                     :security-code-expired-f        #(my-database/security-code-expired?                              user-id)<br>                                     :security-code-sent-f           #(my-database/security-code-sent?                                 user-id)<br>                                     :security-code-valid-f          #(my-validator/security-code-valid?                               security-code)<br>                                     :send-goodbye-message-f         #(my-email-service/send-goodbye-email!                            user-id)<br>                                     :user-authenticated-f           #(my-validator/request-has-valid-session?                         request)<br>                                     :user-exists-f                  #(my-database/user-id-exists?                                     user-id)<br>                                     :user-password-correct-f        #(my-database/user-password-matches?                              user-password)<br>                                     :user-password-valid-f          #(my-validator/user-password-valid?                               user-password)<br>                                     :user-rate-limit-exceeded-f     #(my-log-service/too-many-attempts-by-user-id?                    user-id)})))<br>=&gt;<br>{:body :performed-request/user-account-removed :status 200 :session {}}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="qf22976da-12fd-4903-a9d4-a4f0d9cdb57d"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qdf0c76d1-e86e-4ac3-a5ab-547b8dcfa8c0"><button class="snippet--header" onClick="toggleCollapsible(&apos;qdf0c76d1-e86e-4ac3-a5ab-547b8dcfa8c0&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">functions</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:additional-action-f (function)(opt)             Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)           Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt)    Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :drop-user-session-f (function)(opt)             Must take the response as parameter, and remove the user session from it (return NIL in case of error).<br> :permission-granted-f (function)(opt)            Must return TRUE if the user has permission to do the action.<br> :remove-user-account-f (function)                Side-effect function for removing the user account. Applied when every security check has been passed. Must return TRUE if the user account has been successfully removed.<br> :security-code-correct-f (function)(opt)         Must return TRUE if the received security code is correct.<br> :security-code-device-matches-f (function)(opt)  Must return TRUE if the received security code has been required from the same device.<br> :security-code-expired-f (function)(opt)         Must return TRUE if the received security code has been expired.<br> :security-code-sent-f (function)(opt)            Must return TRUE if a security code has been sent.<br> :security-code-valid-f (function)(opt)           Must return TRUE if the received security code is valid.<br> :send-goodbye-message-f (function)(opt)          Optional side-effect function for sending a goodbye message to the user. Applied when every security check has been passed. Must return TRUE if the goodbye email / SMS has been successfully sent.<br> :user-authenticated-f (function)(opt)            Must return TRUE the user is authenticated / logged in.<br> :user-exists-f (function)(opt)                   Must return TRUE the user exists.<br> :user-password-correct-f (function)(opt)         Must return TRUE if the received user password is correct.<br> :user-password-valid-f (function)(opt)           Must return TRUE if the received user password is valid.<br> :user-rate-limit-exceeded-f (function)(opt)      Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q28fbc139-7207-4b33-9c74-cb646deda28b"><button class="snippet--header" onClick="toggleCollapsible(&apos;q28fbc139-7207-4b33-9c74-cb646deda28b&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">return</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:body (namespaced keyword)<br>  :forbidden-request/invalid-security-code-received      (Invalid security code has been received)<br>  :forbidden-request/invalid-user-password-received      (Invalid user password has been received)<br>  :forbidden-request/no-security-code-sent-in-timeframe  (No security code has been sent in a specific timeframe)<br>  :forbidden-request/permission-denied                   (The user has no permission to do the action)<br>  :forbidden-request/security-code-device-not-matches    (The received security code has been required from another device)<br>  :forbidden-request/user-not-exists                     (The user ID does not exist)<br>  :forbidden-request/user-unauthenticated                (The user is unauthenticated / not logged in)<br>  :invalid-request/invalid-ip-address                    (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                    (No valid user agent has been found in the request)<br>  :performed-request/user-account-removed                (The server has been successfully removed the user account)<br>  :performed-request/user-session-dropped                (The server has been successfully removed the user account and the user session from the HTTP response)<br>  :server-error/unable-to-drop-user-session              (The server cannot remove the user session from the HTTP response)<br>  :server-error/unable-to-remove-user-account            (The server cannot remove the user account)<br>  :server-error/unable-to-send-goodbye-message           (The server cannot send the goodbye email / SMS to the user)<br>  :too-many-requests/client-rate-limit-exceeded          (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded            (Too many actions have been attempted by the user in a specific timeframe)<br>  :unauthorized-request/expired-security-code-received   (Expired security code has been received)<br>  :unauthorized-request/incorrect-security-code-received (Incorrect security code has been received)<br>  :unauthorized-request/incorrect-user-password-received (Incorrect user password has been received)<br>  :unknown-error/additional-action-stage-failed          (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed        (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 401, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="send-security-code-authenticated"><div class="section--header"><pre class="color--soft-grey text--xs text--uppercase">defn</pre><pre class="color--hard-blue text--xl text--bold">send-security-code-authenticated</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="qdd73db1a-684a-4f70-9357-aa43756289f9"><button class="snippet--header" onClick="toggleCollapsible(&apos;qdd73db1a-684a-4f70-9357-aa43756289f9&apos;)"><pre class="text--xs text--uppercase color--hard-grey ">source-code</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">(defn send-security-code-authenticated
  [request {:keys [additional-action-f
                   additional-security-f
                   client-rate-limit-exceeded-f
                   permission-granted-f
                   send-security-code-f
                   user-authenticated-f
                   user-exists-f
                   user-rate-limit-exceeded-f]}]
  (let [ip-address (http/request-&gt;ip-address request)
        user-agent (http/request-&gt;user-agent request)]
       (cond (not (audit/ip-address-valid? ip-address))                                  {:body :invalid-request/invalid-ip-address             :status 400}
             (not (audit/user-agent-valid? user-agent))                                  {:body :invalid-request/invalid-user-agent             :status 400}
             (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded   :status 429}
             (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded     :status 429}
             (and permission-granted-f         (not (permission-granted-f)))             {:body :forbidden-request/permission-denied            :status 403}
             (and user-authenticated-f         (not (user-authenticated-f)))             {:body :forbidden-request/user-unauthenticated         :status 403}
             (and user-exists-f                (not (user-exists-f)))                    {:body :forbidden-request/user-not-exists              :status 403}
             (and additional-security-f        (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed :status 520}
             (and additional-action-f          (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed   :status 520}
             (not (send-security-code-f)) {:body :server-error/unable-to-send-security-code :status 500}
             :security-code-sent          {:body :performed-request/security-code-sent      :status 200})))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qad32c39a-52c7-4940-a891-bb30ffbd8525"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">description</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- Security protocol function for security code sending via email / SMS (for authenticated users).<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q42c2eec6-16b6-4a4b-895b-a7267ac82d4c"><div class="snippet--header"><pre class="text--xs text--uppercase color--hard-blue ">note</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q6bf4ae5e-f0ab-46aa-ac2e-7b972f897255"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(send-security-code-authenticated {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q50c704b1-60d8-400a-b363-c2f82e989590"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(send-security-code-authenticated {...} {...})<br>=&gt;<br>{:body :performed-request/security-code-sent :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q193e141a-fcb9-4461-b545-31186f85cff0"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(defn my-route<br>  [request]<br>  (let [ip-address (-&gt; request :remote-addr)<br>        user-id    (-&gt; request :session :user-id)]<br>       (send-security-code-authenticated request {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address? ip-address)<br>                                                  :send-security-code-f         #(my-email-service/send-security-code-email!      user-id)<br>                                                  :user-authenticated-f         #(my-validator/request-has-valid-session?         request)<br>                                                  :user-exists-f                #(my-database/user-id-exists?                     user-id)<br>                                                  :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-user-id?    user-id)})))<br>=&gt;<br>{:body :performed-request/security-code-sent :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="q529f128c-f745-4cd1-86ab-52ea584075ab"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q75c7f736-d132-4c9e-b709-1ea4bed7487c"><button class="snippet--header" onClick="toggleCollapsible(&apos;q75c7f736-d132-4c9e-b709-1ea4bed7487c&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">functions</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :send-security-code-f (function)              Side-effect function for sending the security code to the user. Applied when every security check has been passed. Must return TRUE if the security code email / SMS has been successfully sent.<br> :user-authenticated-f (function)(opt)         Must return TRUE the user is authenticated / logged in.<br> :user-exists-f (function)(opt)                Must return TRUE the user exists.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qe60dc5f7-e991-4703-955d-fa7fba05b71a"><button class="snippet--header" onClick="toggleCollapsible(&apos;qe60dc5f7-e991-4703-955d-fa7fba05b71a&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">return</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:body (namespaced keyword)<br>  :forbidden-request/permission-denied            (The user has no permission to do the action)<br>  :forbidden-request/user-not-exists              (The user ID does not exist)<br>  :forbidden-request/user-unauthenticated         (The user is unauthenticated / not logged in)<br>  :invalid-request/invalid-ip-address             (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent             (No valid user agent has been found in the request)<br>  :performed-request/security-code-sent           (The server has been successfully sent the security code email / SMS to the user)<br>  :server-error/unable-to-send-security-code      (The server cannot send the security code email / SMS to the user)<br>  :too-many-requests/client-rate-limit-exceeded   (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded     (Too many actions have been attempted by the user in a specific timeframe)<br>  :unknown-error/additional-action-stage-failed   (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="send-security-code-unauthenticated"><div class="section--header"><pre class="color--soft-grey text--xs text--uppercase">defn</pre><pre class="color--hard-blue text--xl text--bold">send-security-code-unauthenticated</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="qb945d1d9-7155-4111-bacc-830d964b9f1a"><button class="snippet--header" onClick="toggleCollapsible(&apos;qb945d1d9-7155-4111-bacc-830d964b9f1a&apos;)"><pre class="text--xs text--uppercase color--hard-grey ">source-code</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">(defn send-security-code-unauthenticated
  [request {:keys [additional-action-f
                   additional-security-f
                   client-rate-limit-exceeded-f
                   permission-granted-f
                   send-security-code-f
                   user-authenticated-f
                   user-identifier-registered-f
                   user-identifier-valid-f
                   user-identifier-verified-f
                   user-rate-limit-exceeded-f]}]
  (let [ip-address (http/request-&gt;ip-address request)
        user-agent (http/request-&gt;user-agent request)]
       (cond (not (audit/ip-address-valid? ip-address))                                  {:body :invalid-request/invalid-ip-address                      :status 400}
             (not (audit/user-agent-valid? user-agent))                                  {:body :invalid-request/invalid-user-agent                      :status 400}
             (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded            :status 429}
             (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded              :status 429}
             (and permission-granted-f         (not (permission-granted-f)))             {:body :forbidden-request/permission-denied                     :status 403}
             (and user-authenticated-f         (boolean (user-authenticated-f)))         {:body :forbidden-request/user-authenticated                    :status 403}
             (and user-identifier-valid-f      (not (user-identifier-valid-f)))          {:body :forbidden-request/invalid-user-identifier-received      :status 403}
             (and user-identifier-registered-f (not (user-identifier-registered-f)))     {:body :forbidden-request/unregistered-user-identifier-received :status 403}
             (and user-identifier-verified-f   (not (user-identifier-verified-f)))       {:body :forbidden-request/unverified-user-identifier-received   :status 403}
             (and additional-security-f        (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed          :status 520}
             (and additional-action-f          (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed            :status 520}
             (not (send-security-code-f)) {:body :server-error/unable-to-send-security-code :status 500}
             :security-code-sent          {:body :performed-request/security-code-sent      :status 200})))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q2e235add-b211-4922-b976-f4c951138e5a"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">description</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- Security protocol function for security code sending via email / SMS (for unauthenticated users).<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qf1997d73-599b-4952-bb03-78e63031cb83"><div class="snippet--header"><pre class="text--xs text--uppercase color--hard-blue ">note</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q32515d40-ef11-44a2-92e8-c761616c0f61"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(send-security-code-unauthenticated {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q48a381ff-1c86-4a2d-a3ce-1beb2730093f"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(send-security-code-unauthenticated {...} {...})<br>=&gt;<br>{:body :performed-request/security-code-sent :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qea9850a0-3fcb-446a-9759-79fa4759f18d"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        email-address (-&gt; request :params :email-address)]<br>       (send-security-code-unauthenticated request {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address?    ip-address)<br>                                                    :send-security-code-f         #(my-email-service/send-security-code-email!         email-address)<br>                                                    :user-authenticated-f         #(my-validator/request-has-valid-session?            request)<br>                                                    :user-identifier-registered-f #(my-database/email-address-registered?              email-address)<br>                                                    :user-identifier-valid-f      #(my-validator/email-address-valid?                  email-address)<br>                                                    :user-identifier-verified-f   #(my-database/email-address-verified?                email-address)<br>                                                    :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-email-address? email-address)})))<br>=&gt;<br>{:body :performed-request/security-code-sent :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="qbcd5e69f-2eac-4270-a2ed-728285697a52"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q5540d878-3ed0-4da0-9514-927e6b90de96"><button class="snippet--header" onClick="toggleCollapsible(&apos;q5540d878-3ed0-4da0-9514-927e6b90de96&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">functions</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :send-security-code-f (function)              Side-effect function for sending the security code to the user. Applied when every security check has been passed. Must return TRUE if the security code email / SMS has been successfully sent.<br> :user-authenticated-f (function)(opt)         Must return TRUE the user is authenticated / logged in.<br> :user-identifier-registered-f (function)(opt) Must return TRUE if the received user identifier (email address / phone number / username) is registered.<br> :user-identifier-valid-f (function)(opt)      Must return TRUE if the received user identifier (email address / phone number / username) is valid.<br> :user-identifier-verified-f (function)(opt)   Must return TRUE if the received user identifier (if contact: email address / phone number) is verified.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qe3728626-10f8-4a49-b410-38832e48e08f"><button class="snippet--header" onClick="toggleCollapsible(&apos;qe3728626-10f8-4a49-b410-38832e48e08f&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">return</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:body (namespaced keyword)<br>  :forbidden-request/invalid-user-identifier-received      (Invalid user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/permission-denied                     (The user has no permission to do the action)<br>  :forbidden-request/unregistered-user-identifier-received (Unregistered user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/unverified-user-identifier-received   (Unverified user identifier (if contact: email address / phone number) has been received)<br>  :forbidden-request/user-authenticated                    (The user is authenticated / logged in)<br>  :invalid-request/invalid-ip-address                      (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                      (No valid user agent has been found in the request)<br>  :performed-request/security-code-sent                    (The server has been successfully sent the security code email / SMS to the user)<br>  :server-error/unable-to-send-security-code               (The server cannot send the security code email / SMS to the user)<br>  :too-many-requests/client-rate-limit-exceeded            (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded              (Too many actions have been attempted by the user in a specific timeframe)<br>  :unknown-error/additional-action-stage-failed            (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed          (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="update-username"><div class="section--header"><pre class="color--soft-grey text--xs text--uppercase">defn</pre><pre class="color--hard-blue text--xl text--bold">update-username</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q75c37e84-9c72-4041-bfa9-f0e140f703d7"><button class="snippet--header" onClick="toggleCollapsible(&apos;q75c37e84-9c72-4041-bfa9-f0e140f703d7&apos;)"><pre class="text--xs text--uppercase color--hard-grey ">source-code</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">(defn update-username
  [request {:keys [additional-action-f
                   additional-security-f
                   client-rate-limit-exceeded-f
                   permission-granted-f
                   update-username-f
                   username-registered-f
                   username-valid-f
                   user-authenticated-f
                   user-exists-f
                   user-password-correct-f
                   user-password-valid-f
                   user-rate-limit-exceeded-f]}]
  (let [ip-address (http/request-&gt;ip-address request)
        user-agent (http/request-&gt;user-agent request)]
       (cond (not (audit/ip-address-valid? ip-address))                                  {:body :invalid-request/invalid-ip-address                    :status 400}
             (not (audit/user-agent-valid? user-agent))                                  {:body :invalid-request/invalid-user-agent                    :status 400}
             (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded          :status 429}
             (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded            :status 429}
             (and permission-granted-f         (not (permission-granted-f)))             {:body :forbidden-request/permission-denied                   :status 403}
             (and user-authenticated-f         (not (user-authenticated-f)))             {:body :forbidden-request/user-unauthenticated                :status 403}
             (and user-exists-f                (not (user-exists-f)))                    {:body :forbidden-request/user-not-exists                     :status 403}
             (and username-valid-f             (not (username-valid-f)))                 {:body :forbidden-request/invalid-username-received           :status 403}
             (and user-password-valid-f        (not (user-password-valid-f)))            {:body :forbidden-request/invalid-user-password-received      :status 403}
             (and username-registered-f        (boolean (username-registered-f)))        {:body :forbidden-request/registered-username-received        :status 403}
             (and user-password-correct-f      (not (user-password-correct-f)))          {:body :unauthorized-request/incorrect-user-password-received :status 401}
             (and additional-security-f        (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed        :status 520}
             (and additional-action-f          (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed          :status 520}
             (not (update-username-f)) {:body :server-error/unable-to-update-username :status 500}
             :username-updated         {:body :performed-request/username-updated     :status 200})))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q1d68b58a-9230-4b9e-9f90-ef7be5046639"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">description</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- Security protocol function for updating a username (for authenticated users) with optional password verification.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q6392407e-b5ab-408f-b4a6-784bfe9f8a62"><div class="snippet--header"><pre class="text--xs text--uppercase color--hard-blue ">note</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q5b6ce650-f8a9-401a-9976-b9719f3ae741"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(update-username {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q9aa0d997-189b-4908-a8b5-56593eaac910"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(update-username {...} {...})<br>=&gt;<br>{:body :performed-request/username-updated :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q172510b2-2c52-4bcc-832f-26f56c3c9482"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        username      (-&gt; request :params :username)<br>        user-password (-&gt; request :params :password)<br>        security-code (-&gt; request :params :security-code)<br>        user-id       (-&gt; request :session :user-id)]<br>       (update-username request {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address? ip-address)<br>                                 :update-username-f            #(my-database/update-user-username!               user-id username)<br>                                 :username-registered-f        #(my-database/username-registered?                username)<br>                                 :username-valid-f             #(my-validator/username-valid?                    username)<br>                                 :user-authenticated-f         #(my-validator/request-has-valid-session?         request)<br>                                 :user-exists-f                #(my-database/user-id-exists?                     user-id)<br>                                 :user-password-correct-f      #(my-database/user-password-matches?              user-password)<br>                                 :user-password-valid-f        #(my-validator/user-password-valid?               user-password)<br>                                 :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-user-id?    user-id)})))<br>=&gt;<br>{:body :performed-request/username-updated :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="qbe65fc43-8b98-4768-90bb-9cfd299b326a"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qba368bcb-2263-46c5-bc17-ba8443c8dcb5"><button class="snippet--header" onClick="toggleCollapsible(&apos;qba368bcb-2263-46c5-bc17-ba8443c8dcb5&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">functions</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :update-username-f (function)                 Side-effect function for updating the username. Applied when every security check has been passed. Must return TRUE if the username has been successfully updated.<br> :username-registered-f (function)(opt)        Must return TRUE if the received username is registered.<br> :username-valid-f (function)(opt)             Must return TRUE if the received username is valid.<br> :user-authenticated-f (function)(opt)         Must return TRUE the user is authenticated / logged in.<br> :user-exists-f (function)(opt)                Must return TRUE the user exists.<br> :user-password-correct-f (function)(opt)      Must return TRUE if the received user password is correct.<br> :user-password-valid-f (function)(opt)        Must return TRUE if the received user password is valid.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q843f731a-2de4-452b-8a63-161c72c49d59"><button class="snippet--header" onClick="toggleCollapsible(&apos;q843f731a-2de4-452b-8a63-161c72c49d59&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">return</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:body (namespaced keyword)<br>  :forbidden-request/invalid-username-received           (Invalid username has been received)<br>  :forbidden-request/invalid-user-password-received      (Invalid user password has been received)<br>  :forbidden-request/permission-denied                   (The user has no permission to do the action)<br>  :forbidden-request/registered-username-received        (Registered username has been received)<br>  :forbidden-request/user-not-exists                     (The user ID does not exist)<br>  :forbidden-request/user-unauthenticated                (The user is unauthenticated / not logged in)<br>  :invalid-request/invalid-ip-address                    (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                    (No valid user agent has been found in the request)<br>  :performed-request/username-updated                    (The server has been successfully updated the username)<br>  :server-error/unable-to-update-username                (The server cannot update the username)<br>  :too-many-requests/client-rate-limit-exceeded          (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded            (Too many actions have been attempted by the user in a specific timeframe)<br>  :unauthorized-request/incorrect-user-password-received (Incorrect user password has been received)<br>  :unknown-error/additional-action-stage-failed          (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed        (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 401, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="update-user-contact"><div class="section--header"><pre class="color--soft-grey text--xs text--uppercase">defn</pre><pre class="color--hard-blue text--xl text--bold">update-user-contact</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="qfeb3f203-0fef-4599-97d1-8e71e9a82237"><button class="snippet--header" onClick="toggleCollapsible(&apos;qfeb3f203-0fef-4599-97d1-8e71e9a82237&apos;)"><pre class="text--xs text--uppercase color--hard-grey ">source-code</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">(defn update-user-contact
  [request {:keys [additional-action-f
                   additional-security-f
                   client-rate-limit-exceeded-f
                   permission-granted-f
                   security-code-correct-f
                   security-code-device-matches-f
                   security-code-expired-f
                   security-code-sent-f
                   security-code-valid-f
                   update-user-contact-f
                   user-authenticated-f
                   user-contact-registered-f
                   user-contact-valid-f
                   user-exists-f
                   user-password-correct-f
                   user-password-valid-f
                   user-rate-limit-exceeded-f]}]
  (let [ip-address (http/request-&gt;ip-address request)
        user-agent (http/request-&gt;user-agent request)]
       (cond (not (audit/ip-address-valid? ip-address))                                    {:body :invalid-request/invalid-ip-address                    :status 400}
             (not (audit/user-agent-valid? user-agent))                                    {:body :invalid-request/invalid-user-agent                    :status 400}
             (and client-rate-limit-exceeded-f   (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded          :status 429}
             (and user-rate-limit-exceeded-f     (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded            :status 429}
             (and permission-granted-f           (not (permission-granted-f)))             {:body :forbidden-request/permission-denied                   :status 403}
             (and user-authenticated-f           (not (user-authenticated-f)))             {:body :forbidden-request/user-unauthenticated                :status 403}
             (and user-exists-f                  (not (user-exists-f)))                    {:body :forbidden-request/user-not-exists                     :status 403}
             (and user-password-valid-f          (not (user-password-valid-f)))            {:body :forbidden-request/invalid-user-password-received      :status 403}
             (and user-contact-valid-f           (not (user-contact-valid-f)))             {:body :forbidden-request/invalid-user-contact-received       :status 403}
             (and security-code-valid-f          (not (security-code-valid-f)))            {:body :forbidden-request/invalid-security-code-received      :status 403}
             (and user-contact-registered-f      (boolean (user-contact-registered-f)))    {:body :forbidden-request/registered-user-contact-received    :status 403}
             (and security-code-sent-f           (not (security-code-sent-f)))             {:body :forbidden-request/no-security-code-sent-in-timeframe  :status 403}
             (and security-code-device-matches-f (not (security-code-device-matches-f)))   {:body :forbidden-request/security-code-device-not-matches    :status 403}
             (and user-password-correct-f        (not (user-password-correct-f)))          {:body :unauthorized-request/incorrect-user-password-received :status 401}
             (and security-code-correct-f        (not (security-code-correct-f)))          {:body :unauthorized-request/incorrect-security-code-received :status 401}
             (and security-code-expired-f        (boolean (security-code-expired-f)))      {:body :unauthorized-request/expired-security-code-received   :status 401}
             (and additional-security-f          (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed        :status 520}
             (and additional-action-f            (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed          :status 520}
             (not (update-user-contact-f)) {:body :server-error/unable-to-update-user-contact :status 500}
             :user-contact-updated         {:body :performed-request/user-contact-updated     :status 200})))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qe84b2a15-4655-43c6-a6f0-37e716110354"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">description</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- Security protocol function for user contact (email address / phone number) update (for authenticated users) with optional user password<br>  and/or security code verification.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qbce7f20a-4397-4970-b49a-27ac5cbc1a9d"><div class="snippet--header"><pre class="text--xs text--uppercase color--hard-blue ">note</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qff49c950-5b82-4e68-b5d7-670013c647ec"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(update-user-contact {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q4bcfa6ea-a538-48ff-a464-83592d459dc0"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(update-user-contact {...} {...})<br>=&gt;<br>{:body :performed-request/user-contact-updated :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qdfcb3efd-5a1b-443b-b1e5-7e439fcc34f5"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        email-address (-&gt; request :params :email-address)<br>        user-password (-&gt; request :params :password)<br>        security-code (-&gt; request :params :security-code)<br>        user-id       (-&gt; request :session :user-id)]<br>       (update-user-contact request {:client-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-ip-address?                 ip-address)<br>                                     :security-code-correct-f        #(my-database/security-code-matches?                              user-id security-code)<br>                                     :security-code-device-matches-f #(my-log-service/security-code-required-from-the-same-ip-address? user-id ip-address)<br>                                     :security-code-expired-f        #(my-database/security-code-expired?                              user-id)<br>                                     :security-code-sent-f           #(my-database/security-code-sent?                                 user-id)<br>                                     :security-code-valid-f          #(my-validator/security-code-valid?                               security-code)<br>                                     :update-user-contact-f          #(my-database/update-user-email-address!                          user-id email-address)<br>                                     :user-authenticated-f           #(my-validator/request-has-valid-session?                         request)<br>                                     :user-contact-registered-f      #(my-database/email-address-registered?                           email-address)<br>                                     :user-contact-valid-f           #(my-validator/email-address-valid?                               email-address)<br>                                     :user-exists-f                  #(my-database/user-id-exists?                                     user-id)<br>                                     :user-password-correct-f        #(my-database/user-password-matches?                              user-password)<br>                                     :user-password-valid-f          #(my-validator/user-password-valid?                               user-password)<br>                                     :user-rate-limit-exceeded-f     #(my-log-service/too-many-attempts-by-user-id?                    user-id)})))<br>=&gt;<br>{:body :performed-request/user-contact-updated :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="q8abe94c9-eaba-4cf4-baaf-3a1192d64bb4"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q6be82811-95cc-450c-ac91-fa4827586635"><button class="snippet--header" onClick="toggleCollapsible(&apos;q6be82811-95cc-450c-ac91-fa4827586635&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">functions</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:additional-action-f (function)(opt)            Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)          Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :security-code-correct-f (function)(opt)        Must return TRUE if the received security code is correct.<br> :permission-granted-f (function)(opt)           Must return TRUE if the user has permission to do the action.<br> :security-code-device-matches-f (function)(opt) Must return TRUE if the received security code has been required from the same device.<br> :security-code-expired-f (function)(opt)        Must return TRUE if the received security code has been expired.<br> :security-code-sent-f (function)(opt)           Must return TRUE if a security code has been sent.<br> :security-code-valid-f (function)(opt)          Must return TRUE if the received security code is valid.<br> :update-user-contact-f (function)               Side-effect function for updating the user contact. Applied when every security check has been passed. Must return TRUE if the user contact (email address / phone number) has been successfully updated.<br> :user-authenticated-f (function)(opt)           Must return TRUE the user is authenticated / logged in.<br> :user-contact-registered-f (function)(opt)      Must return TRUE if the received user contact (email address / phone number) is registered.<br> :user-contact-valid-f (function)(opt)           Must return TRUE if the received user contact (email address / phone number) is valid.<br> :user-exists-f (function)(opt)                  Must return TRUE the user exists.<br> :user-password-correct-f (function)(opt)        Must return TRUE if the received user password is correct.<br> :user-password-valid-f (function)(opt)          Must return TRUE if the received user password is valid.<br> :user-rate-limit-exceeded-f (function)(opt)     Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q2a5db96b-7988-429f-851f-421d6115402a"><button class="snippet--header" onClick="toggleCollapsible(&apos;q2a5db96b-7988-429f-851f-421d6115402a&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">return</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:body (namespaced keyword)<br>  :forbidden-request/invalid-user-contact-received       (Invalid user contact (email address / phone number) has been received)<br>  :forbidden-request/invalid-security-code-received      (Invalid security code has been received)<br>  :forbidden-request/invalid-user-password-received      (Invalid user password has been received)<br>  :forbidden-request/no-security-code-sent-in-timeframe  (No security code has been sent in a specific timeframe)<br>  :forbidden-request/permission-denied                   (The user has no permission to do the action)<br>  :forbidden-request/registered-user-contact-received    (Registered user contact (email address / phone number) has been received)<br>  :forbidden-request/security-code-device-not-matches    (The received security code has been required from another device)<br>  :forbidden-request/user-not-exists                     (The user ID does not exist)<br>  :forbidden-request/user-unauthenticated                (The user is unauthenticated / not logged in)<br>  :invalid-request/invalid-ip-address                    (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                    (No valid user agent has been found in the request)<br>  :performed-request/user-contact-updated                (The server has been successfully updated the user's email address / phone number)<br>  :server-error/unable-to-update-user-contact            (The server cannot update the user's email address / phone number)<br>  :too-many-requests/client-rate-limit-exceeded          (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded            (Too many actions have been attempted by the user in a specific timeframe)<br>  :unauthorized-request/expired-security-code-received   (Expired security code has been received)<br>  :unauthorized-request/incorrect-security-code-received (Incorrect security code has been received)<br>  :unauthorized-request/incorrect-user-password-received (Incorrect user password has been received)<br>  :unknown-error/additional-action-stage-failed          (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed        (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 401, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="update-user-data"><div class="section--header"><pre class="color--soft-grey text--xs text--uppercase">defn</pre><pre class="color--hard-blue text--xl text--bold">update-user-data</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q7b16e2c1-187b-4236-9a88-119a1a20e19e"><button class="snippet--header" onClick="toggleCollapsible(&apos;q7b16e2c1-187b-4236-9a88-119a1a20e19e&apos;)"><pre class="text--xs text--uppercase color--hard-grey ">source-code</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">(defn update-user-data
  [request {:keys [additional-action-f
                   additional-security-f
                   client-rate-limit-exceeded-f
                   permission-granted-f
                   update-user-data-f
                   user-authenticated-f
                   user-data-valid-f
                   user-exists-f
                   user-rate-limit-exceeded-f]}]
  (let [ip-address (http/request-&gt;ip-address request)
        user-agent (http/request-&gt;user-agent request)]
       (cond (not (audit/ip-address-valid? ip-address))                                  {:body :invalid-request/invalid-ip-address             :status 400}
             (not (audit/user-agent-valid? user-agent))                                  {:body :invalid-request/invalid-user-agent             :status 400}
             (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded   :status 429}
             (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded     :status 429}
             (and permission-granted-f         (not (permission-granted-f)))             {:body :forbidden-request/permission-denied            :status 403}
             (and user-authenticated-f         (not (user-authenticated-f)))             {:body :forbidden-request/user-unauthenticated         :status 403}
             (and user-exists-f                (not (user-exists-f)))                    {:body :forbidden-request/user-not-exists              :status 403}
             (and user-data-valid-f            (not (user-data-valid-f)))                {:body :forbidden-request/invalid-user-data-received   :status 403}
             (and additional-security-f        (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed :status 520}
             (and additional-action-f          (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed   :status 520}
             (not (update-user-data-f)) {:body :server-error/unable-to-update-user-data :status 500}
             :user-account-updated      {:body :performed-request/user-data-updated     :status 200})))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q222b5646-cebc-43d2-b47d-75c656ccf56d"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">description</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- Security protocol function for user data update (for authenticated users).<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qcffed165-86e9-45e3-a3d7-6ac0cc983f79"><div class="snippet--header"><pre class="text--xs text--uppercase color--hard-blue ">note</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- For updating user contact data (email address / phone number), or username, or user password use (the) specific protocol functions for these actions!<br>- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qde9c0d70-eb89-4bf2-afa2-71b947bdb781"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(update-user-data {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qcac993d6-00af-4249-9b50-9a2b9c89d5b8"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(update-user-data {...} {...})<br>=&gt;<br>{:body :performed-request/user-data-updated :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q407e15eb-0d0e-4ef0-b6e8-82c719c6cfa5"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(defn my-route<br>  [request]<br>  (let [ip-address (-&gt; request :remote-addr)<br>        user-data  (-&gt; request :params)<br>        user-id    (-&gt; request :session :user-id)]<br>       (update-user-data request {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address? ip-address)<br>                                  :update-user-data-f           #(my-database/update-user-data!                   user-id user-data)<br>                                  :user-authenticated-f         #(my-validator/request-has-valid-session?         request)<br>                                  :user-data-valid-f            #(my-validator/user-data-valid?                   user-data)<br>                                  :user-exists-f                #(my-database/user-id-exists?                     user-id)<br>                                  :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-user-id?    user-id)})))<br>=&gt;<br>{:body :performed-request/user-data-updated :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="qd9bebf2d-b6ed-40d1-a5e8-35fff9b17568"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q027e77e7-27c9-4a5e-ade7-eff94f6246fe"><button class="snippet--header" onClick="toggleCollapsible(&apos;q027e77e7-27c9-4a5e-ade7-eff94f6246fe&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">functions</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :update-user-data-f (function)                Side-effect function for updating the user data. Applied when every security check has been passed. Must return TRUE if the user data has been successfully updated.<br> :user-authenticated-f (function)(opt)         Must return TRUE the user is authenticated / logged in.<br> :user-data-valid-f (function)(opt)            Must return TRUE if the received user data is valid.<br> :user-exists-f (function)(opt)                Must return TRUE the user exists.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qfccdafdc-3c94-493a-b76a-2a40a2555e24"><button class="snippet--header" onClick="toggleCollapsible(&apos;qfccdafdc-3c94-493a-b76a-2a40a2555e24&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">return</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:body (namespaced keyword)<br>  :forbidden-request/invalid-user-data-received   (Invalid user data has been received)<br>  :forbidden-request/permission-denied            (The user has no permission to do the action)<br>  :forbidden-request/user-not-exists              (The user ID does not exist)<br>  :forbidden-request/user-unauthenticated         (The user is unauthenticated / not logged in)<br>  :invalid-request/invalid-ip-address             (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent             (No valid user agent has been found in the request)<br>  :performed-request/user-data-updated            (The server has been successfully updated the user data)<br>  :server-error/unable-to-update-user-data        (The server cannot update the user data)<br>  :too-many-requests/client-rate-limit-exceeded   (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded     (Too many actions have been attempted by the user in a specific timeframe)<br>  :unknown-error/additional-action-stage-failed   (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="verify-security-code-authenticated"><div class="section--header"><pre class="color--soft-grey text--xs text--uppercase">defn</pre><pre class="color--hard-blue text--xl text--bold">verify-security-code-authenticated</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q75fc1827-b5ca-4a49-a230-8c6d85438f9e"><button class="snippet--header" onClick="toggleCollapsible(&apos;q75fc1827-b5ca-4a49-a230-8c6d85438f9e&apos;)"><pre class="text--xs text--uppercase color--hard-grey ">source-code</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">(defn verify-security-code-authenticated
  [request {:keys [additional-action-f
                   additional-security-f
                   client-rate-limit-exceeded-f
                   permission-granted-f
                   security-code-correct-f
                   security-code-device-matches-f
                   security-code-expired-f
                   security-code-sent-f
                   security-code-valid-f
                   user-authenticated-f
                   user-exists-f
                   user-rate-limit-exceeded-f]}]
  (let [ip-address (http/request-&gt;ip-address request)
        user-agent (http/request-&gt;user-agent request)]
       (cond (not (audit/ip-address-valid? ip-address))                                    {:body :invalid-request/invalid-ip-address                   :status 400}
             (not (audit/user-agent-valid? user-agent))                                    {:body :invalid-request/invalid-user-agent                   :status 400}
             (and client-rate-limit-exceeded-f   (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded         :status 429}
             (and user-rate-limit-exceeded-f     (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded           :status 429}
             (and permission-granted-f           (not (permission-granted-f)))             {:body :forbidden-request/permission-denied                  :status 403}
             (and user-authenticated-f           (not (user-authenticated-f)))             {:body :forbidden-request/user-unauthenticated               :status 403}
             (and user-exists-f                  (not (user-exists-f)))                    {:body :forbidden-request/user-not-exists                    :status 403}
             (and security-code-valid-f          (not (security-code-valid-f)))            {:body :forbidden-request/invalid-security-code-received     :status 403}
             (and security-code-sent-f           (not (security-code-sent-f)))             {:body :forbidden-request/no-security-code-sent-in-timeframe :status 403}
             (and security-code-device-matches-f (not (security-code-device-matches-f)))   {:body :forbidden-request/security-code-device-not-matches   :status 403}
             (and security-code-expired-f        (boolean (security-code-expired-f)))      {:body :unauthorized-request/expired-security-code-received  :status 401}
             (and additional-security-f          (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed       :status 520}
             (and additional-action-f            (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed         :status 520}
             (not (security-code-correct-f)) {:body :unauthorized-request/incorrect-security-code-received :status 401}
             :security-code-verified         {:body :performed-request/correct-security-code-received      :status 200})))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q45cf7dd5-ad89-4b35-909f-df9449d996b0"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">description</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- Security protocol function for verifying a security code (for authenticated users) sent via email / SMS.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qcdcb5a18-f8d3-4194-b433-94697d3d0af0"><div class="snippet--header"><pre class="text--xs text--uppercase color--hard-blue ">note</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q453f413f-9d49-4b1f-88b9-a8517ac9c837"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(verify-security-code-authenticated {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q80b24d7a-356b-4a12-9c84-18ca0e56baef"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(verify-security-code-authenticated {...} {...})<br>=&gt;<br>{:body :performed-request/correct-security-code-received :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q92fbdf5b-b1c5-401b-ac51-fc3d7210c669"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        security-code (-&gt; request :params :security-code)<br>        user-id       (-&gt; request :session :user-id)]<br>       (verify-security-code-authenticated request {:client-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-ip-address?                 ip-address)<br>                                                    :security-code-correct-f        #(my-database/security-code-matches?                              user-id security-code)<br>                                                    :security-code-expired-f        #(my-database/security-code-expired?                              user-id)<br>                                                    :security-code-device-matches-f #(my-log-service/security-code-required-from-the-same-ip-address? user-id ip-address)<br>                                                    :security-code-sent-f           #(my-database/security-code-sent?                                 user-id)<br>                                                    :security-code-valid-f          #(my-validator/security-code-valid?                               security-code)<br>                                                    :user-authenticated-f           #(my-validator/request-has-valid-session?                         request)<br>                                                    :user-exists-f                  #(my-database/user-id-exists?                                     user-id)<br>                                                    :user-rate-limit-exceeded-f     #(my-log-service/too-many-attempts-by-user-id?                    user-id)})))<br>=&gt;<br>{:body :performed-request/correct-security-code-received :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="qa2127850-1104-4fe8-a7a2-088fdbdc4287"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q48be0bed-072d-4284-b955-09a9cde8baa2"><button class="snippet--header" onClick="toggleCollapsible(&apos;q48be0bed-072d-4284-b955-09a9cde8baa2&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">functions</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:additional-action-f (function)(opt)            Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)          Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :permission-granted-f (function)(opt)           Must return TRUE if the user has permission to do the action.<br> :security-code-correct-f (function)             Must return TRUE if the received security code is correct.<br> :security-code-device-matches-f (function)(opt) Must return TRUE if the received security code has been required from the same device.<br> :security-code-expired-f (function)(opt)        Must return TRUE if the received security code has been expired.<br> :security-code-sent-f (function)(opt)           Must return TRUE if a security code has been sent.<br> :security-code-valid-f (function)(opt)          Must return TRUE if the received security code is valid.<br> :user-authenticated-f (function)(opt)           Must return TRUE the user is authenticated / logged in.<br> :user-exists-f (function)(opt)                  Must return TRUE the user exists.<br> :user-rate-limit-exceeded-f (function)(opt)     Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q51ff1f6c-773e-4302-8012-20853ac0b6f0"><button class="snippet--header" onClick="toggleCollapsible(&apos;q51ff1f6c-773e-4302-8012-20853ac0b6f0&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">return</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:body (namespaced keyword)<br>  :forbidden-request/invalid-security-code-received      (Invalid security code has been received)<br>  :forbidden-request/no-security-code-sent-in-timeframe  (No security code has been sent in a specific timeframe)<br>  :forbidden-request/permission-denied                   (The user has no permission to do the action)<br>  :forbidden-request/security-code-device-not-matches    (The received security code has been required from another device)<br>  :forbidden-request/user-not-exists                     (The user ID does not exist)<br>  :forbidden-request/user-unauthenticated                (The user is unauthenticated / not logged in)<br>  :invalid-request/invalid-ip-address                    (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                    (No valid user agent has been found in the request)<br>  :performed-request/correct-security-code-received      (Correct security code has been received)<br>  :too-many-requests/client-rate-limit-exceeded          (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded            (Too many actions have been attempted by the user in a specific timeframe)<br>  :unauthorized-request/incorrect-security-code-received (Incorrect security code has been received)<br>  :unauthorized-request/expired-security-code-received   (Expired security code has been received)<br>  :unknown-error/additional-action-stage-failed          (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed        (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 401, 403, 429, 520}</pre></div></div></div></div><div class="section" id="verify-security-code-unauthenticated"><div class="section--header"><pre class="color--soft-grey text--xs text--uppercase">defn</pre><pre class="color--hard-blue text--xl text--bold">verify-security-code-unauthenticated</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q8200c001-4310-47d3-b0ed-909d6554a29e"><button class="snippet--header" onClick="toggleCollapsible(&apos;q8200c001-4310-47d3-b0ed-909d6554a29e&apos;)"><pre class="text--xs text--uppercase color--hard-grey ">source-code</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">(defn verify-security-code-unauthenticated
  [request {:keys [additional-action-f
                   additional-security-f
                   client-rate-limit-exceeded-f
                   permission-granted-f
                   provide-user-session-f
                   security-code-correct-f
                   security-code-device-matches-f
                   security-code-expired-f
                   security-code-sent-f
                   security-code-valid-f
                   user-authenticated-f
                   user-identifier-registered-f
                   user-identifier-valid-f
                   user-identifier-verified-f
                   user-password-correct-f
                   user-password-valid-f
                   user-rate-limit-exceeded-f]}]
  (let [ip-address (http/request-&gt;ip-address request)
        user-agent (http/request-&gt;user-agent request)]
       (cond (not (audit/ip-address-valid? ip-address))                                    {:body :invalid-request/invalid-ip-address                      :status 400}
             (not (audit/user-agent-valid? user-agent))                                    {:body :invalid-request/invalid-user-agent                      :status 400}
             (and client-rate-limit-exceeded-f   (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded            :status 429}
             (and user-rate-limit-exceeded-f     (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded              :status 429}
             (and permission-granted-f           (not (permission-granted-f)))             {:body :forbidden-request/permission-denied                     :status 403}
             (and user-authenticated-f           (boolean (user-authenticated-f)))         {:body :forbidden-request/user-authenticated                    :status 403}
             (and user-identifier-valid-f        (not (user-identifier-valid-f)))          {:body :forbidden-request/invalid-user-identifier-received      :status 403}
             (and user-password-valid-f          (not (user-password-valid-f)))            {:body :forbidden-request/invalid-user-password-received        :status 403}
             (and security-code-valid-f          (not (security-code-valid-f)))            {:body :forbidden-request/invalid-security-code-received        :status 403}
             (and security-code-sent-f           (not (security-code-sent-f)))             {:body :forbidden-request/no-security-code-sent-in-timeframe    :status 403}
             (and user-identifier-registered-f   (not (user-identifier-registered-f)))     {:body :forbidden-request/unregistered-user-identifier-received :status 403}
             (and security-code-device-matches-f (not (security-code-device-matches-f)))   {:body :forbidden-request/security-code-device-not-matches      :status 403}
             (and user-identifier-verified-f     (not (user-identifier-verified-f)))       {:body :forbidden-request/unverified-user-identifier-received   :status 403}
             (and user-password-correct-f        (not (user-password-correct-f)))          {:body :unauthorized-request/incorrect-user-password-received   :status 401}
             (and security-code-expired-f        (boolean (security-code-expired-f)))      {:body :unauthorized-request/expired-security-code-received     :status 401}
             (and additional-security-f          (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed          :status 520}
             (and additional-action-f            (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed            :status 520}
             (not (security-code-correct-f)) {:body :unauthorized-request/incorrect-security-code-received :status 401}
             (not provide-user-session-f)    {:body :performed-request/correct-security-code-received      :status 200}
             :providing-user-session         (if-let [response (provide-user-session-f {:body :performed-request/ready-to-provide-user-session :status 200})]
                                                     (-&gt;&gt; {:body :performed-request/user-session-provided     :status 200} (merge response))
                                                     (-&gt;  {:body :server-error/unable-to-provide-user-session :status 500})))))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qbd549a2a-567b-4f04-bd51-c3afeef2de2f"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">description</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- Security protocol function for verifying a security code (for unauthenticated users) sent via email / SMS.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qdd33d6de-bee6-4c56-82ee-cef48f7b7bec"><div class="snippet--header"><pre class="text--xs text--uppercase color--hard-blue ">note</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).<br>- In case the 'provide-user-session-f' function is passed, no security check has been failed, and the received security code is correct,<br>  it applies the 'provide-user-session-f' function on the HTTP response.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q68f3b9e9-d3a5-4fb6-a4d1-d2e109314490"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(verify-security-code-unauthenticated {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q8aab2c34-fa91-4b98-9dbf-4c9d06870ee5"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(verify-security-code-unauthenticated {...} {...})<br>=&gt;<br>{:body :performed-request/correct-security-code-received :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q05b19ef4-35b9-413c-8b52-e9ac91c4fa4c"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        email-address (-&gt; request :params :email-address)<br>        user-password (-&gt; request :params :password)<br>        security-code (-&gt; request :params :security-code)]<br>       (verify-security-code-unauthenticated request {:client-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-ip-address?                 ip-address)<br>                                                      :provide-user-session-f         #(my-session-handler/add-session-to-response                      %)<br>                                                      :security-code-correct-f        #(my-database/security-code-matches?                              email-address security-code)<br>                                                      :security-code-device-matches-f #(my-log-service/security-code-required-from-the-same-ip-address? email-address ip-address)<br>                                                      :security-code-expired-f        #(my-database/security-code-expired?                              email-address)<br>                                                      :security-code-sent-f           #(my-database/security-code-sent?                                 email-address)<br>                                                      :security-code-valid-f          #(my-validator/security-code-valid?                               security-code)<br>                                                      :user-authenticated-f           #(my-validator/request-has-valid-session?                         request)<br>                                                      :user-identifier-registered-f   #(my-database/email-address-registered?                           email-address)<br>                                                      :user-identifier-valid-f        #(my-validator/email-address-valid?                               email-address)<br>                                                      :user-identifier-verified-f     #(my-database/email-address-verified?                             email-address)<br>                                                      :user-password-correct-f        #(my-database/user-password-matches?                              user-password)<br>                                                      :user-password-valid-f          #(my-validator/user-password-valid?                               user-password)<br>                                                      :user-rate-limit-exceeded-f     #(my-log-service/too-many-attempts-by-email-address?              email-address)})))<br>=&gt;<br>{:body :performed-request/correct-security-code-received :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="q642decec-8f47-47f7-ac9a-8e0aff57e7fa"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q66e4fc03-318c-4dc4-9027-28f623b3ed4b"><button class="snippet--header" onClick="toggleCollapsible(&apos;q66e4fc03-318c-4dc4-9027-28f623b3ed4b&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">functions</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:additional-action-f (function)(opt)            Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)          Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :permission-granted-f (function)(opt)           Must return TRUE if the user has permission to do the action.<br> :provide-user-session-f (function)(opt)         Must take the response as parameter, and associate a user session to it (return NIL in case of error).<br> :security-code-correct-f (function)             Must return TRUE if the received security code is correct.<br> :security-code-device-matches-f (function)(opt) Must return TRUE if the received security code has been required from the same device.<br> :security-code-expired-f (function)(opt)        Must return TRUE if the received security code has been expired.<br> :security-code-sent-f (function)(opt)           Must return TRUE if a security code has been sent.<br> :security-code-valid-f (function)(opt)          Must return TRUE if the received security code is valid.<br> :user-authenticated-f (function)(opt)           Must return TRUE the user is authenticated / logged in.<br> :user-identifier-registered-f (function)(opt)   Must return TRUE if the received user identifier (email address / phone number / username) is registered.<br> :user-identifier-valid-f (function)(opt)        Must return TRUE if the received user identifier (email address / phone number / username) is valid.<br> :user-identifier-verified-f (function)(opt)     Must return TRUE if the received user identifier (if contact: email address / phone number) is verified.<br> :user-password-correct-f (function)(opt)        Must return TRUE if the received user password is correct.<br> :user-password-valid-f (function)(opt)          Must return TRUE if the received user password is valid.<br> :user-rate-limit-exceeded-f (function)(opt)     Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q8d8f108b-864e-46b1-aea4-178b1b01bbdc"><button class="snippet--header" onClick="toggleCollapsible(&apos;q8d8f108b-864e-46b1-aea4-178b1b01bbdc&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">return</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:body (namespaced keyword)<br>  :forbidden-request/invalid-security-code-received        (Invalid security code has been received)<br>  :forbidden-request/invalid-user-identifier-received      (Invalid user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/invalid-user-password-received        (Invalid user password has been received)<br>  :forbidden-request/no-security-code-sent-in-timeframe    (No security code has been sent in a specific timeframe)<br>  :forbidden-request/permission-denied                     (The user has no permission to do the action)<br>  :forbidden-request/security-code-device-not-matches      (The received security code has been required from another device)<br>  :forbidden-request/unregistered-user-identifier-received (Unregistered user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/user-authenticated                    (The user is authenticated / logged in)<br>  :invalid-request/invalid-ip-address                      (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                      (No valid user agent has been found in the request)<br>  :performed-request/correct-security-code-received        (Correct security code has been received)<br>  :performed-request/user-session-provided                 (The server has been successfully provided a user session to the HTTP response)<br>  :server-error/unable-to-provide-user-session             (The server cannot provide the user session to the HTTP response)<br>  :too-many-requests/client-rate-limit-exceeded            (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded              (Too many actions have been attempted by the user in a specific timeframe)<br>  :unauthorized-request/expired-security-code-received     (Expired security code has been received)<br>  :unauthorized-request/incorrect-security-code-received   (Incorrect security code has been received)<br>  :unauthorized-request/incorrect-user-password-received   (Incorrect user password has been received)<br>  :unknown-error/additional-action-stage-failed            (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed          (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 401, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="verify-user-password"><div class="section--header"><pre class="color--soft-grey text--xs text--uppercase">defn</pre><pre class="color--hard-blue text--xl text--bold">verify-user-password</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="qc7a11303-8862-40e1-ab48-d59cb1ed84bf"><button class="snippet--header" onClick="toggleCollapsible(&apos;qc7a11303-8862-40e1-ab48-d59cb1ed84bf&apos;)"><pre class="text--xs text--uppercase color--hard-grey ">source-code</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">(defn verify-user-password
  [request {:keys [additional-action-f
                   additional-security-f
                   client-rate-limit-exceeded-f
                   permission-granted-f
                   provide-user-session-f
                   send-security-code-f
                   user-authenticated-f
                   user-identifier-registered-f
                   user-identifier-valid-f
                   user-identifier-verified-f
                   user-password-correct-f
                   user-password-valid-f
                   user-rate-limit-exceeded-f]}]
  (let [ip-address (http/request-&gt;ip-address request)
        user-agent (http/request-&gt;user-agent request)]
       (cond (not (audit/ip-address-valid? ip-address))                                  {:body :invalid-request/invalid-ip-address                      :status 400}
             (not (audit/user-agent-valid? user-agent))                                  {:body :invalid-request/invalid-user-agent                      :status 400}
             (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded            :status 429}
             (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded              :status 429}
             (and permission-granted-f         (not (permission-granted-f)))             {:body :forbidden-request/permission-denied                     :status 403}
             (and user-authenticated-f         (boolean (user-authenticated-f)))         {:body :forbidden-request/user-authenticated                    :status 403}
             (and user-identifier-valid-f      (not (user-identifier-valid-f)))          {:body :forbidden-request/invalid-user-identifier-received      :status 403}
             (and user-password-valid-f        (not (user-password-valid-f)))            {:body :forbidden-request/invalid-user-password-received        :status 403}
             (and user-identifier-registered-f (not (user-identifier-registered-f)))     {:body :forbidden-request/unregistered-user-identifier-received :status 403}
             (and user-identifier-verified-f   (not (user-identifier-verified-f)))       {:body :forbidden-request/unverified-user-identifier-received   :status 403}
             (and additional-security-f        (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed          :status 520}
             (and additional-action-f          (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed            :status 520}
             (not (user-password-correct-f))                         {:body :unauthorized-request/incorrect-user-password-received :status 401}
             (and send-security-code-f (not (send-security-code-f))) {:body :server-error/unable-to-send-security-code             :status 500}
             (and send-security-code-f)                              {:body :performed-request/security-code-sent                  :status 200}
             (not provide-user-session-f)                            {:body :performed-request/correct-user-password-received      :status 200}
             :providing-user-session                                 (if-let [response (provide-user-session-f {:body :performed-request/ready-to-provide-user-session :status 200})]
                                                                             (-&gt;&gt; {:body :performed-request/user-session-provided     :status 200} (merge response))
                                                                             (-&gt;  {:body :server-error/unable-to-provide-user-session :status 500})))))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q2ff509fc-ecb5-4187-95d6-f8558b56ec2f"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">description</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- Security protocol function for user password verification (for unauthenticated users) and in case of correct user password has been<br>  received optionally sending an MFA security code / providing a user session.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q6a444281-7dc0-4d21-816e-f28ff190aca3"><div class="snippet--header"><pre class="text--xs text--uppercase color--hard-blue ">note</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).<br>- In case the 'send-security-code-f' function is passed, no security check has been failed, and the received user password is correct,<br>  it applies the 'send-security-code-f' (it's a common scenario when the user credentials verification is followed by login code verification).<br>- In case the 'provide-user-session-f' function is passed, the 'send-security-code-f' function is NOT passed, no security check has<br>  been failed, and the received user password is correct, it applies the 'provide-user-session-f' function on the HTTP response.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q2fa8c9e5-344f-4cfb-93c4-0ab97b508858"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(verify-user-password {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qf26bda77-db09-4fc3-8791-14f271b25c7b"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(verify-user-password {...} {...})<br>=&gt;<br>{:body :performed-request/security-code-sent :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q6f9616c0-a4b7-4936-8c1e-0c0a65c165d6"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        email-address (-&gt; request :params :email-address)<br>        user-password (-&gt; request :params :password)]<br>       (verify-user-password request {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address?    ip-address)<br>                                      :provide-user-session-f       #(my-session-handler/add-session-to-response         %)<br>                                      :send-security-code-f         #(my-email-service/send-security-code-email!         email-address)<br>                                      :user-authenticated-f         #(my-validator/request-has-valid-session?            request)<br>                                      :user-identifier-registered-f #(my-database/email-address-registered?              email-address)<br>                                      :user-identifier-valid-f      #(my-validator/email-address-valid?                  email-address)<br>                                      :user-identifier-verified-f   #(my-database/email-address-verified?                email-address)<br>                                      :user-password-correct-f      #(my-database/user-password-matches?                 user-password)<br>                                      :user-password-valid-f        #(my-validator/user-password-valid?                  user-password)<br>                                      :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-email-address? email-address)})))<br>=&gt;<br>{:body :performed-request/security-code-sent :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="q3dbea0c3-c23d-4d5e-9b84-f52977600ada"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q4171795a-1a8d-442c-8b5c-e6202f7f13a3"><button class="snippet--header" onClick="toggleCollapsible(&apos;q4171795a-1a8d-442c-8b5c-e6202f7f13a3&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">functions</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :provide-user-session-f (function)(opt)       Must take the response as parameter, and associate a user session to it (return NIL in case of error).<br> :send-security-code-f (function)(opt)         Must return TRUE if the security code email / SMS has been successfully sent.<br> :user-authenticated-f (function)(opt)         Must return TRUE the user is authenticated / logged in.<br> :user-identifier-registered-f (function)(opt) Must return TRUE if the received user identifier (email address / phone number / username) is registered.<br> :user-identifier-valid-f (function)(opt)      Must return TRUE if the received user identifier (email address / phone number / username) is valid.<br> :user-identifier-verified-f (function)(opt)   Must return TRUE if the received user identifier (if contact: email address / phone number) is verified.<br> :user-password-correct-f (function)(opt)      Must return TRUE if the received user password are correct.<br> :user-password-valid-f (function)(opt)        Must return TRUE if the received user password is valid.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q60eaffd7-5033-4a7c-b8b8-75087d62b404"><button class="snippet--header" onClick="toggleCollapsible(&apos;q60eaffd7-5033-4a7c-b8b8-75087d62b404&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">return</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:body (namespaced keyword)<br>  :forbidden-request/invalid-user-identifier-received      (Invalid user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/invalid-user-password-received        (Invalid user password has been received)<br>  :forbidden-request/permission-denied                     (The user has no permission to do the action)<br>  :forbidden-request/unregistered-user-identifier-received (Unregistered user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/unverified-user-identifier-received   (Unverified user identifier (if contact: email address / phone number) has been received)<br>  :forbidden-request/user-authenticated                    (The user is authenticated / logged in)<br>  :invalid-request/invalid-ip-address                      (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                      (No valid user agent has been found in the request)<br>  :performed-request/correct-user-password-received        (Correct user password has been received)<br>  :performed-request/security-code-sent                    (The server has been successfully sent the security code email / SMS to the user)<br>  :performed-request/user-session-provided                 (The server has been successfully provided a user session to the HTTP response)<br>  :server-error/unable-to-provide-user-session             (The server cannot provide the user session to the HTTP response)<br>  :server-error/unable-to-send-security-code               (The server cannot send the security code email / SMS to the user)<br>  :too-many-requests/client-rate-limit-exceeded            (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded              (Too many actions have been attempted by the user in a specific timeframe)<br>  :unauthorized-request/incorrect-user-password-received   (Incorrect user password has been received)<br>  :unknown-error/additional-action-stage-failed            (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed          (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 401, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="verify-user-pin-code"><div class="section--header"><pre class="color--soft-grey text--xs text--uppercase">defn</pre><pre class="color--hard-blue text--xl text--bold">verify-user-pin-code</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q5d86bf53-ac7f-4954-a15c-bd093a8afd11"><button class="snippet--header" onClick="toggleCollapsible(&apos;q5d86bf53-ac7f-4954-a15c-bd093a8afd11&apos;)"><pre class="text--xs text--uppercase color--hard-grey ">source-code</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">(defn verify-user-pin-code
  [request {:keys [additional-action-f
                   additional-security-f
                   client-rate-limit-exceeded-f
                   permission-granted-f
                   user-authenticated-f
                   user-exists-f
                   user-pin-code-correct-f
                   user-pin-code-valid-f
                   user-rate-limit-exceeded-f]}]
  (let [ip-address (http/request-&gt;ip-address request)
        user-agent (http/request-&gt;user-agent request)]
       (cond (not (audit/ip-address-valid? ip-address))                                  {:body :invalid-request/invalid-ip-address               :status 400}
             (not (audit/user-agent-valid? user-agent))                                  {:body :invalid-request/invalid-user-agent               :status 400}
             (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded     :status 429}
             (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded       :status 429}
             (and permission-granted-f         (not (permission-granted-f)))             {:body :forbidden-request/permission-denied              :status 403}
             (and user-authenticated-f         (not (user-authenticated-f)))             {:body :forbidden-request/user-unauthenticated           :status 403}
             (and user-exists-f                (not (user-exists-f)))                    {:body :forbidden-request/user-not-exists                :status 403}
             (and user-pin-code-valid-f        (not (user-pin-code-valid-f)))            {:body :forbidden-request/invalid-user-pin-code-received :status 403}
             (and additional-security-f        (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed   :status 520}
             (and additional-action-f          (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed     :status 520}
             (not (user-pin-code-correct-f)) {:body :unauthorized-request/incorrect-user-pin-code-received :status 401}
             :user-pin-code-verified         {:body :performed-request/correct-user-pin-code-received      :status 200})))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qf9137fd2-b676-4d93-a677-df3c0500005f"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">description</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- Security protocol function for user PIN code verification (for authenticated users).<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q4e1af6bc-2ece-4fd2-8736-77377fa2f78d"><div class="snippet--header"><pre class="text--xs text--uppercase color--hard-blue ">note</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey text--wrap">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q3fc308d0-aa7c-4f32-a68e-c9b9dfce7c17"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(verify-user-pin-code {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qc5927395-d32a-48b6-8920-2073e554da6b"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(verify-user-pin-code {...} {...})<br>=&gt;<br>{:body :performed-request/correct-user-pin-code-received :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q75ed6cb7-c927-4256-8e72-a5d140a2ce79"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">usage</pre></div><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        user-pin-code (-&gt; request :params :pin-code)<br>        user-id       (-&gt; request :session :user-id)]<br>       (verify-user-pin-code request {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address? ip-address)<br>                                      :user-authenticated-f         #(my-validator/request-has-valid-session?         request)<br>                                      :user-exists-f                #(my-database/user-id-exists?                     user-id)<br>                                      :user-pin-code-correct-f      #(my-database/user-pin-code-matches?              user-pin-code)<br>                                      :user-pin-code-valid-f        #(my-validator/user-pin-code-valid?               user-pin-code)<br>                                      :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-user-id?    user-id)})))<br>=&gt;<br>{:body :performed-request/correct-user-pin-code-received :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="q86e32d66-9106-45c9-8581-d8cbc63a941f"><div class="snippet--header"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q846bf430-f026-4bc2-8f9b-4faddcfa6acf"><button class="snippet--header" onClick="toggleCollapsible(&apos;q846bf430-f026-4bc2-8f9b-4faddcfa6acf&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">param</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre><pre class="text--xs text--uppercase text--bold color--hard-grey">functions</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :user-authenticated-f (function)(opt)         Must return TRUE the user is authenticated / logged in.<br> :user-exists-f (function)(opt)                Must return TRUE the user exists.<br> :user-pin-code-correct-f (function)           Must return TRUE if the received user PIN code is correct.<br> :user-pin-code-valid-f (function)(opt)        Must return TRUE if the received user PIN code is valid.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q5eb40716-b5c2-46ea-992a-c581ef38bb64"><button class="snippet--header" onClick="toggleCollapsible(&apos;q5eb40716-b5c2-46ea-992a-c581ef38bb64&apos;)"><pre class="text--xs text--uppercase color--soft-grey ">return</pre><pre class="text--xs text--uppercase color--soft-grey">map</pre></button><div class="snippet--text"><pre class="text--s text--boxed color--hard-grey scroll-x">{:body (namespaced keyword)<br>  :forbidden-request/invalid-user-pin-code-received      (Invalid user PIN code has been received)<br>  :forbidden-request/permission-denied                   (The user has no permission to do the action)<br>  :forbidden-request/user-not-exists                     (The user ID does not exist)<br>  :forbidden-request/user-unauthenticated                (The user is unauthenticated / not logged in)<br>  :invalid-request/invalid-ip-address                    (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                    (No valid user agent has been found in the request)<br>  :performed-request/correct-user-pin-code-received      (Correct user PIN code has been received)<br>  :too-many-requests/client-rate-limit-exceeded          (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded            (Too many actions have been attempted by the user in a specific timeframe)<br>  :unauthorized-request/incorrect-user-pin-code-received (Incorrect user PIN code has been received)<br>  :unknown-error/additional-action-stage-failed          (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed        (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 401, 403, 429, 520}</pre></div></div></div></div></div><div id="top-bar"><pre class="text--xl text--bold" id="top-bar--library-name">clj-security-protocols</pre><pre class="color--soft-grey text--s" id="top-bar--library-version">0.0.9.1</pre><a class="text--s" href="https://github.com/mt-app-kit/clj-security-protocols" id="top-bar--library-uri"><pre class="color--hard-blue">github.com/mt-app-kit/clj-security-protocols</pre></a></div><div id="bottom-bar"><a class="color--soft-purple text--s" href="https://github.com/mt-devtools/clj-source-code-documentation" id="bottom-bar--credits-link"><pre>github.com/mt-devtools/clj-source-code-documentation</pre></a></div></body></html></html>
