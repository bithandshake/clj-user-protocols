<!DOCTYPE html>
<html><html><head><style type="text/css">body{margin:12px 0 0 560px;padding:60px 48px}button{background-color:transparent;border:none;cursor:pointer;padding:0;user-select:none}button:hover{opacity:.5}div{box-sizing:border-box}pre{display:block;margin:0;letter-spacing:.8px}.scroll-x{overflow-x:auto}.scroll-y{flex-grow:1;overflow-y:auto}a,a:active,a:hover,a:visited{display:block;text-decoration:none}a.inline-link{display:inline-block}a.inline-link:hover{text-decoration:underline}.button{letter-spacing:.5px;white-space:inherit}.button:hover{background-color:#f0f0f0}.button--active{background-color:#f3f3f3}.button--active:hover{background-color:#f0f0f0}.text--xxs{font-size:10px;line-height:18px}.text--xs{font-size:11px;line-height:18px}.text--s{font-size:12px;line-height:18px}.text--m{font-size:13px;line-height:18px}.text--l{font-size:14px;line-height:18px}.text--xl{font-size:16px;line-height:24px}.text--xxl{font-size:18px;line-height:24px}.text--semi-bold{font-weight:500}.text--bold{font-weight:600}.text--uppercase{text-transform:uppercase}.text--boxed{background-color:#fafafa;padding:12px 8px}.text--hidden{display:none}.text--wrap{-white-space:normal;white-space:pre-wrap}.image--boxed{background-color:#fafafa;padding:12px 8px}.color--black{color:#000000}.color--hard-grey{color:#404040}.color--soft-grey{color:#808080}.color--hard-blue{color:#0088cc}.color--soft-blue{color:#55aabb}.color--hard-purple{color:#8800cc}.color--soft-purple{color:#aa55bb}.color--hard-red{color:#cc00aa}[data-collapsed="true"] .snippet--text{display:none}[data-collapsible="true"] .snippet--header::after{align-items:center;content:'▼';display:flex;font-size:8px;justify-content:center;height:18px;width:18px}[data-collapsible="true"][data-collapsed="false"] .snippet--header::after{content:'▲'}#top-bar{background-color:#ffffff;border-bottom:1px solid #e0e0e0;display:flex;gap:6px;height:60px;left:0;padding-left:18px;position:fixed;top:0;width:100%}#top-bar--library-uri{padding:21px 18px;position:absolute;right:0;top:0}#top-bar--library-uri:hover{background-color:#f0f0f0}#top-bar--library-name{padding:18px 0;text-transform:uppercase}#top-bar--library-version{margin-top:12px}#bottom-bar{background-color:white;border-top:1px solid #e0e0e0;bottom:0;display:flex;justify-content:right;position:fixed;right:0;width:calc(100% - 560px)}#bottom-bar--credits-link{padding:12px 18px}#bottom-bar--credits-link:hover{background-color:#f0f0f0}#primary-list{background-color:#fff;border-right:1px solid #e0e0e0;display:flex;flex-direction:column;height:calc(100vh - 60px);left:0;padding:12px 0;position:fixed;top:60px;width:280px}#secondary-list{background-color:#fff;border-right:1px solid #e0e0e0;display:flex;flex-direction:column;height:calc(100vh - 60px);left:280px;padding:12px 0;position:fixed;top:60px;width:280px}#primary-list,#secondary-list{z-index:9999}#primary-list .text--xs,#secondary-list .text--xs{padding-left:12px}.primary-list--container,.secondary-list--container{margin-bottom:12px}#primary-list .button,#secondary-list .button{padding:3px 12px}#primary-list .label,#secondary-list .label{padding:0 12px}.section{padding:72px 0}.section--header{border-bottom:1px solid #e0e0e0;padding-bottom:8px;margin-bottom:12px}.snippets{display:flex;flex-direction:column;gap:24px}.snippet--header{display:flex;gap:4px}.snippet--preview-image{border:1px solid #dedede;display:block;max-height:480px;max-width:640px;min-height:48px;min-width:64px}.snippet--text span{opacity:.65}</style><script type="text/javascript">function toggleCollapsible(collapsibleId){collapsible=document.getElementById(collapsibleId);if(collapsible.dataset.collapsed==='true'){collapsible.dataset.collapsed='false';}else{collapsible.dataset.collapsed='true';}}function toggleSidebar(sidebarId){sidebar=document.getElementById(sidebarId);if(sidebar.dataset.hidden==='true'){sidebar.dataset.hidden='false';}else{sidebar.dataset.hidden='true';}}</script><title>clj-security-protocols 0.1.1.3 documentation</title><link href="https://raw.githubusercontent.com/mt-security-kit/clj-security-protocols/release/mt-security-kit-logo.png" rel="icon" type="image/png"></head><body><div id="primary-list"><div class="scroll-y"><div class="primary-list--container"><pre class="label color--soft-grey text--xxs text--uppercase">Clojure namespaces</pre><a href="https://mt-security-kit.github.io/clj-security-protocols/clj/database-security-protocols/api.html"><pre class="button color--hard-blue text--m ">database-security-protocols.api</pre></a><a href="https://mt-security-kit.github.io/clj-security-protocols/clj/media-security-protocols/api.html"><pre class="button color--hard-blue text--m ">media-security-protocols.api</pre></a><a href="https://mt-security-kit.github.io/clj-security-protocols/clj/user-security-protocols/api.html"><pre class="button color--hard-blue text--m button--active">user-security-protocols.api</pre></a></div></div></div><div id="secondary-list"><div class="scroll-y"><div class="secondary-list--container"><pre class="label color--soft-grey text--xxs text--uppercase">Declarations</pre><a href="#check-user-identifier"><pre class="button color--hard-blue text--m">check-user-identifier</pre></a><a href="#create-user-account"><pre class="button color--hard-blue text--m">create-user-account</pre></a><a href="#drop-user-session"><pre class="button color--hard-blue text--m">drop-user-session</pre></a><a href="#recover-user-password"><pre class="button color--hard-blue text--m">recover-user-password</pre></a><a href="#remove-user-account"><pre class="button color--hard-blue text--m">remove-user-account</pre></a><a href="#send-security-code-authenticated"><pre class="button color--hard-blue text--m">send-security-code-authenticated</pre></a><a href="#send-security-code-unauthenticated"><pre class="button color--hard-blue text--m">send-security-code-unauthenticated</pre></a><a href="#update-user-contact"><pre class="button color--hard-blue text--m">update-user-contact</pre></a><a href="#update-user-data"><pre class="button color--hard-blue text--m">update-user-data</pre></a><a href="#update-username"><pre class="button color--hard-blue text--m">update-username</pre></a><a href="#verify-security-code-authenticated"><pre class="button color--hard-blue text--m">verify-security-code-authenticated</pre></a><a href="#verify-security-code-unauthenticated"><pre class="button color--hard-blue text--m">verify-security-code-unauthenticated</pre></a><a href="#verify-user-password"><pre class="button color--hard-blue text--m">verify-user-password</pre></a><a href="#verify-user-pin-code"><pre class="button color--hard-blue text--m">verify-user-pin-code</pre></a></div></div></div><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">Clojure namespace</pre><pre class="color--black text--xxl text--wrap text--bold">user-security-protocols.api</pre></div><div class="sections"></div><div class="sections"><div class="section" id="check-user-identifier"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">check-user-identifier</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q0dd8a41f-b7e3-4ce1-bbb0-bf50a90c3fea"><button class="snippet--header" onClick="toggleCollapsible(&apos;q0dd8a41f-b7e3-4ce1-bbb0-bf50a90c3fea&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn check-user-identifier
  [{:keys [additional-action-f
           additional-security-f
           client-rate-limit-exceeded-f
           ip-address-blacklist-f
           ip-address-valid-f
           permission-granted-f
           user-agent-blacklist-f
           user-agent-valid-f
           user-identifier-registered-f
           user-identifier-valid-f
           user-identifier-verified-f
           user-rate-limit-exceeded-f]}]
  (cond (and ip-address-valid-f           (not     (ip-address-valid-f)))           {:body :invalid-request/invalid-ip-address                 :status 400}
        (and user-agent-valid-f           (not     (user-agent-valid-f)))           {:body :invalid-request/invalid-user-agent                 :status 400}
        (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded       :status 429}
        (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded         :status 429}
        (and ip-address-blacklist-f       (boolean (ip-address-blacklist-f)))       {:body :forbidden-request/blacklisted-ip-address           :status 403}
        (and user-agent-blacklist-f       (boolean (user-agent-blacklist-f)))       {:body :forbidden-request/blacklisted-user-agent           :status 403}
        (and permission-granted-f         (not     (permission-granted-f)))         {:body :forbidden-request/permission-denied                :status 403}
        (and user-identifier-valid-f      (not     (user-identifier-valid-f)))      {:body :forbidden-request/invalid-user-identifier-received :status 403}
        (and additional-security-f        (not     (additional-security-f)))        {:body :unknown-error/additional-security-stage-failed     :status 520}
        (and additional-action-f          (not     (additional-action-f)))          {:body :unknown-error/additional-action-stage-failed       :status 520}
        (not (user-identifier-registered-f)) {:body :performed-request/unregistered-user-identifier-received :status 200}
        (not user-identifier-verified-f)     {:body :performed-request/registered-user-identifier-received   :status 200}
        (not (user-identifier-verified-f))   {:body :performed-request/unverified-user-identifier-received   :status 200}
        :verified-user-identifier-received   {:body :performed-request/verified-user-identifier-received     :status 200}))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q375c989d-2ecd-4798-88ca-64d2fce26174"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for checking a user identifier (email address / phone number / username) (for authenticated / unauthenticated users)<br>  whether it is registered and/or verified.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q0c4b7e07-2f1a-4c5b-befa-0368a18e7f99"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q71cdc886-bd99-4795-8ca4-ca0371c46aa7"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(check-user-identifier {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q64652f8e-cbca-4d53-9847-cad6b0bff072"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(check-user-identifier {...})<br>=&gt;<br>{:body :performed-request/verified-user-identifier-received :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qb357e4f8-2209-4f23-a345-35327cedbacc"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        email-address (-&gt; request :params :email-address)]<br>       (check-user-identifier {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address?    ip-address)<br>                               :user-identifier-registered-f #(my-database/email-address-registered?              email-address)<br>                               :user-identifier-valid-f      #(my-validator/email-address-valid?                  email-address)<br>                               :user-identifier-verified-f   #(my-database/email-address-verified?                email-address)<br>                               :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-email-address? email-address)})))<br>=&gt;<br>{:body :performed-request/verified-user-identifier-received :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q7853cb6a-1e5e-40a5-ae09-29339438bb48"><button class="snippet--header" onClick="toggleCollapsible(&apos;q7853cb6a-1e5e-40a5-ae09-29339438bb48&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :ip-address-blacklist-f (function)(opt)       Must return TRUE if the IP address is blacklisted.<br> :ip-address-valid-f (function)(opt)           Must return TRUE if the IP address is valid.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :user-agent-blacklist-f (function)(opt)       Must return TRUE if the user agent is blacklisted.<br> :user-agent-valid-f (function)(opt)           Must return TRUE if the user agent is valid.<br> :user-identifier-registered-f (function)      Must return TRUE if the received user identifier (email address / phone number / username) is registered.<br> :user-identifier-valid-f (function)(opt)      Must return TRUE if the received user identifier (email address / phone number / username) is valid.<br> :user-identifier-verified-f (function)(opt)   Must return TRUE if the received user identifier (if contact: email address / phone number) is verified.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q60c3e96b-4b78-44db-a7d4-f3fd71e35179"><button class="snippet--header" onClick="toggleCollapsible(&apos;q60c3e96b-4b78-44db-a7d4-f3fd71e35179&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword)<br>  :forbidden-request/blacklisted-ip-address                (IP address of client device is blacklisted)<br>  :forbidden-request/blacklisted-user-agent                (User agent of client device is blacklisted)<br>  :forbidden-request/invalid-user-identifier-received      (Invalid user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/permission-denied                     (The user has no permission to do the action)<br>  :invalid-request/invalid-ip-address                      (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                      (No valid user agent has been found in the request)<br>  :performed-request/registered-user-identifier-received   (Registered user identifier (email address / phone number / username) has been received)<br>  :performed-request/unregistered-user-identifier-received (Unregistered user identifier (email address / phone number / username) has been received)<br>  :performed-request/unverified-user-identifier-received   (Registered but unverified user identifier (if contact: email address / phone number) has been received)<br>  :performed-request/verified-user-identifier-received     (Registered and verified user identifier (email address / phone number / username) has been received)<br>  :too-many-requests/client-rate-limit-exceeded            (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded              (Too many actions have been attempted by the user in a specific timeframe)<br>  :unknown-error/additional-action-stage-failed            (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed          (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 403, 429, 520}</pre></div></div></div></div><div class="section" id="create-user-account"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">create-user-account</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q01e5589c-5827-49f7-b0fd-a2687864658b"><button class="snippet--header" onClick="toggleCollapsible(&apos;q01e5589c-5827-49f7-b0fd-a2687864658b&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn create-user-account
  [{:keys [additional-action-f
           additional-security-f
           client-rate-limit-exceeded-f
           create-user-account-f
           ip-address-blacklist-f
           ip-address-valid-f
           permission-granted-f
           provide-user-session-f
           send-security-code-f
           send-welcome-message-f
           user-agent-blacklist-f
           user-agent-valid-f
           user-authenticated-f
           user-data-valid-f
           user-identifier-registered-f
           user-identifier-valid-f
           user-password-valid-f
           user-rate-limit-exceeded-f]}]
  (cond (and ip-address-valid-f           (not     (ip-address-valid-f)))           {:body :invalid-request/invalid-ip-address                    :status 400}
        (and user-agent-valid-f           (not     (user-agent-valid-f)))           {:body :invalid-request/invalid-user-agent                    :status 400}
        (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded          :status 429}
        (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded            :status 429}
        (and ip-address-blacklist-f       (boolean (ip-address-blacklist-f)))       {:body :forbidden-request/blacklisted-ip-address              :status 403}
        (and user-agent-blacklist-f       (boolean (user-agent-blacklist-f)))       {:body :forbidden-request/blacklisted-user-agent              :status 403}
        (and permission-granted-f         (not     (permission-granted-f)))         {:body :forbidden-request/permission-denied                   :status 403}
        (and user-authenticated-f         (boolean (user-authenticated-f)))         {:body :forbidden-request/user-authenticated                  :status 403}
        (and user-identifier-valid-f      (not     (user-identifier-valid-f)))      {:body :forbidden-request/invalid-user-identifier-received    :status 403}
        (and user-password-valid-f        (not     (user-password-valid-f)))        {:body :forbidden-request/invalid-user-password-received      :status 403}
        (and user-data-valid-f            (not     (user-data-valid-f)))            {:body :forbidden-request/invalid-user-data-received          :status 403}
        (and user-identifier-registered-f (boolean (user-identifier-registered-f))) {:body :forbidden-request/registered-user-identifier-received :status 403}
        (and additional-security-f        (not     (additional-security-f)))        {:body :unknown-error/additional-security-stage-failed        :status 520}
        (and additional-action-f          (not     (additional-action-f)))          {:body :unknown-error/additional-action-stage-failed          :status 520}
        (and send-welcome-message-f       (not     (send-welcome-message-f)))       {:body :server-error/unable-to-send-welcome-message           :status 500}
        (not (create-user-account-f))                           {:body :server-error/unable-to-create-user-account :status 500}
        (and send-security-code-f (not (send-security-code-f))) {:body :server-error/unable-to-send-security-code  :status 500}
        (and send-security-code-f)                              {:body :performed-request/security-code-sent       :status 201}
        (not provide-user-session-f)                            {:body :performed-request/user-account-created     :status 201}
        :providing-user-session                                 (if-let [response (provide-user-session-f {:body :performed-request/ready-to-provide-user-session :status 201})]
                                                                        (-&gt;&gt; {:body :performed-request/user-session-provided     :status 201} (merge response))
                                                                        (-&gt;  {:body :server-error/unable-to-provide-user-session :status 500}))))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qcddc981f-367d-4966-a9be-499bf33f9b40"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for creating a user account that is identified by a user identifier (email address / phone number / username) and protected by a password.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q64757833-1e8c-4fed-be99-96a0a519addc"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).<br>- In case the 'send-security-code-f' function is passed, no security check has been failed, and the user account is successfully created,<br>  it applies the 'send-security-code-f' (it's a common scenario when user account creating followed by login code verification).<br>- In case the 'provide-user-session-f' function is passed, the 'send-security-code-f' function is NOT passed, no security check has<br>  been failed, and the user account is successfully created, it applies the 'provide-user-session-f' function on the HTTP response.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qf9feb69f-f8f7-4528-a8e0-d0e1fed43496"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(create-user-account {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q60360c82-bd74-42fa-a7e4-c63ace76f42c"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(create-user-account {...})<br>=&gt;<br>{:body :performed-request/user-account-created :status 201}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q8e748341-84eb-406a-8e3c-9235fe0fa515"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        email-address (-&gt; request :params :email-address)<br>        user-password (-&gt; request :params :password)<br>        user-data     (-&gt; request :params)]<br>       (create-user-account {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address?    ip-address)<br>                             :create-user-account-f        #(my-database/create-user-account!                   user-data)<br>                             :provide-user-session-f       #(my-session-handler/add-session-to-response         %)<br>                             :send-security-code-f         #(my-email-service/send-security-code-email!         email-address)<br>                             :send-welcome-message-f       #(my-email-service/send-welcome-email!               email-address)<br>                             :user-authenticated-f         #(my-validator/request-has-valid-session-valid?      request)<br>                             :user-data-valid-f            #(my-validator/user-data-valid?                      user-data)<br>                             :user-identifier-registered-f #(my-database/email-address-registered?              email-address)<br>                             :user-identifier-valid-f      #(my-validator/email-address-valid?                  email-address)<br>                             :user-password-valid-f        #(my-validator/user-password-valid?                  user-password)<br>                             :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-email-address? email-address)})))<br>=&gt;<br>{:body :performed-request/user-account-created :status 201}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qf8ffed43-d75c-41ef-a426-5efcb32eec67"><button class="snippet--header" onClick="toggleCollapsible(&apos;qf8ffed43-d75c-41ef-a426-5efcb32eec67&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :create-user-f (function)                     Side-effect function for creating the user account. Applied when every security check has been passed. Must return TRUE if the user account has been successfully created.<br> :ip-address-blacklist-f (function)(opt)       Must return TRUE if the IP address is blacklisted.<br> :ip-address-valid-f (function)(opt)           Must return TRUE if the IP address is valid.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :provide-user-session-f (function)(opt)       Must take the response as parameter, and associate a user session to it (return NIL in case of error).<br> :send-security-code-f (function)(opt)         Must return TRUE if the security code email / SMS has been successfully sent.<br> :send-welcome-message-f (function)(opt)       Optional side-effect function for sending a welcome message to the user. Applied when every security check has been passed. Must return TRUE if the welcome email / SMS has been successfully sent.<br> :user-agent-blacklist-f (function)(opt)       Must return TRUE if the user agent is blacklisted.<br> :user-agent-valid-f (function)(opt)           Must return TRUE if the user agent is valid.<br> :user-authenticated-f (function)(opt)         Must return TRUE the user is authenticated / logged in.<br> :user-data-valid-f (function)(opt)            Must return TRUE if the received user data is valid.<br> :user-identifier-registered-f (function)(opt) Must return TRUE if the received user identifier (email address / phone number / username) is registered.<br> :user-identifier-valid-f (function)(opt)      Must return TRUE if the received user identifier (email address / phone number / username) is valid.<br> :user-password-valid-f (function)(opt)        Must return TRUE if the received user password is valid.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qa988dd01-140f-4c84-a86f-9d44316cc327"><button class="snippet--header" onClick="toggleCollapsible(&apos;qa988dd01-140f-4c84-a86f-9d44316cc327&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword)<br>  :forbidden-request/blacklisted-ip-address              (IP address of client device is blacklisted)<br>  :forbidden-request/blacklisted-user-agent              (User agent of client device is blacklisted)<br>  :forbidden-request/invalid-user-identifier-received    (Invalid user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/invalid-user-data-received          (Invalid user data has been received)<br>  :forbidden-request/invalid-user-password-received      (Invalid user password has been received)<br>  :forbidden-request/permission-denied                   (The user has no permission to do the action)<br>  :forbidden-request/registered-user-identifier-received (Registered user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/user-authenticated                  (The user is authenticated / logged in)<br>  :invalid-request/invalid-ip-address                    (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                    (No valid user agent has been found in the request)<br>  :performed-request/user-account-created                (The server has been successfully created the user account)<br>  :performed-request/user-session-provided               (The server has been successfully provided a user session to the HTTP response)<br>  :server-error/unable-to-create-user-account            (The server cannot create the user account)<br>  :server-error/unable-to-provide-user-session           (The server cannot provide the user session to the HTTP response)<br>  :server-error/unable-to-send-security-code             (The server cannot send the security code email / SMS to the user)<br>  :server-error/unable-to-send-welcome-message           (The server cannot send the welcome email / SMS to the user)<br>  :too-many-requests/client-rate-limit-exceeded          (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded            (Too many actions have been attempted by the user in a specific timeframe)<br>  :unknown-error/additional-action-stage-failed          (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed        (The additional security function returned a false value)<br> :status (integer)<br>  201, 400, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="drop-user-session"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">drop-user-session</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q3b332dae-2f53-428a-91b7-c6a329dd1dc5"><button class="snippet--header" onClick="toggleCollapsible(&apos;q3b332dae-2f53-428a-91b7-c6a329dd1dc5&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn drop-user-session
  [{:keys [additional-action-f
           additional-security-f
           client-rate-limit-exceeded-f
           drop-user-session-f
           ip-address-blacklist-f
           ip-address-valid-f
           permission-granted-f
           user-agent-blacklist-f
           user-agent-valid-f
           user-authenticated-f
           user-exists-f
           user-rate-limit-exceeded-f]}]
  (cond (and ip-address-valid-f           (not     (ip-address-valid-f)))           {:body :invalid-request/invalid-ip-address             :status 400}
        (and user-agent-valid-f           (not     (user-agent-valid-f)))           {:body :invalid-request/invalid-user-agent             :status 400}
        (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded   :status 429}
        (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded     :status 429}
        (and ip-address-blacklist-f       (boolean (ip-address-blacklist-f)))       {:body :forbidden-request/blacklisted-ip-address       :status 403}
        (and user-agent-blacklist-f       (boolean (user-agent-blacklist-f)))       {:body :forbidden-request/blacklisted-user-agent       :status 403}
        (and permission-granted-f         (not     (permission-granted-f)))         {:body :forbidden-request/permission-denied            :status 403}
        (and user-authenticated-f         (not     (user-authenticated-f)))         {:body :forbidden-request/user-unauthenticated         :status 403}
        (and user-exists-f                (not     (user-exists-f)))                {:body :forbidden-request/user-not-exists              :status 403}
        (and additional-security-f        (not     (additional-security-f)))        {:body :unknown-error/additional-security-stage-failed :status 520}
        (and additional-action-f          (not     (additional-action-f)))          {:body :unknown-error/additional-action-stage-failed   :status 520}
        :dropping-user-session (if-let [response (drop-user-session-f {:body :performed-request/ready-to-drop-user-session :status 200})]
                                       (-&gt;&gt; {:body :performed-request/user-session-dropped   :status 200} (merge response))
                                       (-&gt;  {:body :server-error/unable-to-drop-user-session :status 500}))))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q64844a07-3b45-4b02-b3e5-c58fee2cd7de"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for dropping a user session.<br>- Performs various security checks before returns a HTTP response indicating the result of the checks.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q8a4e5f00-6ab3-4de8-b464-470f00af90bb"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qbae4991c-7522-457e-95d2-f8b162c0668b"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(drop-user-session {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q9dc46fb7-a52f-45ca-a49c-b7f6847631a8"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(drop-user-session {...})<br>=&gt;<br>{:body :performed-request/user-session-dropped :status 200 :session {}}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q389a7b0e-f75e-4ac2-9a78-2fb21b0c9e95"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address (-&gt; request :remote-addr)<br>        user-id    (-&gt; request :session :user-id)]<br>       (drop-user-session {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address? ip-address)<br>                           :drop-user-session-f          #(assoc % :session {})<br>                           :user-authenticated-f         #(my-validator/request-has-valid-session?         request)<br>                           :user-exists-f                #(my-database/user-id-exists?                     user-id)<br>                           :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-user-id?    user-id)})))<br>=&gt;<br>{:body :performed-request/user-session-dropped :status 200 :session {}}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qa44de0d7-e456-4cf4-9b3e-63a499e3055b"><button class="snippet--header" onClick="toggleCollapsible(&apos;qa44de0d7-e456-4cf4-9b3e-63a499e3055b&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :drop-user-session-f (function)               Must take the response as parameter, and remove the user session from it (return NIL in case of error).<br> :ip-address-blacklist-f (function)(opt)       Must return TRUE if the IP address is blacklisted.<br> :ip-address-valid-f (function)(opt)           Must return TRUE if the IP address is valid.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :user-agent-blacklist-f (function)(opt)       Must return TRUE if the user agent is blacklisted.<br> :user-agent-valid-f (function)(opt)           Must return TRUE if the user agent is valid.<br> :user-authenticated-f (function)(opt)         Must return TRUE the user is authenticated / logged in.<br> :user-exists-f (function)(opt)                Must return TRUE the user exists.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q311d248c-f44e-484a-9dc8-d1f7d9b95289"><button class="snippet--header" onClick="toggleCollapsible(&apos;q311d248c-f44e-484a-9dc8-d1f7d9b95289&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword)<br>  :forbidden-request/blacklisted-ip-address       (IP address of client device is blacklisted)<br>  :forbidden-request/blacklisted-user-agent       (User agent of client device is blacklisted)<br>  :forbidden-request/permission-denied            (The user has no permission to do the action)<br>  :forbidden-request/user-not-exists              (The user ID does not exist)<br>  :forbidden-request/user-unauthenticated         (The user is unauthenticated / not logged in)<br>  :invalid-request/invalid-ip-address             (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent             (No valid user agent has been found in the request)<br>  :performed-request/user-session-dropped         (The user session has been removed successfully)<br>  :server-error/unable-to-drop-user-session       (The server cannot remove the user session from the HTTP response)<br>  :unknown-error/additional-action-stage-failed   (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 429, 500, 520}</pre></div></div></div></div><div class="section" id="recover-user-password"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">recover-user-password</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="qe015c127-2a86-4b63-873b-b3288b013b0f"><button class="snippet--header" onClick="toggleCollapsible(&apos;qe015c127-2a86-4b63-873b-b3288b013b0f&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn recover-user-password
  [{:keys [additional-action-f
           additional-security-f
           client-rate-limit-exceeded-f
           fresh-password-valid-f
           ip-address-blacklist-f
           ip-address-valid-f
           permission-granted-f
           provide-user-session-f
           recover-user-password-f
           security-code-correct-f
           security-code-device-matches-f
           security-code-expired-f
           security-code-sent-f
           security-code-valid-f
           user-agent-blacklist-f
           user-agent-valid-f
           user-authenticated-f
           user-identifier-registered-f
           user-identifier-valid-f
           user-identifier-verified-f
           user-rate-limit-exceeded-f]}]
  (cond (and ip-address-valid-f             (not     (ip-address-valid-f)))             {:body :invalid-request/invalid-ip-address                      :status 400}
        (and user-agent-valid-f             (not     (user-agent-valid-f)))             {:body :invalid-request/invalid-user-agent                      :status 400}
        (and client-rate-limit-exceeded-f   (boolean (client-rate-limit-exceeded-f)))   {:body :too-many-requests/client-rate-limit-exceeded            :status 429}
        (and user-rate-limit-exceeded-f     (boolean (user-rate-limit-exceeded-f)))     {:body :too-many-requests/user-rate-limit-exceeded              :status 429}
        (and ip-address-blacklist-f         (boolean (ip-address-blacklist-f)))         {:body :forbidden-request/blacklisted-ip-address                :status 403}
        (and user-agent-blacklist-f         (boolean (user-agent-blacklist-f)))         {:body :forbidden-request/blacklisted-user-agent                :status 403}
        (and permission-granted-f           (not     (permission-granted-f)))           {:body :forbidden-request/permission-denied                     :status 403}
        (and user-authenticated-f           (boolean (user-authenticated-f)))           {:body :forbidden-request/user-authenticated                    :status 403}
        (and fresh-password-valid-f         (not     (fresh-password-valid-f)))         {:body :forbidden-request/invalid-fresh-password-received       :status 403}
        (and user-identifier-valid-f        (not     (user-identifier-valid-f)))        {:body :forbidden-request/invalid-user-identifier-received      :status 403}
        (and security-code-valid-f          (not     (security-code-valid-f)))          {:body :forbidden-request/invalid-security-code-received        :status 403}
        (and security-code-sent-f           (not     (security-code-sent-f)))           {:body :forbidden-request/no-security-code-sent-in-timeframe    :status 403}
        (and user-identifier-registered-f   (not     (user-identifier-registered-f)))   {:body :forbidden-request/unregistered-user-identifier-received :status 403}
        (and security-code-device-matches-f (not     (security-code-device-matches-f))) {:body :forbidden-request/security-code-device-not-matches      :status 403}
        (and user-identifier-verified-f     (not     (user-identifier-verified-f)))     {:body :forbidden-request/unverified-user-identifier-received   :status 403}
        (and security-code-correct-f        (not     (security-code-correct-f)))        {:body :unauthorized-request/incorrect-security-code-received   :status 401}
        (and security-code-expired-f        (boolean (security-code-expired-f)))        {:body :unauthorized-request/expired-security-code-received     :status 401}
        (and additional-security-f          (not     (additional-security-f)))          {:body :unknown-error/additional-security-stage-failed          :status 520}
        (and additional-action-f            (not     (additional-action-f)))            {:body :unknown-error/additional-action-stage-failed            :status 520}
        (not (recover-user-password-f)) {:body :server-error/unable-to-recover-user-password :status 500}
        (not provide-user-session-f)    {:body :performed-request/user-password-recovered    :status 200}
        :providing-user-session         (if-let [response (provide-user-session-f {:body :performed-request/ready-to-provide-user-session :status 200})]
                                                (-&gt;&gt; {:body :performed-request/user-session-provided     :status 200} (merge response))
                                                (-&gt;  {:body :server-error/unable-to-provide-user-session :status 500}))))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qe9dac46f-2f8a-4e9d-b539-42fc81289d25"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for user password recovering (for authenticated users) with optional security code verification.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q793102fb-ede8-4102-a0a7-bab9486a263e"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).<br>- In case the 'provide-user-session-f' function is passed, no security check has been failed, and the received security code is correct,<br>  it applies the 'provide-user-session-f' function on the HTTP response.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q46ca7310-9ff8-4444-90c8-542147eac207"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(recover-user-password {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q34c4a061-c959-47ff-8084-891b1ef052e9"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(recover-user-password {...})<br>=&gt;<br>{:body :performed-request/user-password-recovered :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q8e2be06d-de1f-448c-a06c-76e54d8e7bd6"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address     (-&gt; request :remote-addr)<br>        email-address  (-&gt; request :params :email-address)<br>        fresh-password (-&gt; request :params :fresh-password)<br>        security-code  (-&gt; request :params :security-code)<br>        user-id        (my-database/get-user-id-by-email-address email-address)]<br>       (recover-user-password {:client-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-ip-address?                 ip-address)<br>                               :fresh-password-valid-f         #(my-validator/user-password-valid?                               fresh-password)<br>                               :provide-user-session-f         #(my-session-handler/add-session-to-response                      %)<br>                               :recover-user-password-f        #(my-database/recover-user-password!                              user-id fresh-password)<br>                               :security-code-correct-f        #(my-database/security-code-matches?                              user-id security-code)<br>                               :security-code-device-matches-f #(my-log-service/security-code-required-from-the-same-ip-address? user-id ip-address)<br>                               :security-code-expired-f        #(my-database/security-code-expired?                              user-id)<br>                               :security-code-sent-f           #(my-database/security-code-sent?                                 user-id)<br>                               :security-code-valid-f          #(my-validator/security-code-valid?                               security-code)<br>                               :user-authenticated-f           #(my-validator/request-has-valid-session?                         request)<br>                               :user-identifier-registered-f   #(my-database/email-address-registered?                           email-address)<br>                               :user-identifier-valid-f        #(my-validator/email-address-valid?                               email-address)<br>                               :user-identifier-verified-f     #(my-database/email-address-verified?                             email-address)<br>                               :user-rate-limit-exceeded-f     #(my-log-service/too-many-attempts-by-user-id?                    user-id)})))<br>=&gt;<br>{:body :performed-request/user-password-recovered :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q4a86d47f-65aa-422c-993e-ca260204279a"><button class="snippet--header" onClick="toggleCollapsible(&apos;q4a86d47f-65aa-422c-993e-ca260204279a&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)            Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)          Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :fresh-password-valid-f (function)              Must return TRUE if the received fresh password is valid.<br> :ip-address-blacklist-f (function)(opt)         Must return TRUE if the IP address is blacklisted.<br> :ip-address-valid-f (function)(opt)             Must return TRUE if the IP address is valid.<br> :permission-granted-f (function)(opt)           Must return TRUE if the user has permission to do the action.<br> :provide-user-session-f (function)(opt)         Must take the response as parameter, and associate a user session to it (return NIL in case of error).<br> :recover-user-password-f (function)             Side-effect function for recovering the user's password. Applied when every security check has been passed. Must return TRUE if the user's password has been successfully recovered.<br> :security-code-correct-f (function)(opt)        Must return TRUE if the received security code is correct.<br> :security-code-device-matches-f (function)(opt) Must return TRUE if the received security code has been required from the same device.<br> :security-code-expired-f (function)(opt)        Must return TRUE if the received security code has been expired.<br> :security-code-sent-f (function)(opt)           Must return TRUE if a security code has been sent recently.<br> :security-code-valid-f (function)(opt)          Must return TRUE if the received security code is valid.<br> :user-agent-blacklist-f (function)(opt)         Must return TRUE if the user agent is blacklisted.<br> :user-agent-valid-f (function)(opt)             Must return TRUE if the user agent is valid.<br> :user-authenticated-f (function)(opt)           Must return TRUE the user is authenticated / logged in.<br> :user-identifier-registered-f (function)(opt)   Must return TRUE if the received user identifier (email address / phone number / username) is registered.<br> :user-identifier-valid-f (function)(opt)        Must return TRUE if the received user identifier (email address / phone number / username) is valid.<br> :user-identifier-verified-f (function)(opt)     Must return TRUE if the received user identifier (if contact: email address / phone number) is verified.<br> :user-rate-limit-exceeded-f (function)(opt)     Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qba441fbc-3439-4cbb-8148-d3c3c517fb6d"><button class="snippet--header" onClick="toggleCollapsible(&apos;qba441fbc-3439-4cbb-8148-d3c3c517fb6d&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword)<br>  :forbidden-request/blacklisted-ip-address                (IP address of client device is blacklisted)<br>  :forbidden-request/blacklisted-user-agent                (User agent of client device is blacklisted)<br>  :invalid-request/invalid-ip-address                      (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                      (No valid user agent has been found in the request)<br>  :forbidden-request/invalid-fresh-password-received       (Invalid fresh password has been received)<br>  :forbidden-request/invalid-security-code-received        (Invalid security code has been received)<br>  :forbidden-request/invalid-user-identifier-received      (Invalid user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/no-security-code-sent-in-timeframe    (No security code has been sent in a specific timeframe)<br>  :forbidden-request/permission-denied                     (The user has no permission to do the action)<br>  :forbidden-request/security-code-device-not-matches      (The received security code has been required from another device)<br>  :forbidden-request/unregistered-user-identifier-received (Unregistered user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/unverified-user-identifier-received   (Unverified user identifier (if contact: email address / phone number) has been received)<br>  :forbidden-request/user-authenticated                    (The user is authenticated / logged in)<br>  :performed-request/user-password-recovered               (The server has been successfully recovered the user's password)<br>  :performed-request/user-session-provided                 (The server has been successfully provided a user session to the HTTP response)<br>  :server-error/unable-to-provide-user-session             (The server cannot provide the user session to the HTTP response)<br>  :server-error/unable-to-recover-user-password            (The server cannot recover the user's password)<br>  :too-many-requests/client-rate-limit-exceeded            (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded              (Too many actions have been attempted by the user in a specific timeframe)<br>  :unauthorized-request/expired-security-code-received     (Expired security code has been received)<br>  :unauthorized-request/incorrect-security-code-received   (Incorrect security code has been received)<br>  :unknown-error/additional-action-stage-failed            (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed          (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 401, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="remove-user-account"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">remove-user-account</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q3d3b3270-bbab-428c-ac71-dfab35df8c07"><button class="snippet--header" onClick="toggleCollapsible(&apos;q3d3b3270-bbab-428c-ac71-dfab35df8c07&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn remove-user-account
  [{:keys [additional-action-f
           additional-security-f
           client-rate-limit-exceeded-f
           drop-user-session-f
           ip-address-blacklist-f
           ip-address-valid-f
           permission-granted-f
           remove-user-account-f
           security-code-correct-f
           security-code-device-matches-f
           security-code-expired-f
           security-code-sent-f
           security-code-valid-f
           send-goodbye-message-f
           user-agent-blacklist-f
           user-agent-valid-f
           user-authenticated-f
           user-exists-f
           user-password-correct-f
           user-password-valid-f
           user-rate-limit-exceeded-f]}]
  (cond (and ip-address-valid-f             (not     (ip-address-valid-f)))             {:body :invalid-request/invalid-ip-address                    :status 400}
        (and user-agent-valid-f             (not     (user-agent-valid-f)))             {:body :invalid-request/invalid-user-agent                    :status 400}
        (and client-rate-limit-exceeded-f   (boolean (client-rate-limit-exceeded-f)))   {:body :too-many-requests/client-rate-limit-exceeded          :status 429}
        (and user-rate-limit-exceeded-f     (boolean (user-rate-limit-exceeded-f)))     {:body :too-many-requests/user-rate-limit-exceeded            :status 429}
        (and ip-address-blacklist-f         (boolean (ip-address-blacklist-f)))         {:body :forbidden-request/blacklisted-ip-address              :status 403}
        (and user-agent-blacklist-f         (boolean (user-agent-blacklist-f)))         {:body :forbidden-request/blacklisted-user-agent              :status 403}
        (and permission-granted-f           (not     (permission-granted-f)))           {:body :forbidden-request/permission-denied                   :status 403}
        (and user-authenticated-f           (not     (user-authenticated-f)))           {:body :forbidden-request/user-unauthenticated                :status 403}
        (and user-exists-f                  (not     (user-exists-f)))                  {:body :forbidden-request/user-not-exists                     :status 403}
        (and user-password-valid-f          (not     (user-password-valid-f)))          {:body :forbidden-request/invalid-user-password-received      :status 403}
        (and security-code-valid-f          (not     (security-code-valid-f)))          {:body :forbidden-request/invalid-security-code-received      :status 403}
        (and security-code-sent-f           (not     (security-code-sent-f)))           {:body :forbidden-request/no-security-code-sent-in-timeframe  :status 403}
        (and security-code-device-matches-f (not     (security-code-device-matches-f))) {:body :forbidden-request/security-code-device-not-matches    :status 403}
        (and user-password-correct-f        (not     (user-password-correct-f)))        {:body :unauthorized-request/incorrect-user-password-received :status 401}
        (and security-code-correct-f        (not     (security-code-correct-f)))        {:body :unauthorized-request/incorrect-security-code-received :status 401}
        (and security-code-expired-f        (boolean (security-code-expired-f)))        {:body :unauthorized-request/expired-security-code-received   :status 401}
        (and additional-security-f          (not     (additional-security-f)))          {:body :unknown-error/additional-security-stage-failed        :status 520}
        (and additional-action-f            (not     (additional-action-f)))            {:body :unknown-error/additional-action-stage-failed          :status 520}
        (and send-goodbye-message-f         (not     (send-goodbye-message-f)))         {:body :server-error/unable-to-send-goodbye-message           :status 500}
        (not (remove-user-account-f)) {:body :server-error/unable-to-remove-user-account :status 500}
        (not drop-user-session-f)     {:body :performed-request/user-account-removed     :status 200}
        :dropping-user-session        (if-let [response (drop-user-session-f {:body :performed-request/ready-to-drop-user-session :status 200})]
                                              (-&gt;&gt; {:body :performed-request/user-session-dropped   :status 200} (merge response))
                                              (-&gt;  {:body :server-error/unable-to-drop-user-session :status 500}))))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q7711a173-550a-44ec-a66a-ce7b2d9a8523"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for user account removal (for authenticated users) with optional user password and/or security code verification.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qbd9a10bb-101f-4820-b4c1-f19f0427de47"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qf64aac37-548c-4b2f-a299-7ad9b3abc772"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(remove-user-account {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q67027fbd-dee2-4863-bac2-f96d29e45326"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(remove-user-account {...})<br>=&gt;<br>{:body :performed-request/user-account-removed :status 200 :session {}}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q1813bf10-ce80-4434-b67a-20cbbf0f85a8"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        user-password (-&gt; request :params :password)<br>        security-code (-&gt; request :params :security-code)<br>        user-id       (-&gt; request :session :user-id)]<br>       (remove-user-account {:client-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-ip-address?                 ip-address)<br>                             :drop-user-session-f            #(assoc % :session {})<br>                             :remove-user-account-f          #(my-database/remove-user-account!                                user-id)<br>                             :security-code-correct-f        #(my-database/security-code-matches?                              user-id security-code)<br>                             :security-code-device-matches-f #(my-log-service/security-code-required-from-the-same-ip-address? user-id ip-address)<br>                             :security-code-expired-f        #(my-database/security-code-expired?                              user-id)<br>                             :security-code-sent-f           #(my-database/security-code-sent?                                 user-id)<br>                             :security-code-valid-f          #(my-validator/security-code-valid?                               security-code)<br>                             :send-goodbye-message-f         #(my-email-service/send-goodbye-email!                            user-id)<br>                             :user-authenticated-f           #(my-validator/request-has-valid-session?                         request)<br>                             :user-exists-f                  #(my-database/user-id-exists?                                     user-id)<br>                             :user-password-correct-f        #(my-database/user-password-matches?                              user-password)<br>                             :user-password-valid-f          #(my-validator/user-password-valid?                               user-password)<br>                             :user-rate-limit-exceeded-f     #(my-log-service/too-many-attempts-by-user-id?                    user-id)})))<br>=&gt;<br>{:body :performed-request/user-account-removed :status 200 :session {}}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q380a5a56-f7cd-46f0-8259-8b670e45da09"><button class="snippet--header" onClick="toggleCollapsible(&apos;q380a5a56-f7cd-46f0-8259-8b670e45da09&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)             Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)           Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt)    Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :drop-user-session-f (function)(opt)             Must take the response as parameter, and remove the user session from it (return NIL in case of error).<br> :ip-address-blacklist-f (function)(opt)          Must return TRUE if the IP address is blacklisted.<br> :ip-address-valid-f (function)(opt)              Must return TRUE if the IP address is valid.<br> :permission-granted-f (function)(opt)            Must return TRUE if the user has permission to do the action.<br> :remove-user-account-f (function)                Side-effect function for removing the user account. Applied when every security check has been passed. Must return TRUE if the user account has been successfully removed.<br> :security-code-correct-f (function)(opt)         Must return TRUE if the received security code is correct.<br> :security-code-device-matches-f (function)(opt)  Must return TRUE if the received security code has been required from the same device.<br> :security-code-expired-f (function)(opt)         Must return TRUE if the received security code has been expired.<br> :security-code-sent-f (function)(opt)            Must return TRUE if a security code has been sent recently.<br> :security-code-valid-f (function)(opt)           Must return TRUE if the received security code is valid.<br> :send-goodbye-message-f (function)(opt)          Optional side-effect function for sending a goodbye message to the user. Applied when every security check has been passed. Must return TRUE if the goodbye email / SMS has been successfully sent.<br> :user-agent-blacklist-f (function)(opt)          Must return TRUE if the user agent is blacklisted.<br> :user-agent-valid-f (function)(opt)              Must return TRUE if the user agent is valid.<br> :user-authenticated-f (function)(opt)            Must return TRUE the user is authenticated / logged in.<br> :user-exists-f (function)(opt)                   Must return TRUE the user exists.<br> :user-password-correct-f (function)(opt)         Must return TRUE if the received user password is correct.<br> :user-password-valid-f (function)(opt)           Must return TRUE if the received user password is valid.<br> :user-rate-limit-exceeded-f (function)(opt)      Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q8b4af610-bf82-4221-89c3-c165e6607f2b"><button class="snippet--header" onClick="toggleCollapsible(&apos;q8b4af610-bf82-4221-89c3-c165e6607f2b&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword)<br>  :forbidden-request/blacklisted-ip-address              (IP address of client device is blacklisted)<br>  :forbidden-request/blacklisted-user-agent              (User agent of client device is blacklisted)<br>  :forbidden-request/invalid-security-code-received      (Invalid security code has been received)<br>  :forbidden-request/invalid-user-password-received      (Invalid user password has been received)<br>  :forbidden-request/no-security-code-sent-in-timeframe  (No security code has been sent in a specific timeframe)<br>  :forbidden-request/permission-denied                   (The user has no permission to do the action)<br>  :forbidden-request/security-code-device-not-matches    (The received security code has been required from another device)<br>  :forbidden-request/user-not-exists                     (The user ID does not exist)<br>  :forbidden-request/user-unauthenticated                (The user is unauthenticated / not logged in)<br>  :invalid-request/invalid-ip-address                    (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                    (No valid user agent has been found in the request)<br>  :performed-request/user-account-removed                (The server has been successfully removed the user account)<br>  :performed-request/user-session-dropped                (The server has been successfully removed the user account and the user session from the HTTP response)<br>  :server-error/unable-to-drop-user-session              (The server cannot remove the user session from the HTTP response)<br>  :server-error/unable-to-remove-user-account            (The server cannot remove the user account)<br>  :server-error/unable-to-send-goodbye-message           (The server cannot send the goodbye email / SMS to the user)<br>  :too-many-requests/client-rate-limit-exceeded          (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded            (Too many actions have been attempted by the user in a specific timeframe)<br>  :unauthorized-request/expired-security-code-received   (Expired security code has been received)<br>  :unauthorized-request/incorrect-security-code-received (Incorrect security code has been received)<br>  :unauthorized-request/incorrect-user-password-received (Incorrect user password has been received)<br>  :unknown-error/additional-action-stage-failed          (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed        (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 401, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="send-security-code-authenticated"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">send-security-code-authenticated</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q7ed9ba7b-d583-4f28-acce-934f0553ef95"><button class="snippet--header" onClick="toggleCollapsible(&apos;q7ed9ba7b-d583-4f28-acce-934f0553ef95&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn send-security-code-authenticated
  [{:keys [additional-action-f
           additional-security-f
           client-rate-limit-exceeded-f
           ip-address-blacklist-f
           ip-address-valid-f
           permission-granted-f
           send-security-code-f
           user-agent-blacklist-f
           user-agent-valid-f
           user-authenticated-f
           user-exists-f
           user-rate-limit-exceeded-f]}]
  (cond (and ip-address-valid-f           (not     (ip-address-valid-f)))           {:body :invalid-request/invalid-ip-address             :status 400}
        (and user-agent-valid-f           (not     (user-agent-valid-f)))           {:body :invalid-request/invalid-user-agent             :status 400}
        (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded   :status 429}
        (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded     :status 429}
        (and ip-address-blacklist-f       (boolean (ip-address-blacklist-f)))       {:body :forbidden-request/blacklisted-ip-address       :status 403}
        (and user-agent-blacklist-f       (boolean (user-agent-blacklist-f)))       {:body :forbidden-request/blacklisted-user-agent       :status 403}
        (and permission-granted-f         (not     (permission-granted-f)))         {:body :forbidden-request/permission-denied            :status 403}
        (and user-authenticated-f         (not     (user-authenticated-f)))         {:body :forbidden-request/user-unauthenticated         :status 403}
        (and user-exists-f                (not     (user-exists-f)))                {:body :forbidden-request/user-not-exists              :status 403}
        (and additional-security-f        (not     (additional-security-f)))        {:body :unknown-error/additional-security-stage-failed :status 520}
        (and additional-action-f          (not     (additional-action-f)))          {:body :unknown-error/additional-action-stage-failed   :status 520}
        (not (send-security-code-f)) {:body :server-error/unable-to-send-security-code :status 500}
        :security-code-sent          {:body :performed-request/security-code-sent      :status 200}))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q64f7c466-7d47-42a5-885a-2c84d0237e33"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for security code sending via email / SMS (for authenticated users).<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q9c211e16-1535-4832-a532-c05d261a89a0"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qb53be386-2148-403b-abb2-d75a6d750a18"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(send-security-code-authenticated {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qcc0fcbd0-c716-4271-856d-2131547c0fc2"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(send-security-code-authenticated {...})<br>=&gt;<br>{:body :performed-request/security-code-sent :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q35a76608-bd34-4750-9d4d-e75ddd475dc4"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address (-&gt; request :remote-addr)<br>        user-id    (-&gt; request :session :user-id)]<br>       (send-security-code-authenticated {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address? ip-address)<br>                                          :send-security-code-f         #(my-email-service/send-security-code-email!      user-id)<br>                                          :user-authenticated-f         #(my-validator/request-has-valid-session?         request)<br>                                          :user-exists-f                #(my-database/user-id-exists?                     user-id)<br>                                          :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-user-id?    user-id)})))<br>=&gt;<br>{:body :performed-request/security-code-sent :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qa265ae41-b1ca-44d1-8c31-19382a2b00fc"><button class="snippet--header" onClick="toggleCollapsible(&apos;qa265ae41-b1ca-44d1-8c31-19382a2b00fc&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :ip-address-blacklist-f (function)(opt)       Must return TRUE if the IP address is blacklisted.<br> :ip-address-valid-f (function)(opt)           Must return TRUE if the IP address is valid.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :send-security-code-f (function)              Side-effect function for sending the security code to the user. Applied when every security check has been passed. Must return TRUE if the security code email / SMS has been successfully sent.<br> :user-agent-blacklist-f (function)(opt)       Must return TRUE if the user agent is blacklisted.<br> :user-agent-valid-f (function)(opt)           Must return TRUE if the user agent is valid.<br> :user-authenticated-f (function)(opt)         Must return TRUE the user is authenticated / logged in.<br> :user-exists-f (function)(opt)                Must return TRUE the user exists.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q522e216e-9a8e-4295-baf2-5c676f5bde37"><button class="snippet--header" onClick="toggleCollapsible(&apos;q522e216e-9a8e-4295-baf2-5c676f5bde37&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword)<br>  :forbidden-request/blacklisted-ip-address       (IP address of client device is blacklisted)<br>  :forbidden-request/blacklisted-user-agent       (User agent of client device is blacklisted)<br>  :forbidden-request/permission-denied            (The user has no permission to do the action)<br>  :forbidden-request/user-not-exists              (The user ID does not exist)<br>  :forbidden-request/user-unauthenticated         (The user is unauthenticated / not logged in)<br>  :invalid-request/invalid-ip-address             (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent             (No valid user agent has been found in the request)<br>  :performed-request/security-code-sent           (The server has been successfully sent the security code email / SMS to the user)<br>  :server-error/unable-to-send-security-code      (The server cannot send the security code email / SMS to the user)<br>  :too-many-requests/client-rate-limit-exceeded   (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded     (Too many actions have been attempted by the user in a specific timeframe)<br>  :unknown-error/additional-action-stage-failed   (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="send-security-code-unauthenticated"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">send-security-code-unauthenticated</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="qe81d506f-afd8-4b6f-9d48-45b4597ba08b"><button class="snippet--header" onClick="toggleCollapsible(&apos;qe81d506f-afd8-4b6f-9d48-45b4597ba08b&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn send-security-code-unauthenticated
  [{:keys [additional-action-f
           additional-security-f
           client-rate-limit-exceeded-f
           ip-address-blacklist-f
           ip-address-valid-f
           permission-granted-f
           send-security-code-f
           user-agent-blacklist-f
           user-agent-valid-f
           user-authenticated-f
           user-identifier-registered-f
           user-identifier-valid-f
           user-identifier-verified-f
           user-rate-limit-exceeded-f]}]
  (cond (and ip-address-valid-f           (not     (ip-address-valid-f)))           {:body :invalid-request/invalid-ip-address                      :status 400}
        (and user-agent-valid-f           (not     (user-agent-valid-f)))           {:body :invalid-request/invalid-user-agent                      :status 400}
        (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded            :status 429}
        (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded              :status 429}
        (and ip-address-blacklist-f       (boolean (ip-address-blacklist-f)))       {:body :forbidden-request/blacklisted-ip-address                :status 403}
        (and user-agent-blacklist-f       (boolean (user-agent-blacklist-f)))       {:body :forbidden-request/blacklisted-user-agent                :status 403}
        (and permission-granted-f         (not     (permission-granted-f)))         {:body :forbidden-request/permission-denied                     :status 403}
        (and user-authenticated-f         (boolean (user-authenticated-f)))         {:body :forbidden-request/user-authenticated                    :status 403}
        (and user-identifier-valid-f      (not     (user-identifier-valid-f)))      {:body :forbidden-request/invalid-user-identifier-received      :status 403}
        (and user-identifier-registered-f (not     (user-identifier-registered-f))) {:body :forbidden-request/unregistered-user-identifier-received :status 403}
        (and user-identifier-verified-f   (not     (user-identifier-verified-f)))   {:body :forbidden-request/unverified-user-identifier-received   :status 403}
        (and additional-security-f        (not     (additional-security-f)))        {:body :unknown-error/additional-security-stage-failed          :status 520}
        (and additional-action-f          (not     (additional-action-f)))          {:body :unknown-error/additional-action-stage-failed            :status 520}
        (not (send-security-code-f)) {:body :server-error/unable-to-send-security-code :status 500}
        :security-code-sent          {:body :performed-request/security-code-sent      :status 200}))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q44778da4-7c60-4c0b-a6eb-5c1d5492a771"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for security code sending via email / SMS (for unauthenticated users).<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qbaa42040-cef5-4739-b8c3-ea63147a6a3b"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qf39358f8-4643-4174-b820-39613f05b89c"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(send-security-code-unauthenticated {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q27f2383d-5c00-4670-830b-b39e3b02efa6"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(send-security-code-unauthenticated {...})<br>=&gt;<br>{:body :performed-request/security-code-sent :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qf37d135f-6b1b-499a-8d0d-a837efd7bfd8"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        email-address (-&gt; request :params :email-address)]<br>       (send-security-code-unauthenticated {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address?    ip-address)<br>                                            :send-security-code-f         #(my-email-service/send-security-code-email!         email-address)<br>                                            :user-authenticated-f         #(my-validator/request-has-valid-session?            request)<br>                                            :user-identifier-registered-f #(my-database/email-address-registered?              email-address)<br>                                            :user-identifier-valid-f      #(my-validator/email-address-valid?                  email-address)<br>                                            :user-identifier-verified-f   #(my-database/email-address-verified?                email-address)<br>                                            :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-email-address? email-address)})))<br>=&gt;<br>{:body :performed-request/security-code-sent :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q1a49a32f-d4b8-4f0f-9e77-2a1766e78bd1"><button class="snippet--header" onClick="toggleCollapsible(&apos;q1a49a32f-d4b8-4f0f-9e77-2a1766e78bd1&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :ip-address-blacklist-f (function)(opt)       Must return TRUE if the IP address is blacklisted.<br> :ip-address-valid-f (function)(opt)           Must return TRUE if the IP address is valid.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :send-security-code-f (function)              Side-effect function for sending the security code to the user. Applied when every security check has been passed. Must return TRUE if the security code email / SMS has been successfully sent.<br> :user-agent-blacklist-f (function)(opt)       Must return TRUE if the user agent is blacklisted.<br> :user-agent-valid-f (function)(opt)           Must return TRUE if the user agent is valid.<br> :user-authenticated-f (function)(opt)         Must return TRUE the user is authenticated / logged in.<br> :user-identifier-registered-f (function)(opt) Must return TRUE if the received user identifier (email address / phone number / username) is registered.<br> :user-identifier-valid-f (function)(opt)      Must return TRUE if the received user identifier (email address / phone number / username) is valid.<br> :user-identifier-verified-f (function)(opt)   Must return TRUE if the received user identifier (if contact: email address / phone number) is verified.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q527f7b31-465c-49d9-8835-041bb5780060"><button class="snippet--header" onClick="toggleCollapsible(&apos;q527f7b31-465c-49d9-8835-041bb5780060&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword)<br>  :forbidden-request/blacklisted-ip-address                (IP address of client device is blacklisted)<br>  :forbidden-request/blacklisted-user-agent                (User agent of client device is blacklisted)<br>  :forbidden-request/invalid-user-identifier-received      (Invalid user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/permission-denied                     (The user has no permission to do the action)<br>  :forbidden-request/unregistered-user-identifier-received (Unregistered user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/unverified-user-identifier-received   (Unverified user identifier (if contact: email address / phone number) has been received)<br>  :forbidden-request/user-authenticated                    (The user is authenticated / logged in)<br>  :invalid-request/invalid-ip-address                      (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                      (No valid user agent has been found in the request)<br>  :performed-request/security-code-sent                    (The server has been successfully sent the security code email / SMS to the user)<br>  :server-error/unable-to-send-security-code               (The server cannot send the security code email / SMS to the user)<br>  :too-many-requests/client-rate-limit-exceeded            (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded              (Too many actions have been attempted by the user in a specific timeframe)<br>  :unknown-error/additional-action-stage-failed            (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed          (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="update-username"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">update-username</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="qf2131e3d-a0f4-42a9-a718-cb60fd429def"><button class="snippet--header" onClick="toggleCollapsible(&apos;qf2131e3d-a0f4-42a9-a718-cb60fd429def&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn update-username
  [{:keys [additional-action-f
           additional-security-f
           client-rate-limit-exceeded-f
           ip-address-blacklist-f
           ip-address-valid-f
           permission-granted-f
           update-username-f
           username-registered-f
           username-valid-f
           user-agent-blacklist-f
           user-agent-valid-f
           user-authenticated-f
           user-exists-f
           user-password-correct-f
           user-password-valid-f
           user-rate-limit-exceeded-f]}]
  (cond (and ip-address-valid-f           (not     (ip-address-valid-f)))           {:body :invalid-request/invalid-ip-address                    :status 400}
        (and user-agent-valid-f           (not     (user-agent-valid-f)))           {:body :invalid-request/invalid-user-agent                    :status 400}
        (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded          :status 429}
        (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded            :status 429}
        (and ip-address-blacklist-f       (boolean (ip-address-blacklist-f)))       {:body :forbidden-request/blacklisted-ip-address              :status 403}
        (and user-agent-blacklist-f       (boolean (user-agent-blacklist-f)))       {:body :forbidden-request/blacklisted-user-agent              :status 403}
        (and permission-granted-f         (not     (permission-granted-f)))         {:body :forbidden-request/permission-denied                   :status 403}
        (and user-authenticated-f         (not     (user-authenticated-f)))         {:body :forbidden-request/user-unauthenticated                :status 403}
        (and user-exists-f                (not     (user-exists-f)))                {:body :forbidden-request/user-not-exists                     :status 403}
        (and username-valid-f             (not     (username-valid-f)))             {:body :forbidden-request/invalid-username-received           :status 403}
        (and user-password-valid-f        (not     (user-password-valid-f)))        {:body :forbidden-request/invalid-user-password-received      :status 403}
        (and username-registered-f        (boolean (username-registered-f)))        {:body :forbidden-request/registered-username-received        :status 403}
        (and user-password-correct-f      (not     (user-password-correct-f)))      {:body :unauthorized-request/incorrect-user-password-received :status 401}
        (and additional-security-f        (not     (additional-security-f)))        {:body :unknown-error/additional-security-stage-failed        :status 520}
        (and additional-action-f          (not     (additional-action-f)))          {:body :unknown-error/additional-action-stage-failed          :status 520}
        (not (update-username-f)) {:body :server-error/unable-to-update-username :status 500}
        :username-updated         {:body :performed-request/username-updated     :status 200}))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qfd096369-bfd5-4ec9-8f59-d60800cb5890"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for updating a username (for authenticated users) with optional password verification.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q975cdee8-b148-4cf1-ac29-4823d0900e89"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q57d4b2fe-f620-4941-8266-7593f749d039"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(update-username {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q356630ef-1edb-4da3-ac36-1b60838823cb"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(update-username {...})<br>=&gt;<br>{:body :performed-request/username-updated :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q277d3b74-7c08-46e3-9ac5-97aafbcfa4f4"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        username      (-&gt; request :params :username)<br>        user-password (-&gt; request :params :password)<br>        security-code (-&gt; request :params :security-code)<br>        user-id       (-&gt; request :session :user-id)]<br>       (update-username {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address? ip-address)<br>                                 :update-username-f            #(my-database/update-user-username!               user-id username)<br>                                 :username-registered-f        #(my-database/username-registered?                username)<br>                                 :username-valid-f             #(my-validator/username-valid?                    username)<br>                                 :user-authenticated-f         #(my-validator/request-has-valid-session?         request)<br>                                 :user-exists-f                #(my-database/user-id-exists?                     user-id)<br>                                 :user-password-correct-f      #(my-database/user-password-matches?              user-password)<br>                                 :user-password-valid-f        #(my-validator/user-password-valid?               user-password)<br>                                 :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-user-id?    user-id)})))<br>=&gt;<br>{:body :performed-request/username-updated :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q3e34d5e2-f8d9-43b5-a885-8e59d925ed23"><button class="snippet--header" onClick="toggleCollapsible(&apos;q3e34d5e2-f8d9-43b5-a885-8e59d925ed23&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :ip-address-blacklist-f (function)(opt)       Must return TRUE if the IP address is blacklisted.<br> :ip-address-valid-f (function)(opt)           Must return TRUE if the IP address is valid.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :update-username-f (function)                 Side-effect function for updating the username. Applied when every security check has been passed. Must return TRUE if the username has been successfully updated.<br> :username-registered-f (function)(opt)        Must return TRUE if the received username is registered.<br> :username-valid-f (function)(opt)             Must return TRUE if the received username is valid.<br> :user-agent-blacklist-f (function)(opt)       Must return TRUE if the user agent is blacklisted.<br> :user-agent-valid-f (function)(opt)           Must return TRUE if the user agent is valid.<br> :user-authenticated-f (function)(opt)         Must return TRUE the user is authenticated / logged in.<br> :user-exists-f (function)(opt)                Must return TRUE the user exists.<br> :user-password-correct-f (function)(opt)      Must return TRUE if the received user password is correct.<br> :user-password-valid-f (function)(opt)        Must return TRUE if the received user password is valid.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q70b7b60b-dc7e-4382-996f-d8cf3d9836e8"><button class="snippet--header" onClick="toggleCollapsible(&apos;q70b7b60b-dc7e-4382-996f-d8cf3d9836e8&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword)<br>  :forbidden-request/blacklisted-ip-address              (IP address of client device is blacklisted)<br>  :forbidden-request/blacklisted-user-agent              (User agent of client device is blacklisted)<br>  :forbidden-request/invalid-username-received           (Invalid username has been received)<br>  :forbidden-request/invalid-user-password-received      (Invalid user password has been received)<br>  :forbidden-request/permission-denied                   (The user has no permission to do the action)<br>  :forbidden-request/registered-username-received        (Registered username has been received)<br>  :forbidden-request/user-not-exists                     (The user ID does not exist)<br>  :forbidden-request/user-unauthenticated                (The user is unauthenticated / not logged in)<br>  :invalid-request/invalid-ip-address                    (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                    (No valid user agent has been found in the request)<br>  :performed-request/username-updated                    (The server has been successfully updated the username)<br>  :server-error/unable-to-update-username                (The server cannot update the username)<br>  :too-many-requests/client-rate-limit-exceeded          (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded            (Too many actions have been attempted by the user in a specific timeframe)<br>  :unauthorized-request/incorrect-user-password-received (Incorrect user password has been received)<br>  :unknown-error/additional-action-stage-failed          (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed        (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 401, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="update-user-contact"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">update-user-contact</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q0913dc82-1ac8-471e-9134-95a92f89c7fc"><button class="snippet--header" onClick="toggleCollapsible(&apos;q0913dc82-1ac8-471e-9134-95a92f89c7fc&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn update-user-contact
  [{:keys [additional-action-f
           additional-security-f
           client-rate-limit-exceeded-f
           ip-address-blacklist-f
           ip-address-valid-f
           permission-granted-f
           security-code-correct-f
           security-code-device-matches-f
           security-code-expired-f
           security-code-sent-f
           security-code-valid-f
           update-user-contact-f
           user-agent-blacklist-f
           user-agent-valid-f
           user-authenticated-f
           user-contact-registered-f
           user-contact-valid-f
           user-exists-f
           user-password-correct-f
           user-password-valid-f
           user-rate-limit-exceeded-f]}]
  (cond (and ip-address-valid-f             (not     (ip-address-valid-f)))             {:body :invalid-request/invalid-ip-address                    :status 400}
        (and user-agent-valid-f             (not     (user-agent-valid-f)))             {:body :invalid-request/invalid-user-agent                    :status 400}
        (and client-rate-limit-exceeded-f   (boolean (client-rate-limit-exceeded-f)))   {:body :too-many-requests/client-rate-limit-exceeded          :status 429}
        (and user-rate-limit-exceeded-f     (boolean (user-rate-limit-exceeded-f)))     {:body :too-many-requests/user-rate-limit-exceeded            :status 429}
        (and ip-address-blacklist-f         (boolean (ip-address-blacklist-f)))         {:body :forbidden-request/blacklisted-ip-address              :status 403}
        (and user-agent-blacklist-f         (boolean (user-agent-blacklist-f)))         {:body :forbidden-request/blacklisted-user-agent              :status 403}
        (and permission-granted-f           (not     (permission-granted-f)))           {:body :forbidden-request/permission-denied                   :status 403}
        (and user-authenticated-f           (not     (user-authenticated-f)))           {:body :forbidden-request/user-unauthenticated                :status 403}
        (and user-exists-f                  (not     (user-exists-f)))                  {:body :forbidden-request/user-not-exists                     :status 403}
        (and user-password-valid-f          (not     (user-password-valid-f)))          {:body :forbidden-request/invalid-user-password-received      :status 403}
        (and user-contact-valid-f           (not     (user-contact-valid-f)))           {:body :forbidden-request/invalid-user-contact-received       :status 403}
        (and security-code-valid-f          (not     (security-code-valid-f)))          {:body :forbidden-request/invalid-security-code-received      :status 403}
        (and user-contact-registered-f      (boolean (user-contact-registered-f)))      {:body :forbidden-request/registered-user-contact-received    :status 403}
        (and security-code-sent-f           (not     (security-code-sent-f)))           {:body :forbidden-request/no-security-code-sent-in-timeframe  :status 403}
        (and security-code-device-matches-f (not     (security-code-device-matches-f))) {:body :forbidden-request/security-code-device-not-matches    :status 403}
        (and user-password-correct-f        (not     (user-password-correct-f)))        {:body :unauthorized-request/incorrect-user-password-received :status 401}
        (and security-code-correct-f        (not     (security-code-correct-f)))        {:body :unauthorized-request/incorrect-security-code-received :status 401}
        (and security-code-expired-f        (boolean (security-code-expired-f)))        {:body :unauthorized-request/expired-security-code-received   :status 401}
        (and additional-security-f          (not     (additional-security-f)))          {:body :unknown-error/additional-security-stage-failed        :status 520}
        (and additional-action-f            (not     (additional-action-f)))            {:body :unknown-error/additional-action-stage-failed          :status 520}
        (not (update-user-contact-f)) {:body :server-error/unable-to-update-user-contact :status 500}
        :user-contact-updated         {:body :performed-request/user-contact-updated     :status 200}))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qeda4fbd3-940c-46c6-aa1b-a3dd1d5eedd7"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for user contact (email address / phone number) update (for authenticated users) with optional user password<br>  and/or security code verification.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qb28082f5-fb65-4e63-859e-46337a8d3d09"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qb31e1dea-7134-4de1-8fc6-0c3a43771c9f"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(update-user-contact {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qf76a413e-e8b9-4b8c-aeb8-8a1f4c7070b0"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(update-user-contact {...})<br>=&gt;<br>{:body :performed-request/user-contact-updated :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qd67ccfca-840e-4b63-b258-f8a50975efb2"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        email-address (-&gt; request :params :email-address)<br>        user-password (-&gt; request :params :password)<br>        security-code (-&gt; request :params :security-code)<br>        user-id       (-&gt; request :session :user-id)]<br>       (update-user-contact {:client-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-ip-address?                 ip-address)<br>                             :security-code-correct-f        #(my-database/security-code-matches?                              user-id security-code)<br>                             :security-code-device-matches-f #(my-log-service/security-code-required-from-the-same-ip-address? user-id ip-address)<br>                             :security-code-expired-f        #(my-database/security-code-expired?                              user-id)<br>                             :security-code-sent-f           #(my-database/security-code-sent?                                 user-id)<br>                             :security-code-valid-f          #(my-validator/security-code-valid?                               security-code)<br>                             :update-user-contact-f          #(my-database/update-user-email-address!                          user-id email-address)<br>                             :user-authenticated-f           #(my-validator/request-has-valid-session?                         request)<br>                             :user-contact-registered-f      #(my-database/email-address-registered?                           email-address)<br>                             :user-contact-valid-f           #(my-validator/email-address-valid?                               email-address)<br>                             :user-exists-f                  #(my-database/user-id-exists?                                     user-id)<br>                             :user-password-correct-f        #(my-database/user-password-matches?                              user-password)<br>                             :user-password-valid-f          #(my-validator/user-password-valid?                               user-password)<br>                             :user-rate-limit-exceeded-f     #(my-log-service/too-many-attempts-by-user-id?                    user-id)})))<br>=&gt;<br>{:body :performed-request/user-contact-updated :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qdb402dc7-9718-48e1-a052-312f9c16da7b"><button class="snippet--header" onClick="toggleCollapsible(&apos;qdb402dc7-9718-48e1-a052-312f9c16da7b&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)            Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)          Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :ip-address-blacklist-f (function)(opt)         Must return TRUE if the IP address is blacklisted.<br> :ip-address-valid-f (function)(opt)             Must return TRUE if the IP address is valid.<br> :permission-granted-f (function)(opt)           Must return TRUE if the user has permission to do the action.<br> :security-code-correct-f (function)(opt)        Must return TRUE if the received security code is correct.<br> :security-code-device-matches-f (function)(opt) Must return TRUE if the received security code has been required from the same device.<br> :security-code-expired-f (function)(opt)        Must return TRUE if the received security code has been expired.<br> :security-code-sent-f (function)(opt)           Must return TRUE if a security code has been sent recently.<br> :security-code-valid-f (function)(opt)          Must return TRUE if the received security code is valid.<br> :update-user-contact-f (function)               Side-effect function for updating the user contact. Applied when every security check has been passed. Must return TRUE if the user contact (email address / phone number) has been successfully updated.<br> :user-agent-blacklist-f (function)(opt)         Must return TRUE if the user agent is blacklisted.<br> :user-agent-valid-f (function)(opt)             Must return TRUE if the user agent is valid.<br> :user-authenticated-f (function)(opt)           Must return TRUE the user is authenticated / logged in.<br> :user-contact-registered-f (function)(opt)      Must return TRUE if the received user contact (email address / phone number) is registered.<br> :user-contact-valid-f (function)(opt)           Must return TRUE if the received user contact (email address / phone number) is valid.<br> :user-exists-f (function)(opt)                  Must return TRUE the user exists.<br> :user-password-correct-f (function)(opt)        Must return TRUE if the received user password is correct.<br> :user-password-valid-f (function)(opt)          Must return TRUE if the received user password is valid.<br> :user-rate-limit-exceeded-f (function)(opt)     Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q0ab7d900-6b01-49f1-8e16-feefd2798167"><button class="snippet--header" onClick="toggleCollapsible(&apos;q0ab7d900-6b01-49f1-8e16-feefd2798167&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword)<br>  :forbidden-request/blacklisted-ip-address              (IP address of client device is blacklisted)<br>  :forbidden-request/blacklisted-user-agent              (User agent of client device is blacklisted)<br>  :forbidden-request/invalid-user-contact-received       (Invalid user contact (email address / phone number) has been received)<br>  :forbidden-request/invalid-security-code-received      (Invalid security code has been received)<br>  :forbidden-request/invalid-user-password-received      (Invalid user password has been received)<br>  :forbidden-request/no-security-code-sent-in-timeframe  (No security code has been sent in a specific timeframe)<br>  :forbidden-request/permission-denied                   (The user has no permission to do the action)<br>  :forbidden-request/registered-user-contact-received    (Registered user contact (email address / phone number) has been received)<br>  :forbidden-request/security-code-device-not-matches    (The received security code has been required from another device)<br>  :forbidden-request/user-not-exists                     (The user ID does not exist)<br>  :forbidden-request/user-unauthenticated                (The user is unauthenticated / not logged in)<br>  :invalid-request/invalid-ip-address                    (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                    (No valid user agent has been found in the request)<br>  :performed-request/user-contact-updated                (The server has been successfully updated the user's email address / phone number)<br>  :server-error/unable-to-update-user-contact            (The server cannot update the user's email address / phone number)<br>  :too-many-requests/client-rate-limit-exceeded          (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded            (Too many actions have been attempted by the user in a specific timeframe)<br>  :unauthorized-request/expired-security-code-received   (Expired security code has been received)<br>  :unauthorized-request/incorrect-security-code-received (Incorrect security code has been received)<br>  :unauthorized-request/incorrect-user-password-received (Incorrect user password has been received)<br>  :unknown-error/additional-action-stage-failed          (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed        (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 401, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="update-user-data"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">update-user-data</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q540fd85b-d125-406b-bc8c-2c9f732bdaa4"><button class="snippet--header" onClick="toggleCollapsible(&apos;q540fd85b-d125-406b-bc8c-2c9f732bdaa4&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn update-user-data
  [{:keys [additional-action-f
           additional-security-f
           client-rate-limit-exceeded-f
           ip-address-blacklist-f
           ip-address-valid-f
           permission-granted-f
           update-user-data-f
           user-agent-blacklist-f
           user-agent-valid-f
           user-authenticated-f
           user-data-valid-f
           user-exists-f
           user-rate-limit-exceeded-f]}]
  (cond (and ip-address-valid-f           (not     (ip-address-valid-f)))           {:body :invalid-request/invalid-ip-address             :status 400}
        (and user-agent-valid-f           (not     (user-agent-valid-f)))           {:body :invalid-request/invalid-user-agent             :status 400}
        (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded   :status 429}
        (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded     :status 429}
        (and ip-address-blacklist-f       (boolean (ip-address-blacklist-f)))       {:body :forbidden-request/blacklisted-ip-address       :status 403}
        (and user-agent-blacklist-f       (boolean (user-agent-blacklist-f)))       {:body :forbidden-request/blacklisted-user-agent       :status 403}
        (and permission-granted-f         (not     (permission-granted-f)))         {:body :forbidden-request/permission-denied            :status 403}
        (and user-authenticated-f         (not     (user-authenticated-f)))         {:body :forbidden-request/user-unauthenticated         :status 403}
        (and user-exists-f                (not     (user-exists-f)))                {:body :forbidden-request/user-not-exists              :status 403}
        (and user-data-valid-f            (not     (user-data-valid-f)))            {:body :forbidden-request/invalid-user-data-received   :status 403}
        (and additional-security-f        (not     (additional-security-f)))        {:body :unknown-error/additional-security-stage-failed :status 520}
        (and additional-action-f          (not     (additional-action-f)))          {:body :unknown-error/additional-action-stage-failed   :status 520}
        (not (update-user-data-f)) {:body :server-error/unable-to-update-user-data :status 500}
        :user-account-updated      {:body :performed-request/user-data-updated     :status 200}))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qe016d48f-1eb1-4f56-908c-2e8299de525a"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for user data update (for authenticated users).<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q0c379a35-4a3d-40c2-a0b4-6bc2d8513975"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For updating user contact data (email address / phone number), or username, or user password use (the) specific protocol functions for these actions!<br>- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qc79d44b5-716d-4609-8bf9-c60e01ae659b"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(update-user-data {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q8d604666-b971-4c4f-b590-568eb3337013"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(update-user-data {...})<br>=&gt;<br>{:body :performed-request/user-data-updated :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qb0d7cba8-3a08-4ff0-a2d4-263460285e8d"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address (-&gt; request :remote-addr)<br>        user-data  (-&gt; request :params)<br>        user-id    (-&gt; request :session :user-id)]<br>       (update-user-data {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address? ip-address)<br>                          :update-user-data-f           #(my-database/update-user-data!                   user-id user-data)<br>                          :user-authenticated-f         #(my-validator/request-has-valid-session?         request)<br>                          :user-data-valid-f            #(my-validator/user-data-valid?                   user-data)<br>                          :user-exists-f                #(my-database/user-id-exists?                     user-id)<br>                          :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-user-id?    user-id)})))<br>=&gt;<br>{:body :performed-request/user-data-updated :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qb54a2d89-9a58-4365-88fe-4d860063c77b"><button class="snippet--header" onClick="toggleCollapsible(&apos;qb54a2d89-9a58-4365-88fe-4d860063c77b&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :ip-address-blacklist-f (function)(opt)       Must return TRUE if the IP address is blacklisted.<br> :ip-address-valid-f (function)(opt)           Must return TRUE if the IP address is valid.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :update-user-data-f (function)                Side-effect function for updating the user data. Applied when every security check has been passed. Must return TRUE if the user data has been successfully updated.<br> :user-agent-blacklist-f (function)(opt)       Must return TRUE if the user agent is blacklisted.<br> :user-agent-valid-f (function)(opt)           Must return TRUE if the user agent is valid.<br> :user-authenticated-f (function)(opt)         Must return TRUE the user is authenticated / logged in.<br> :user-data-valid-f (function)(opt)            Must return TRUE if the received user data is valid.<br> :user-exists-f (function)(opt)                Must return TRUE the user exists.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q635b9348-5d6f-48b9-84a5-c494652ea5d6"><button class="snippet--header" onClick="toggleCollapsible(&apos;q635b9348-5d6f-48b9-84a5-c494652ea5d6&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword)<br>  :forbidden-request/blacklisted-ip-address       (IP address of client device is blacklisted)<br>  :forbidden-request/blacklisted-user-agent       (User agent of client device is blacklisted)<br>  :forbidden-request/invalid-user-data-received   (Invalid user data has been received)<br>  :forbidden-request/permission-denied            (The user has no permission to do the action)<br>  :forbidden-request/user-not-exists              (The user ID does not exist)<br>  :forbidden-request/user-unauthenticated         (The user is unauthenticated / not logged in)<br>  :invalid-request/invalid-ip-address             (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent             (No valid user agent has been found in the request)<br>  :performed-request/user-data-updated            (The server has been successfully updated the user data)<br>  :server-error/unable-to-update-user-data        (The server cannot update the user data)<br>  :too-many-requests/client-rate-limit-exceeded   (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded     (Too many actions have been attempted by the user in a specific timeframe)<br>  :unknown-error/additional-action-stage-failed   (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="verify-security-code-authenticated"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">verify-security-code-authenticated</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="qf8f8c2fb-3646-46f6-b0fd-b0023d19d1e6"><button class="snippet--header" onClick="toggleCollapsible(&apos;qf8f8c2fb-3646-46f6-b0fd-b0023d19d1e6&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn verify-security-code-authenticated
  [{:keys [additional-action-f
           additional-security-f
           client-rate-limit-exceeded-f
           ip-address-blacklist-f
           ip-address-valid-f
           permission-granted-f
           security-code-correct-f
           security-code-device-matches-f
           security-code-expired-f
           security-code-sent-f
           security-code-valid-f
           user-agent-blacklist-f
           user-agent-valid-f
           user-authenticated-f
           user-exists-f
           user-rate-limit-exceeded-f]}]
  (cond (and ip-address-valid-f             (not     (ip-address-valid-f)))             {:body :invalid-request/invalid-ip-address                   :status 400}
        (and user-agent-valid-f             (not     (user-agent-valid-f)))             {:body :invalid-request/invalid-user-agent                   :status 400}
        (and client-rate-limit-exceeded-f   (boolean (client-rate-limit-exceeded-f)))   {:body :too-many-requests/client-rate-limit-exceeded         :status 429}
        (and user-rate-limit-exceeded-f     (boolean (user-rate-limit-exceeded-f)))     {:body :too-many-requests/user-rate-limit-exceeded           :status 429}
        (and ip-address-blacklist-f         (boolean (ip-address-blacklist-f)))         {:body :forbidden-request/blacklisted-ip-address             :status 403}
        (and user-agent-blacklist-f         (boolean (user-agent-blacklist-f)))         {:body :forbidden-request/blacklisted-user-agent             :status 403}
        (and permission-granted-f           (not     (permission-granted-f)))           {:body :forbidden-request/permission-denied                  :status 403}
        (and user-authenticated-f           (not     (user-authenticated-f)))           {:body :forbidden-request/user-unauthenticated               :status 403}
        (and user-exists-f                  (not     (user-exists-f)))                  {:body :forbidden-request/user-not-exists                    :status 403}
        (and security-code-valid-f          (not     (security-code-valid-f)))          {:body :forbidden-request/invalid-security-code-received     :status 403}
        (and security-code-sent-f           (not     (security-code-sent-f)))           {:body :forbidden-request/no-security-code-sent-in-timeframe :status 403}
        (and security-code-device-matches-f (not     (security-code-device-matches-f))) {:body :forbidden-request/security-code-device-not-matches   :status 403}
        (and security-code-expired-f        (boolean (security-code-expired-f)))        {:body :unauthorized-request/expired-security-code-received  :status 401}
        (and additional-security-f          (not     (additional-security-f)))          {:body :unknown-error/additional-security-stage-failed       :status 520}
        (and additional-action-f            (not     (additional-action-f)))            {:body :unknown-error/additional-action-stage-failed         :status 520}
        (not (security-code-correct-f)) {:body :unauthorized-request/incorrect-security-code-received :status 401}
        :security-code-verified         {:body :performed-request/correct-security-code-received      :status 200}))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q91160ec4-41a3-4db0-a684-730bc33d43fa"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for verifying a security code (for authenticated users) sent via email / SMS.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q0d60e9e4-9c01-429c-a282-986921f43c8a"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q3194a438-7d83-4986-bf3a-3762171e08be"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(verify-security-code-authenticated {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qac2c9601-510b-4805-bbfb-ee5b18f8c192"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(verify-security-code-authenticated {...})<br>=&gt;<br>{:body :performed-request/correct-security-code-received :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q0b1da9d3-a889-4683-a47d-cc0acac1584e"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        security-code (-&gt; request :params :security-code)<br>        user-id       (-&gt; request :session :user-id)]<br>       (verify-security-code-authenticated {:client-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-ip-address?                 ip-address)<br>                                            :security-code-correct-f        #(my-database/security-code-matches?                              user-id security-code)<br>                                            :security-code-expired-f        #(my-database/security-code-expired?                              user-id)<br>                                            :security-code-device-matches-f #(my-log-service/security-code-required-from-the-same-ip-address? user-id ip-address)<br>                                            :security-code-sent-f           #(my-database/security-code-sent?                                 user-id)<br>                                            :security-code-valid-f          #(my-validator/security-code-valid?                               security-code)<br>                                            :user-authenticated-f           #(my-validator/request-has-valid-session?                         request)<br>                                            :user-exists-f                  #(my-database/user-id-exists?                                     user-id)<br>                                            :user-rate-limit-exceeded-f     #(my-log-service/too-many-attempts-by-user-id?                    user-id)})))<br>=&gt;<br>{:body :performed-request/correct-security-code-received :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q51226e00-50dd-4b5a-9dba-642c1c240b8d"><button class="snippet--header" onClick="toggleCollapsible(&apos;q51226e00-50dd-4b5a-9dba-642c1c240b8d&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)            Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)          Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :ip-address-blacklist-f (function)(opt)         Must return TRUE if the IP address is blacklisted.<br> :ip-address-valid-f (function)(opt)             Must return TRUE if the IP address is valid.<br> :permission-granted-f (function)(opt)           Must return TRUE if the user has permission to do the action.<br> :security-code-correct-f (function)             Must return TRUE if the received security code is correct.<br> :security-code-device-matches-f (function)(opt) Must return TRUE if the received security code has been required from the same device.<br> :security-code-expired-f (function)(opt)        Must return TRUE if the received security code has been expired.<br> :security-code-sent-f (function)(opt)           Must return TRUE if a security code has been sent recently.<br> :security-code-valid-f (function)(opt)          Must return TRUE if the received security code is valid.<br> :user-agent-blacklist-f (function)(opt)         Must return TRUE if the user agent is blacklisted.<br> :user-agent-valid-f (function)(opt)             Must return TRUE if the user agent is valid.<br> :user-authenticated-f (function)(opt)           Must return TRUE the user is authenticated / logged in.<br> :user-exists-f (function)(opt)                  Must return TRUE the user exists.<br> :user-rate-limit-exceeded-f (function)(opt)     Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q034a5c23-6524-40d2-a325-dd57231e01d4"><button class="snippet--header" onClick="toggleCollapsible(&apos;q034a5c23-6524-40d2-a325-dd57231e01d4&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword)<br>  :forbidden-request/blacklisted-ip-address              (IP address of client device is blacklisted)<br>  :forbidden-request/blacklisted-user-agent              (User agent of client device is blacklisted)<br>  :forbidden-request/invalid-security-code-received      (Invalid security code has been received)<br>  :forbidden-request/no-security-code-sent-in-timeframe  (No security code has been sent in a specific timeframe)<br>  :forbidden-request/permission-denied                   (The user has no permission to do the action)<br>  :forbidden-request/security-code-device-not-matches    (The received security code has been required from another device)<br>  :forbidden-request/user-not-exists                     (The user ID does not exist)<br>  :forbidden-request/user-unauthenticated                (The user is unauthenticated / not logged in)<br>  :invalid-request/invalid-ip-address                    (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                    (No valid user agent has been found in the request)<br>  :performed-request/correct-security-code-received      (Correct security code has been received)<br>  :too-many-requests/client-rate-limit-exceeded          (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded            (Too many actions have been attempted by the user in a specific timeframe)<br>  :unauthorized-request/incorrect-security-code-received (Incorrect security code has been received)<br>  :unauthorized-request/expired-security-code-received   (Expired security code has been received)<br>  :unknown-error/additional-action-stage-failed          (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed        (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 401, 403, 429, 520}</pre></div></div></div></div><div class="section" id="verify-security-code-unauthenticated"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">verify-security-code-unauthenticated</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q1644fb98-9780-4e90-bc17-df03b309a59d"><button class="snippet--header" onClick="toggleCollapsible(&apos;q1644fb98-9780-4e90-bc17-df03b309a59d&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn verify-security-code-unauthenticated
  [{:keys [additional-action-f
           additional-security-f
           client-rate-limit-exceeded-f
           ip-address-blacklist-f
           ip-address-valid-f
           permission-granted-f
           provide-user-session-f
           security-code-correct-f
           security-code-device-matches-f
           security-code-expired-f
           security-code-sent-f
           security-code-valid-f
           user-agent-blacklist-f
           user-agent-valid-f
           user-authenticated-f
           user-identifier-registered-f
           user-identifier-valid-f
           user-identifier-verified-f
           user-password-correct-f
           user-password-valid-f
           user-rate-limit-exceeded-f]}]
  (cond (and ip-address-valid-f             (not     (ip-address-valid-f)))             {:body :invalid-request/invalid-ip-address                      :status 400}
        (and user-agent-valid-f             (not     (user-agent-valid-f)))             {:body :invalid-request/invalid-user-agent                      :status 400}
        (and client-rate-limit-exceeded-f   (boolean (client-rate-limit-exceeded-f)))   {:body :too-many-requests/client-rate-limit-exceeded            :status 429}
        (and user-rate-limit-exceeded-f     (boolean (user-rate-limit-exceeded-f)))     {:body :too-many-requests/user-rate-limit-exceeded              :status 429}
        (and ip-address-blacklist-f         (boolean (ip-address-blacklist-f)))         {:body :forbidden-request/blacklisted-ip-address                :status 403}
        (and user-agent-blacklist-f         (boolean (user-agent-blacklist-f)))         {:body :forbidden-request/blacklisted-user-agent                :status 403}
        (and permission-granted-f           (not     (permission-granted-f)))           {:body :forbidden-request/permission-denied                     :status 403}
        (and user-authenticated-f           (boolean (user-authenticated-f)))           {:body :forbidden-request/user-authenticated                    :status 403}
        (and user-identifier-valid-f        (not     (user-identifier-valid-f)))        {:body :forbidden-request/invalid-user-identifier-received      :status 403}
        (and user-password-valid-f          (not     (user-password-valid-f)))          {:body :forbidden-request/invalid-user-password-received        :status 403}
        (and security-code-valid-f          (not     (security-code-valid-f)))          {:body :forbidden-request/invalid-security-code-received        :status 403}
        (and security-code-sent-f           (not     (security-code-sent-f)))           {:body :forbidden-request/no-security-code-sent-in-timeframe    :status 403}
        (and user-identifier-registered-f   (not     (user-identifier-registered-f)))   {:body :forbidden-request/unregistered-user-identifier-received :status 403}
        (and security-code-device-matches-f (not     (security-code-device-matches-f))) {:body :forbidden-request/security-code-device-not-matches      :status 403}
        (and user-identifier-verified-f     (not     (user-identifier-verified-f)))     {:body :forbidden-request/unverified-user-identifier-received   :status 403}
        (and user-password-correct-f        (not     (user-password-correct-f)))        {:body :unauthorized-request/incorrect-user-password-received   :status 401}
        (and security-code-expired-f        (boolean (security-code-expired-f)))        {:body :unauthorized-request/expired-security-code-received     :status 401}
        (and additional-security-f          (not     (additional-security-f)))          {:body :unknown-error/additional-security-stage-failed          :status 520}
        (and additional-action-f            (not     (additional-action-f)))            {:body :unknown-error/additional-action-stage-failed            :status 520}
        (not (security-code-correct-f)) {:body :unauthorized-request/incorrect-security-code-received :status 401}
        (not provide-user-session-f)    {:body :performed-request/correct-security-code-received      :status 200}
        :providing-user-session         (if-let [response (provide-user-session-f {:body :performed-request/ready-to-provide-user-session :status 200})]
                                                (-&gt;&gt; {:body :performed-request/user-session-provided     :status 200} (merge response))
                                                (-&gt;  {:body :server-error/unable-to-provide-user-session :status 500}))))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q2ac8fd5e-2298-40b2-99e8-9039a92e6bc6"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for verifying a security code (for unauthenticated users) sent via email / SMS.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q439a7769-1c0b-4583-a3b3-76fc949b11da"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).<br>- In case the 'provide-user-session-f' function is passed, no security check has been failed, and the received security code is correct,<br>  it applies the 'provide-user-session-f' function on the HTTP response.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q5d8570c2-a74c-4277-baf4-300925c7fd57"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(verify-security-code-unauthenticated {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q7f3912d0-99cd-4a22-9bdb-44579dd2bb24"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(verify-security-code-unauthenticated {...})<br>=&gt;<br>{:body :performed-request/correct-security-code-received :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qebd8011f-8cdf-48a9-8328-c1480f8d61a3"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        email-address (-&gt; request :params :email-address)<br>        user-password (-&gt; request :params :password)<br>        security-code (-&gt; request :params :security-code)]<br>       (verify-security-code-unauthenticated {:client-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-ip-address?                 ip-address)<br>                                              :provide-user-session-f         #(my-session-handler/add-session-to-response                      %)<br>                                              :security-code-correct-f        #(my-database/security-code-matches?                              email-address security-code)<br>                                              :security-code-device-matches-f #(my-log-service/security-code-required-from-the-same-ip-address? email-address ip-address)<br>                                              :security-code-expired-f        #(my-database/security-code-expired?                              email-address)<br>                                              :security-code-sent-f           #(my-database/security-code-sent?                                 email-address)<br>                                              :security-code-valid-f          #(my-validator/security-code-valid?                               security-code)<br>                                              :user-authenticated-f           #(my-validator/request-has-valid-session?                         request)<br>                                              :user-identifier-registered-f   #(my-database/email-address-registered?                           email-address)<br>                                              :user-identifier-valid-f        #(my-validator/email-address-valid?                               email-address)<br>                                              :user-identifier-verified-f     #(my-database/email-address-verified?                             email-address)<br>                                              :user-password-correct-f        #(my-database/user-password-matches?                              user-password)<br>                                              :user-password-valid-f          #(my-validator/user-password-valid?                               user-password)<br>                                              :user-rate-limit-exceeded-f     #(my-log-service/too-many-attempts-by-email-address?              email-address)})))<br>=&gt;<br>{:body :performed-request/correct-security-code-received :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qa4a73afd-e648-4fa4-ba6d-01fa7911e261"><button class="snippet--header" onClick="toggleCollapsible(&apos;qa4a73afd-e648-4fa4-ba6d-01fa7911e261&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)            Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)          Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :ip-address-blacklist-f (function)(opt)         Must return TRUE if the IP address is blacklisted.<br> :ip-address-valid-f (function)(opt)             Must return TRUE if the IP address is valid.<br> :permission-granted-f (function)(opt)           Must return TRUE if the user has permission to do the action.<br> :provide-user-session-f (function)(opt)         Must take the response as parameter, and associate a user session to it (return NIL in case of error).<br> :security-code-correct-f (function)             Must return TRUE if the received security code is correct.<br> :security-code-device-matches-f (function)(opt) Must return TRUE if the received security code has been required from the same device.<br> :security-code-expired-f (function)(opt)        Must return TRUE if the received security code has been expired.<br> :security-code-sent-f (function)(opt)           Must return TRUE if a security code has been sent recently.<br> :security-code-valid-f (function)(opt)          Must return TRUE if the received security code is valid.<br> :user-agent-blacklist-f (function)(opt)         Must return TRUE if the user agent is blacklisted.<br> :user-agent-valid-f (function)(opt)             Must return TRUE if the user agent is valid.<br> :user-authenticated-f (function)(opt)           Must return TRUE the user is authenticated / logged in.<br> :user-identifier-registered-f (function)(opt)   Must return TRUE if the received user identifier (email address / phone number / username) is registered.<br> :user-identifier-valid-f (function)(opt)        Must return TRUE if the received user identifier (email address / phone number / username) is valid.<br> :user-identifier-verified-f (function)(opt)     Must return TRUE if the received user identifier (if contact: email address / phone number) is verified.<br> :user-password-correct-f (function)(opt)        Must return TRUE if the received user password is correct.<br> :user-password-valid-f (function)(opt)          Must return TRUE if the received user password is valid.<br> :user-rate-limit-exceeded-f (function)(opt)     Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qeb42f876-be1c-4cb8-ae5a-297f49f3c926"><button class="snippet--header" onClick="toggleCollapsible(&apos;qeb42f876-be1c-4cb8-ae5a-297f49f3c926&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword)<br>  :forbidden-request/blacklisted-ip-address                (IP address of client device is blacklisted)<br>  :forbidden-request/blacklisted-user-agent                (User agent of client device is blacklisted)<br>  :forbidden-request/invalid-security-code-received        (Invalid security code has been received)<br>  :forbidden-request/invalid-user-identifier-received      (Invalid user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/invalid-user-password-received        (Invalid user password has been received)<br>  :forbidden-request/no-security-code-sent-in-timeframe    (No security code has been sent in a specific timeframe)<br>  :forbidden-request/permission-denied                     (The user has no permission to do the action)<br>  :forbidden-request/security-code-device-not-matches      (The received security code has been required from another device)<br>  :forbidden-request/unregistered-user-identifier-received (Unregistered user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/user-authenticated                    (The user is authenticated / logged in)<br>  :invalid-request/invalid-ip-address                      (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                      (No valid user agent has been found in the request)<br>  :performed-request/correct-security-code-received        (Correct security code has been received)<br>  :performed-request/user-session-provided                 (The server has been successfully provided a user session to the HTTP response)<br>  :server-error/unable-to-provide-user-session             (The server cannot provide the user session to the HTTP response)<br>  :too-many-requests/client-rate-limit-exceeded            (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded              (Too many actions have been attempted by the user in a specific timeframe)<br>  :unauthorized-request/expired-security-code-received     (Expired security code has been received)<br>  :unauthorized-request/incorrect-security-code-received   (Incorrect security code has been received)<br>  :unauthorized-request/incorrect-user-password-received   (Incorrect user password has been received)<br>  :unknown-error/additional-action-stage-failed            (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed          (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 401, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="verify-user-password"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">verify-user-password</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q9dbe76d1-b62c-4eae-bd2d-331172b70bf1"><button class="snippet--header" onClick="toggleCollapsible(&apos;q9dbe76d1-b62c-4eae-bd2d-331172b70bf1&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn verify-user-password
  [{:keys [additional-action-f
           additional-security-f
           client-rate-limit-exceeded-f
           ip-address-blacklist-f
           ip-address-valid-f
           permission-granted-f
           provide-user-session-f
           send-security-code-f
           user-agent-blacklist-f
           user-agent-valid-f
           user-authenticated-f
           user-identifier-registered-f
           user-identifier-valid-f
           user-identifier-verified-f
           user-password-correct-f
           user-password-valid-f
           user-rate-limit-exceeded-f]}]
  (cond (and ip-address-valid-f           (not     (ip-address-valid-f)))           {:body :invalid-request/invalid-ip-address                      :status 400}
        (and user-agent-valid-f           (not     (user-agent-valid-f)))           {:body :invalid-request/invalid-user-agent                      :status 400}
        (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded            :status 429}
        (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded              :status 429}
        (and ip-address-blacklist-f       (boolean (ip-address-blacklist-f)))       {:body :forbidden-request/blacklisted-ip-address                :status 403}
        (and user-agent-blacklist-f       (boolean (user-agent-blacklist-f)))       {:body :forbidden-request/blacklisted-user-agent                :status 403}
        (and permission-granted-f         (not     (permission-granted-f)))         {:body :forbidden-request/permission-denied                     :status 403}
        (and user-authenticated-f         (boolean (user-authenticated-f)))         {:body :forbidden-request/user-authenticated                    :status 403}
        (and user-identifier-valid-f      (not     (user-identifier-valid-f)))      {:body :forbidden-request/invalid-user-identifier-received      :status 403}
        (and user-password-valid-f        (not     (user-password-valid-f)))        {:body :forbidden-request/invalid-user-password-received        :status 403}
        (and user-identifier-registered-f (not     (user-identifier-registered-f))) {:body :forbidden-request/unregistered-user-identifier-received :status 403}
        (and user-identifier-verified-f   (not     (user-identifier-verified-f)))   {:body :forbidden-request/unverified-user-identifier-received   :status 403}
        (and additional-security-f        (not     (additional-security-f)))        {:body :unknown-error/additional-security-stage-failed          :status 520}
        (and additional-action-f          (not     (additional-action-f)))          {:body :unknown-error/additional-action-stage-failed            :status 520}
        (not (user-password-correct-f))                         {:body :unauthorized-request/incorrect-user-password-received :status 401}
        (and send-security-code-f (not (send-security-code-f))) {:body :server-error/unable-to-send-security-code             :status 500}
        (and send-security-code-f)                              {:body :performed-request/security-code-sent                  :status 200}
        (not provide-user-session-f)                            {:body :performed-request/correct-user-password-received      :status 200}
        :providing-user-session                                 (if-let [response (provide-user-session-f {:body :performed-request/ready-to-provide-user-session :status 200})]
                                                                        (-&gt;&gt; {:body :performed-request/user-session-provided     :status 200} (merge response))
                                                                        (-&gt;  {:body :server-error/unable-to-provide-user-session :status 500}))))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q6dcb6800-60b9-46bf-8cd8-1e1af51106a9"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for user password verification (for unauthenticated users) and in case of correct user password has been<br>  received optionally sending an MFA security code / providing a user session.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q8138687e-300d-4664-9869-622ce8ead8da"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).<br>- In case the 'send-security-code-f' function is passed, no security check has been failed, and the received user password is correct,<br>  it applies the 'send-security-code-f' (it's a common scenario when the user credentials verification is followed by login code verification).<br>- In case the 'provide-user-session-f' function is passed, the 'send-security-code-f' function is NOT passed, no security check has<br>  been failed, and the received user password is correct, it applies the 'provide-user-session-f' function on the HTTP response.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q6950d59a-5a28-4f8e-a066-8e2f7a553234"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(verify-user-password {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qe6c6f3c1-68fb-4056-a610-797fa6bed002"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(verify-user-password {...})<br>=&gt;<br>{:body :performed-request/security-code-sent :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qfa8c2456-6606-4069-9b83-3f7de6bb7826"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        email-address (-&gt; request :params :email-address)<br>        user-password (-&gt; request :params :password)]<br>       (verify-user-password {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address?    ip-address)<br>                              :provide-user-session-f       #(my-session-handler/add-session-to-response         %)<br>                              :send-security-code-f         #(my-email-service/send-security-code-email!         email-address)<br>                              :user-authenticated-f         #(my-validator/request-has-valid-session?            request)<br>                              :user-identifier-registered-f #(my-database/email-address-registered?              email-address)<br>                              :user-identifier-valid-f      #(my-validator/email-address-valid?                  email-address)<br>                              :user-identifier-verified-f   #(my-database/email-address-verified?                email-address)<br>                              :user-password-correct-f      #(my-database/user-password-matches?                 user-password)<br>                              :user-password-valid-f        #(my-validator/user-password-valid?                  user-password)<br>                              :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-email-address? email-address)})))<br>=&gt;<br>{:body :performed-request/security-code-sent :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q6b5c3a8a-790b-4548-a823-de305d0bb823"><button class="snippet--header" onClick="toggleCollapsible(&apos;q6b5c3a8a-790b-4548-a823-de305d0bb823&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :ip-address-blacklist-f (function)(opt)       Must return TRUE if the IP address is blacklisted.<br> :ip-address-valid-f (function)(opt)           Must return TRUE if the IP address is valid.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :provide-user-session-f (function)(opt)       Must take the response as parameter, and associate a user session to it (return NIL in case of error).<br> :send-security-code-f (function)(opt)         Must return TRUE if the security code email / SMS has been successfully sent.<br> :user-agent-blacklist-f (function)(opt)       Must return TRUE if the user agent is blacklisted.<br> :user-agent-valid-f (function)(opt)           Must return TRUE if the user agent is valid.<br> :user-authenticated-f (function)(opt)         Must return TRUE the user is authenticated / logged in.<br> :user-identifier-registered-f (function)(opt) Must return TRUE if the received user identifier (email address / phone number / username) is registered.<br> :user-identifier-valid-f (function)(opt)      Must return TRUE if the received user identifier (email address / phone number / username) is valid.<br> :user-identifier-verified-f (function)(opt)   Must return TRUE if the received user identifier (if contact: email address / phone number) is verified.<br> :user-password-correct-f (function)(opt)      Must return TRUE if the received user password are correct.<br> :user-password-valid-f (function)(opt)        Must return TRUE if the received user password is valid.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qff7d7330-7ba7-4f19-a0f6-e24105c29303"><button class="snippet--header" onClick="toggleCollapsible(&apos;qff7d7330-7ba7-4f19-a0f6-e24105c29303&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword)<br>  :forbidden-request/blacklisted-ip-address                (IP address of client device is blacklisted)<br>  :forbidden-request/blacklisted-user-agent                (User agent of client device is blacklisted)<br>  :forbidden-request/invalid-user-identifier-received      (Invalid user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/invalid-user-password-received        (Invalid user password has been received)<br>  :forbidden-request/permission-denied                     (The user has no permission to do the action)<br>  :forbidden-request/unregistered-user-identifier-received (Unregistered user identifier (email address / phone number / username) has been received)<br>  :forbidden-request/unverified-user-identifier-received   (Unverified user identifier (if contact: email address / phone number) has been received)<br>  :forbidden-request/user-authenticated                    (The user is authenticated / logged in)<br>  :invalid-request/invalid-ip-address                      (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                      (No valid user agent has been found in the request)<br>  :performed-request/correct-user-password-received        (Correct user password has been received)<br>  :performed-request/security-code-sent                    (The server has been successfully sent the security code email / SMS to the user)<br>  :performed-request/user-session-provided                 (The server has been successfully provided a user session to the HTTP response)<br>  :server-error/unable-to-provide-user-session             (The server cannot provide the user session to the HTTP response)<br>  :server-error/unable-to-send-security-code               (The server cannot send the security code email / SMS to the user)<br>  :too-many-requests/client-rate-limit-exceeded            (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded              (Too many actions have been attempted by the user in a specific timeframe)<br>  :unauthorized-request/incorrect-user-password-received   (Incorrect user password has been received)<br>  :unknown-error/additional-action-stage-failed            (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed          (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 401, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="verify-user-pin-code"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">verify-user-pin-code</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q59ec6574-b535-487a-8e8d-4f752943235f"><button class="snippet--header" onClick="toggleCollapsible(&apos;q59ec6574-b535-487a-8e8d-4f752943235f&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn verify-user-pin-code
  [{:keys [additional-action-f
           additional-security-f
           client-rate-limit-exceeded-f
           ip-address-blacklist-f
           ip-address-valid-f
           permission-granted-f
           user-agent-blacklist-f
           user-agent-valid-f
           user-authenticated-f
           user-exists-f
           user-pin-code-correct-f
           user-pin-code-valid-f
           user-rate-limit-exceeded-f]}]
  (cond (and ip-address-valid-f           (not     (ip-address-valid-f)))           {:body :invalid-request/invalid-ip-address               :status 400}
        (and user-agent-valid-f           (not     (user-agent-valid-f)))           {:body :invalid-request/invalid-user-agent               :status 400}
        (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded     :status 429}
        (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded       :status 429}
        (and ip-address-blacklist-f       (boolean (ip-address-blacklist-f)))       {:body :forbidden-request/blacklisted-ip-address         :status 403}
        (and user-agent-blacklist-f       (boolean (user-agent-blacklist-f)))       {:body :forbidden-request/blacklisted-user-agent         :status 403}
        (and permission-granted-f         (not     (permission-granted-f)))         {:body :forbidden-request/permission-denied              :status 403}
        (and user-authenticated-f         (not     (user-authenticated-f)))         {:body :forbidden-request/user-unauthenticated           :status 403}
        (and user-exists-f                (not     (user-exists-f)))                {:body :forbidden-request/user-not-exists                :status 403}
        (and user-pin-code-valid-f        (not     (user-pin-code-valid-f)))        {:body :forbidden-request/invalid-user-pin-code-received :status 403}
        (and additional-security-f        (not     (additional-security-f)))        {:body :unknown-error/additional-security-stage-failed   :status 520}
        (and additional-action-f          (not     (additional-action-f)))          {:body :unknown-error/additional-action-stage-failed     :status 520}
        (not (user-pin-code-correct-f)) {:body :unauthorized-request/incorrect-user-pin-code-received :status 401}
        :user-pin-code-verified         {:body :performed-request/correct-user-pin-code-received      :status 200}))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q8d8ab0b8-cabf-4b12-a1f7-746b87873c9d"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for user PIN code verification (for authenticated users).<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q0cd47e87-b9b8-4be2-be0c-f18760904740"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q1ed3c9b8-fc60-4ee3-8b6f-8af00bd5aae5"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(verify-user-pin-code {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q961362c0-4742-47fb-a3a3-b1e9ddedcea4"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(verify-user-pin-code {...})<br>=&gt;<br>{:body :performed-request/correct-user-pin-code-received :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qb55467b2-8219-472b-b1d1-a357b63c53e8"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address    (-&gt; request :remote-addr)<br>        user-pin-code (-&gt; request :params :pin-code)<br>        user-id       (-&gt; request :session :user-id)]<br>       (verify-user-pin-code {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address? ip-address)<br>                              :user-authenticated-f         #(my-validator/request-has-valid-session?         request)<br>                              :user-exists-f                #(my-database/user-id-exists?                     user-id)<br>                              :user-pin-code-correct-f      #(my-database/user-pin-code-matches?              user-pin-code)<br>                              :user-pin-code-valid-f        #(my-validator/user-pin-code-valid?               user-pin-code)<br>                              :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-user-id?    user-id)})))<br>=&gt;<br>{:body :performed-request/correct-user-pin-code-received :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qb33698d6-5c81-4494-87d5-47088561c78e"><button class="snippet--header" onClick="toggleCollapsible(&apos;qb33698d6-5c81-4494-87d5-47088561c78e&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :ip-address-blacklist-f (function)(opt)       Must return TRUE if the IP address is blacklisted.<br> :ip-address-valid-f (function)(opt)           Must return TRUE if the IP address is valid.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :user-agent-blacklist-f (function)(opt)       Must return TRUE if the user agent is blacklisted.<br> :user-agent-valid-f (function)(opt)           Must return TRUE if the user agent is valid.<br> :user-authenticated-f (function)(opt)         Must return TRUE the user is authenticated / logged in.<br> :user-exists-f (function)(opt)                Must return TRUE the user exists.<br> :user-pin-code-correct-f (function)           Must return TRUE if the received user PIN code is correct.<br> :user-pin-code-valid-f (function)(opt)        Must return TRUE if the received user PIN code is valid.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q98d6e03f-c351-496b-aa1c-295d9c37dfbf"><button class="snippet--header" onClick="toggleCollapsible(&apos;q98d6e03f-c351-496b-aa1c-295d9c37dfbf&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword)<br>  :forbidden-request/blacklisted-ip-address              (IP address of client device is blacklisted)<br>  :forbidden-request/blacklisted-user-agent              (User agent of client device is blacklisted)<br>  :forbidden-request/invalid-user-pin-code-received      (Invalid user PIN code has been received)<br>  :forbidden-request/permission-denied                   (The user has no permission to do the action)<br>  :forbidden-request/user-not-exists                     (The user ID does not exist)<br>  :forbidden-request/user-unauthenticated                (The user is unauthenticated / not logged in)<br>  :invalid-request/invalid-ip-address                    (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent                    (No valid user agent has been found in the request)<br>  :performed-request/correct-user-pin-code-received      (Correct user PIN code has been received)<br>  :too-many-requests/client-rate-limit-exceeded          (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded            (Too many actions have been attempted by the user in a specific timeframe)<br>  :unauthorized-request/incorrect-user-pin-code-received (Incorrect user PIN code has been received)<br>  :unknown-error/additional-action-stage-failed          (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed        (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 401, 403, 429, 520}</pre></div></div></div></div></div><div id="top-bar"><pre class="text--xxl text--bold" id="top-bar--library-name">clj-security-protocols</pre><pre class="color--soft-grey text--s" id="top-bar--library-version">0.1.1.3</pre><a class="text--s" href="https://github.com/mt-security-kit/clj-security-protocols" id="top-bar--library-uri"><pre class="color--hard-blue">github.com/mt-security-kit/clj-security-protocols</pre></a></div><div id="bottom-bar"><a class="color--soft-purple text--s" href="https://github.com/mt-devtools/clj-source-code-documentation" id="bottom-bar--credits-link"><pre>github.com/mt-devtools/clj-source-code-documentation</pre></a></div></body></html></html>
