<!DOCTYPE html>
<html><html><head><style type="text/css">body{margin:12px 0 0 560px;padding:60px 48px}button{background-color:transparent;border:none;cursor:pointer;padding:0;user-select:none}button:hover{opacity:.5}div{box-sizing:border-box}pre{display:block;margin:0;letter-spacing:.8px}.scroll-x{overflow-x:auto}.scroll-y{flex-grow:1;overflow-y:auto}a,a:active,a:hover,a:visited{display:block;text-decoration:none}a.inline-link{display:inline-block}a.inline-link:hover{text-decoration:underline}.button{letter-spacing:.5px;white-space:inherit}.button:hover{background-color:#f0f0f0}.button--active{background-color:#f3f3f3}.button--active:hover{background-color:#f0f0f0}.text--xxs{font-size:10px;line-height:18px}.text--xs{font-size:11px;line-height:18px}.text--s{font-size:12px;line-height:18px}.text--m{font-size:13px;line-height:18px}.text--l{font-size:14px;line-height:18px}.text--xl{font-size:16px;line-height:24px}.text--xxl{font-size:18px;line-height:24px}.text--semi-bold{font-weight:500}.text--bold{font-weight:600}.text--uppercase{text-transform:uppercase}.text--boxed{background-color:#fafafa;padding:12px 8px}.text--hidden{display:none}.text--wrap{-white-space:normal;white-space:pre-wrap}.image--boxed{background-color:#fafafa;padding:12px 8px}.color--black{color:#000000}.color--hard-grey{color:#404040}.color--soft-grey{color:#808080}.color--hard-blue{color:#0088cc}.color--soft-blue{color:#55aabb}.color--hard-purple{color:#8800cc}.color--soft-purple{color:#aa55bb}.color--hard-red{color:#cc00aa}[data-collapsed="true"] .snippet--text{display:none}[data-collapsible="true"] .snippet--header::after{align-items:center;content:'▼';display:flex;font-size:8px;justify-content:center;height:18px;width:18px}[data-collapsible="true"][data-collapsed="false"] .snippet--header::after{content:'▲'}#top-bar{background-color:#ffffff;border-bottom:1px solid #e0e0e0;display:flex;gap:6px;height:60px;left:0;padding-left:18px;position:fixed;top:0;width:100%}#top-bar--library-uri{padding:21px 18px;position:absolute;right:0;top:0}#top-bar--library-uri:hover{background-color:#f0f0f0}#top-bar--library-name{padding:18px 0;text-transform:uppercase}#top-bar--library-version{margin-top:12px}#bottom-bar{background-color:white;border-top:1px solid #e0e0e0;bottom:0;display:flex;justify-content:right;position:fixed;right:0;width:calc(100% - 560px)}#bottom-bar--credits-link{padding:12px 18px}#bottom-bar--credits-link:hover{background-color:#f0f0f0}#primary-list{background-color:#fff;border-right:1px solid #e0e0e0;display:flex;flex-direction:column;height:calc(100vh - 60px);left:0;padding:12px 0;position:fixed;top:60px;width:280px}#secondary-list{background-color:#fff;border-right:1px solid #e0e0e0;display:flex;flex-direction:column;height:calc(100vh - 60px);left:280px;padding:12px 0;position:fixed;top:60px;width:280px}#primary-list,#secondary-list{z-index:9999}#primary-list .text--xs,#secondary-list .text--xs{padding-left:12px}.primary-list--container,.secondary-list--container{margin-bottom:12px}#primary-list .button,#secondary-list .button{padding:3px 12px}#primary-list .label,#secondary-list .label{padding:0 12px}.section{padding:72px 0}.section--header{border-bottom:1px solid #e0e0e0;padding-bottom:8px;margin-bottom:12px}.snippets{display:flex;flex-direction:column;gap:24px}.snippet--header{display:flex;gap:4px}.snippet--preview-image{border:1px solid #dedede;display:block;max-height:480px;max-width:640px;min-height:48px;min-width:64px}.snippet--text span{opacity:.65}</style><script type="text/javascript">function toggleCollapsible(collapsibleId){collapsible=document.getElementById(collapsibleId);if(collapsible.dataset.collapsed==='true'){collapsible.dataset.collapsed='false';}else{collapsible.dataset.collapsed='true';}}function toggleSidebar(sidebarId){sidebar=document.getElementById(sidebarId);if(sidebar.dataset.hidden==='true'){sidebar.dataset.hidden='false';}else{sidebar.dataset.hidden='true';}}</script><title>clj-security-protocols 0.1.0.8 documentation</title><link href="https://raw.githubusercontent.com/mt-server-kit/clj-security-protocols/release/mt-server-kit-logo.png" rel="icon" type="image/png"></head><body><div id="primary-list"><div class="scroll-y"><div class="primary-list--container"><pre class="label color--soft-grey text--xxs text--uppercase">Clojure namespaces</pre><a href="https://mt-server-kit.github.io/clj-security-protocols/clj/database-security-protocols/api.html"><pre class="button color--hard-blue text--m button--active">database-security-protocols.api</pre></a><a href="https://mt-server-kit.github.io/clj-security-protocols/clj/media-security-protocols/api.html"><pre class="button color--hard-blue text--m ">media-security-protocols.api</pre></a><a href="https://mt-server-kit.github.io/clj-security-protocols/clj/user-security-protocols/api.html"><pre class="button color--hard-blue text--m ">user-security-protocols.api</pre></a></div></div></div><div id="secondary-list"><div class="scroll-y"><div class="secondary-list--container"><pre class="label color--soft-grey text--xxs text--uppercase">Declarations</pre><a href="#get-data"><pre class="button color--hard-blue text--m">get-data</pre></a><a href="#remove-data"><pre class="button color--hard-blue text--m">remove-data</pre></a><a href="#store-data"><pre class="button color--hard-blue text--m">store-data</pre></a></div></div></div><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">Clojure namespace</pre><pre class="color--black text--xxl text--wrap text--bold">database-security-protocols.api</pre></div><div class="sections"></div><div class="sections"><div class="section" id="get-data"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">get-data</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q5b3ac48e-d11a-4f34-943d-216b001be68f"><button class="snippet--header" onClick="toggleCollapsible(&apos;q5b3ac48e-d11a-4f34-943d-216b001be68f&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn get-data
  ([request functions]
   (get-data request nil functions))

  ([request initial-data {:keys [additional-action-f
                                 additional-security-f
                                 client-rate-limit-exceeded-f
                                 data-valid-f
                                 get-data-f
                                 hide-sensitive-values-f
                                 parse-values-f
                                 permission-granted-f
                                 populate-data-f
                                 postpare-data-f
                                 prepare-data-f
                                 unparse-values-f
                                 user-rate-limit-exceeded-f]}]
   (let [ip-address (http/request-&gt;ip-address request)
         user-agent (http/request-&gt;user-agent request)]
        (cond (not (audit/ip-address-valid? ip-address))                                  {:body :invalid-request/invalid-ip-address             :status 400}
              (not (audit/user-agent-valid? user-agent))                                  {:body :invalid-request/invalid-user-agent             :status 400}
              (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded   :status 429}
              (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded     :status 429}
              (and permission-granted-f         (not (permission-granted-f)))             {:body :forbidden-request/permission-denied            :status 403}
              (and additional-security-f        (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed :status 520}
              (and additional-action-f          (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed   :status 520}
              :getting-data 
                            (letfn [(apply-cascade-f [f data] (if f (f  data) data))]
                                   (as-&gt; initial-data % (or (apply-cascade-f get-data-f              %) {:body :server-error/unable-to-get-data              :status 500})
                                                        (or (apply-cascade-f data-valid-f            %) {:body :server-error/unable-to-validate-data         :status 500})
                                                        (or (apply-cascade-f prepare-data-f          %) {:body :server-error/unable-to-prepare-data          :status 500})
                                                        (or (apply-cascade-f populate-data-f         %) {:body :server-error/unable-to-populate-data         :status 500})
                                                        (or (apply-cascade-f hide-sensitive-values-f %) {:body :server-error/unable-to-hide-sensitive-values :status 500})
                                                        (or (apply-cascade-f parse-values-f          %) {:body :server-error/unable-to-parse-values          :status 500})
                                                        (or (apply-cascade-f unparse-values-f        %) {:body :server-error/unable-to-unparse-values        :status 500})
                                                        (or (apply-cascade-f postpare-data-f         %) {:body :server-error/unable-to-postpare-data         :status 500})
                                                        {:body % :status 200}))))))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q712f987d-73c3-4f5c-954e-685b9abd5a9c"><div class="snippet--header"><pre class="text--uppercase color--hard-red text--xxs ">important</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">This function is not tested and may not behave as expected.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qabcd6448-07ae-4ef5-b35f-3df0958c37ca"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for getting data from database.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qd1c29425-08a6-4b25-b262-27c722655596"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).<br>- The data validating / manipulating functions are applied as a cascade where every function takes the data as it has returned from<br>  the previous function (except the first function that takes the initial data) and every function must return the validated / manipulated<br>  data in case of successful execution.<br>- The data validating / manipulating functions are applied in the following order:<br>  1. get-data-f<br>  2. data-valid-f<br>  3. prepare-data-f<br>  4. populate-data-f<br>  5. hide-sensitive-values-f<br>  6. parse-values-f<br>  7. unparse-values-f<br>  8. postpare-data-f</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qc7a55df5-cbfd-4425-97b3-8fda4de5af13"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(get-data {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q409a2e6a-9787-41de-b963-94a11d5dd0d9"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(get-data {...} {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qe9e8249e-b636-4f08-8d30-932fe8568154"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(get-data {...} {...} {...})<br>=&gt;<br>{:body {:my-data "..."} :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qc74f513b-20a6-4ed6-aae8-7e05f310a031"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address (-&gt; request :remote-addr)<br>        user-id    (-&gt; request :session :user-id)]<br>       (get-data request {:my-data "My initial data (optional)"}<br>                         {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address? ip-address)<br>                          :data-valid-f                 #(map? %)<br>                          :get-data-f                   #(my-database/get-data!             %)<br>                          :parse-values-f               #(my-utils/parse-timestamps-in-data %)<br>                          :populate-data-f              #(my-utils/add-user-related-values  %)<br>                          :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-user-id? user-id)})))<br>=&gt;<br>{:body {:my-data "..."} :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="q9399b7b5-dcc9-4bd9-b7cf-48a3ff32dd7d"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q8ad9e6b2-367d-4df4-97f8-e948aea26252"><button class="snippet--header" onClick="toggleCollapsible(&apos;q8ad9e6b2-367d-4df4-97f8-e948aea26252&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">*</pre><pre class="text--uppercase color--soft-grey text--xxs ">opt</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">initial-data</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">The 'initial-data' is passed through the data validating / manipulating functions (that are applied as a cascade).<br>Default: NIL</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qcfd15550-9691-4c91-a920-6a9037fc15b7"><button class="snippet--header" onClick="toggleCollapsible(&apos;qcfd15550-9691-4c91-a920-6a9037fc15b7&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :data-valid-f (function)(opt)                 Must return the data if it's valid.<br> :get-data-f (function)(opt)                   Must return the data if the execution was successful.<br> :hide-sensitive-values-f (function)(opt)      Must return the data if the execution was successful.<br> :parse-values-f (function)(opt)               Must return the data if the execution was successful.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :populate-data-f (function)(opt)              Must return the data if the execution was successful.<br> :postpare-data-f (function)(opt)              Must return the data if the execution was successful.<br> :prepare-data-f (function)(opt)               Must return the data if the execution was successful.<br> :unparse-values-f (function)(opt)             Must return the data if the execution was successful.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q808ff431-07e3-4fad-806d-f393aba059de"><button class="snippet--header" onClick="toggleCollapsible(&apos;q808ff431-07e3-4fad-806d-f393aba059de&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword or *)<br>  :forbidden-request/permission-denied            (The user has no permission to do the action)<br>  :invalid-request/invalid-ip-address             (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent             (No valid user agent has been found in the request)<br>  :too-many-requests/client-rate-limit-exceeded   (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded     (Too many actions have been attempted by the user in a specific timeframe)<br>  :unknown-error/additional-action-stage-failed   (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed (The additional security function returned a false value)<br>  :server-error/unable-to-get-data                (The 'get-data-f' function has been returned a false value)<br>  :server-error/unable-to-hide-sensitive-values   (The 'hide-sensitive-values-f' function has been returned a false value)<br>  :server-error/unable-to-parse-values            (The 'parse-values-f' function has been returned a false value)<br>  :server-error/unable-to-populate-data           (The 'populate-data-f' function has been returned a false value)<br>  :server-error/unable-to-postpare-data           (The 'postpare-data-f' function has been returned a false value)<br>  :server-error/unable-to-prepare-data            (The 'prepare-data-f' function has been returned a false value)<br>  :server-error/unable-to-unparse-values          (The 'unparse-values-f' function has been returned a false value)<br>  :server-error/unable-to-validate-data           (The 'data-valid-f' function has been returned a false value)<br> :status (integer)<br>  200, 400, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="store-data"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">store-data</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q92590138-ebaa-4088-93c3-53d5142a5002"><button class="snippet--header" onClick="toggleCollapsible(&apos;q92590138-ebaa-4088-93c3-53d5142a5002&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn store-data
  ([request functions]
   (store-data request nil functions))

  ([request initial-data {:keys [additional-action-f
                                 additional-security-f
                                 client-rate-limit-exceeded-f
                                 data-valid-f
                                 parse-values-f
                                 permission-granted-f
                                 postpare-data-f
                                 prepare-data-f
                                 remove-blank-values-f
                                 store-data-f
                                 unparse-values-f
                                 unpopulate-data-f
                                 user-rate-limit-exceeded-f]}]
   (let [ip-address (http/request-&gt;ip-address request)
         user-agent (http/request-&gt;user-agent request)]
        (cond (not (audit/ip-address-valid? ip-address))                                  {:body :invalid-request/invalid-ip-address             :status 400}
              (not (audit/user-agent-valid? user-agent))                                  {:body :invalid-request/invalid-user-agent             :status 400}
              (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded   :status 429}
              (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded     :status 429}
              (and permission-granted-f         (not (permission-granted-f)))             {:body :forbidden-request/permission-denied            :status 403}
              (and additional-security-f        (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed :status 520}
              (and additional-action-f          (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed   :status 520}
              :storing-data 
                            (letfn [(apply-cascade-f [f data] (if f (f  data) data))]
                                   (as-&gt; initial-data % (or (apply-cascade-f data-valid-f          %) {:body :server-error/unable-to-validate-data       :status 500})
                                                        (or (apply-cascade-f prepare-data-f        %) {:body :server-error/unable-to-prepare-data        :status 500})
                                                        (or (apply-cascade-f unpopulate-data-f     %) {:body :server-error/unable-to-unpopulate-data     :status 500})
                                                        (or (apply-cascade-f remove-blank-values-f %) {:body :server-error/unable-to-remove-blank-values :status 500})
                                                        (or (apply-cascade-f parse-values-f        %) {:body :server-error/unable-to-parse-values        :status 500})
                                                        (or (apply-cascade-f unparse-values-f      %) {:body :server-error/unable-to-unparse-values      :status 500})
                                                        (or (apply-cascade-f postpare-data-f       %) {:body :server-error/unable-to-postpare-data       :status 500})
                                                        (or (apply-cascade-f store-data-f          %) {:body :server-error/unable-to-store-data          :status 500})
                                                        {:body :performed-request/data-stored :status 200}))))))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q536f10e2-7da7-4292-9fcd-aea387911026"><div class="snippet--header"><pre class="text--uppercase color--hard-red text--xxs ">important</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">This function is not tested and may not behave as expected.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q7c371389-9a99-4486-a3cf-59a191c2b5a3"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for storing data in the database.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q87fcdbbc-7815-4d33-bb71-9a1116015b00"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).<br>- The data validating / manipulating functions are applied as a cascade where every function takes the data as it has returned from<br>  the previous function (except the first function that takes the initial data) and every function must return the validated / manipulated<br>  data in case of successful execution.<br>- The data validating / manipulating functions are applied in the following order:<br>  1. data-valid-f<br>  2. prepare-data-f<br>  3. unpopulate-data-f<br>  4. remove-blank-values-f<br>  5. parse-values-f<br>  6. unparse-values-f<br>  7. postpare-data-f<br>  8. store-data-f</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qef644c5c-2352-48d1-8ce1-79ed57668904"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(store-data {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q1ab4aca5-0fa6-457b-9d6b-71fe1f3c962f"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(store-data {...} {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q2e326b02-a8d3-48b6-8d80-9fc2a3e8cc5f"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(store-data {...} {...} {...})<br>=&gt;<br>{:body :performed-request/data-stored :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q6b626f57-8354-42bc-aaac-f6a0c16c6435"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address (-&gt; request :remote-addr)<br>        user-id    (-&gt; request :session :user-id)]<br>       (store-data request {:my-data "My initial data (optional)"}<br>                           {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address? ip-address)<br>                            :data-valid-f                 #(map? %)<br>                            :parse-values-f               #(my-utils/parse-timestamps-in-data   %)<br>                            :store-data-f                 #(my-database/store-data!             %)<br>                            :unpopulate-data-f            #(my-utils/remove-user-related-values %)<br>                            :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-user-id? user-id)})))<br>=&gt;<br>{:body :performed-request/data-stored :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="q021b1d89-1ffe-483b-925d-a50eec7e5f8a"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q08e7ed39-0603-4a38-bfa9-a4b530cf8da6"><button class="snippet--header" onClick="toggleCollapsible(&apos;q08e7ed39-0603-4a38-bfa9-a4b530cf8da6&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">*</pre><pre class="text--uppercase color--soft-grey text--xxs ">opt</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">initial-data</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">The 'initial-data' is passed through the data validating / manipulating functions (that are applied as a cascade).<br>Default: NIL</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q4067b47b-ced8-40b4-aebc-e6d0ee517077"><button class="snippet--header" onClick="toggleCollapsible(&apos;q4067b47b-ced8-40b4-aebc-e6d0ee517077&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :data-valid-f (function)(opt)                 Must return the data only if it's valid.<br> :parse-values-f (function)(opt)               Must return the data if the execution was successful.<br> :permission-granted-f (function)(opt)         Must return TRUE if the user has permission to do the action.<br> :postpare-data-f (function)(opt)              Must return the data if the execution was successful.<br> :prepare-data-f (function)(opt)               Must return the data if the execution was successful.<br> :remove-blank-values-f (function)(opt)        Must return the data if the execution was successful.<br> :store-data-f (function)(opt)                 Must return TRUE if the execution was successful.<br> :unparse-values-f (function)(opt)             Must return the data if the execution was successful.<br> :unpopulate-data-f (function)(opt)            Must return the data if the execution was successful.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="qb15b2d28-8f81-41b9-840e-6186689e3588"><button class="snippet--header" onClick="toggleCollapsible(&apos;qb15b2d28-8f81-41b9-840e-6186689e3588&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword)<br>  :forbidden-request/permission-denied            (The user has no permission to do the action)<br>  :invalid-request/invalid-ip-address             (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent             (No valid user agent has been found in the request)<br>  :performed-request/data-stored                  (The provided data has been successfully stored)<br>  :server-error/unable-to-parse-values            (The 'parse-values-f' function has been returned a false value)<br>  :server-error/unable-to-postpare-data           (The 'postpare-data-f' function has been returned a false value)<br>  :server-error/unable-to-prepare-data            (The 'prepare-data-f' function has been returned a false value)<br>  :server-error/unable-to-remove-blank-values     (The 'remove-blank-values-f' function has been returned a false value)<br>  :server-error/unable-to-store-data              (The 'store-data-f' function has been returned a false value)<br>  :server-error/unable-to-unparse-values          (The 'unparse-values-f' function has been returned a false value)<br>  :server-error/unable-to-unpopulate-data         (The 'unpopulate-data-f' function has been returned a false value)<br>  :server-error/unable-to-validate-data           (The 'data-valid-f' function has been returned a false value)<br>  :too-many-requests/client-rate-limit-exceeded   (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded     (Too many actions have been attempted by the user in a specific timeframe)<br>  :unknown-error/additional-action-stage-failed   (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 403, 429, 500, 520}</pre></div></div></div></div><div class="section" id="remove-data"><div class="section--header"><pre class="color--soft-grey text--xxs text--uppercase">defn</pre><pre class="color--hard-blue text--xxl text--bold">remove-data</pre></div><div class="snippets"><div class="snippet" data-collapsed="true" data-collapsible="true" id="q6393e230-90ba-4791-a176-9ae83324a5e8"><button class="snippet--header" onClick="toggleCollapsible(&apos;q6393e230-90ba-4791-a176-9ae83324a5e8&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">source-code</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn remove-data
  [request {:keys [additional-action-f
                   additional-security-f
                   client-rate-limit-exceeded-f
                   permission-granted-f
                   remove-data-f
                   user-rate-limit-exceeded-f]}]
  (let [ip-address (http/request-&gt;ip-address request)
        user-agent (http/request-&gt;user-agent request)]
       (cond (not (audit/ip-address-valid? ip-address))                                  {:body :invalid-request/invalid-ip-address             :status 400}
             (not (audit/user-agent-valid? user-agent))                                  {:body :invalid-request/invalid-user-agent             :status 400}
             (and client-rate-limit-exceeded-f (boolean (client-rate-limit-exceeded-f))) {:body :too-many-requests/client-rate-limit-exceeded   :status 429}
             (and user-rate-limit-exceeded-f   (boolean (user-rate-limit-exceeded-f)))   {:body :too-many-requests/user-rate-limit-exceeded     :status 429}
             (and permission-granted-f         (not (permission-granted-f)))             {:body :forbidden-request/permission-denied            :status 403}
             (and additional-security-f        (not (additional-security-f)))            {:body :unknown-error/additional-security-stage-failed :status 520}
             (and additional-action-f          (not (additional-action-f)))              {:body :unknown-error/additional-action-stage-failed   :status 520}
             (not (remove-data-f))                                                       {:body :server-error/unable-to-remove-data             :status 500}
             :data-removed                                                               {:body :performed-request/data-removed                 :status 200})))</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q61646084-36d6-4752-8c5a-f9793a828c5f"><div class="snippet--header"><pre class="text--uppercase color--hard-red text--xxs ">important</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">This function is not tested and may not behave as expected.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qa2c6cd88-943e-4847-b70a-06953afc7266"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">description</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- Security protocol function for removing data from database.<br>- Performs various security checks before returns a HTTP response that indicates if any check has been failed or the action was successful.</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q6cd7b65d-1624-490e-b603-a134a5dee403"><div class="snippet--header"><pre class="text--uppercase color--hard-blue text--xxs ">note</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">- For performing additional side effects use the 'additional-action-f' function (applied if no security check has been failed).<br>- For implementing additional security levels use the 'additional-security-f' function (applied as last security check).</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q887f72e7-b675-4c04-88ae-1f07d2a7f53e"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(remove-data {...} {...})</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="qff92245a-8cf0-4bca-9509-9caf9469922f"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(remove-data {...} {...})<br>=&gt;<br>{:body :performed-request/data-removed :status 200}</pre></div></div><div class="snippet" data-collapsed="false" data-collapsible="false" id="q08fd178a-b1ed-421f-8186-dd0d0cbe1823"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">usage</pre></div><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">(defn my-route<br>  [request]<br>  (let [ip-address (-&gt; request :remote-addr)<br>        user-id    (-&gt; request :session :user-id)]<br>       (remove-data request {:client-rate-limit-exceeded-f #(my-log-service/too-many-attempts-by-ip-address? ip-address)<br>                             :remove-data-f                #(my-database/remove-data!)<br>                             :user-rate-limit-exceeded-f   #(my-log-service/too-many-attempts-by-user-id? user-id)})))<br>=&gt;<br>{:body :performed-request/data-removed :status 200}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="false" id="q998c64c6-ebf9-4acf-b202-0f442598b1b0"><div class="snippet--header"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">request</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q369e88d9-e781-4217-bc10-a5c82e61f7c3"><button class="snippet--header" onClick="toggleCollapsible(&apos;q369e88d9-e781-4217-bc10-a5c82e61f7c3&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">param</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre><pre class="text--uppercase text--bold color--hard-grey text--xxs">functions</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:additional-action-f (function)(opt)          Must return TRUE in case of successful execution.<br> :additional-security-f (function)(opt)        Must return TRUE in case of no security concern detected.<br> :client-rate-limit-exceeded-f (function)(opt) Must return TRUE if the client device / IP address is involved in too many attempts in a specific timeframe.<br> :remove-data-f (function)                     Must return TRUE if the execution was successful.<br> :user-rate-limit-exceeded-f (function)(opt)   Must return TRUE if the user is involved in too many attempts in a specific timeframe.}</pre></div></div><div class="snippet" data-collapsed="true" data-collapsible="true" id="q6f79ba47-e412-4e4b-9d0d-ec16693c4583"><button class="snippet--header" onClick="toggleCollapsible(&apos;q6f79ba47-e412-4e4b-9d0d-ec16693c4583&apos;)"><pre class="text--uppercase color--soft-grey text--xxs ">return</pre><pre class="text--uppercase color--soft-grey text--xxs ">map</pre></button><div class="snippet--text"><pre class="text--boxed scroll-x color--hard-grey text--s">{:body (namespaced keyword)<br>  :forbidden-request/permission-denied            (The user has no permission to do the action)<br>  :invalid-request/invalid-ip-address             (No valid IP address has been found in the request)<br>  :invalid-request/invalid-user-agent             (No valid user agent has been found in the request)<br>  :performed-request/data-removed                 (The data has been successfully removed)<br>  :server-error/unable-to-remove-data             (The 'remove-data-f' function has been returned a false value)<br>  :too-many-requests/client-rate-limit-exceeded   (Too many actions have been attempted by the client device / IP address in a specific timeframe)<br>  :too-many-requests/user-rate-limit-exceeded     (Too many actions have been attempted by the user in a specific timeframe)<br>  :unknown-error/additional-action-stage-failed   (The additional action function returned a false value)<br>  :unknown-error/additional-security-stage-failed (The additional security function returned a false value)<br> :status (integer)<br>  200, 400, 403, 429, 500, 520}</pre></div></div></div></div></div><div id="top-bar"><pre class="text--xxl text--bold" id="top-bar--library-name">clj-security-protocols</pre><pre class="color--soft-grey text--s" id="top-bar--library-version">0.1.0.8</pre><a class="text--s" href="https://github.com/mt-server-kit/clj-security-protocols" id="top-bar--library-uri"><pre class="color--hard-blue">github.com/mt-server-kit/clj-security-protocols</pre></a></div><div id="bottom-bar"><a class="color--soft-purple text--s" href="https://github.com/mt-devtools/clj-source-code-documentation" id="bottom-bar--credits-link"><pre>github.com/mt-devtools/clj-source-code-documentation</pre></a></div></body></html></html>
